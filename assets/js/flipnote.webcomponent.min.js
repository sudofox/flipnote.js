/*!!
flipnote.js v5.6.7 (webcomponent build)
https://flipnote.js.org
A JavaScript library for parsing, converting, and in-browser playback of the proprietary animation formats used by Nintendo's Flipnote Studio and Flipnote Studio 3D apps.
2018 - 2021 James Daniel
Flipnote Studio is (c) Nintendo Co., Ltd. This project isn't affiliated with or endorsed by them in any way.
Keep on Flipnoting!
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).flipnote={})}(this,(function(t){"use strict";class e{constructor(){this.pageSize=4096,this.allocSize=0,this.realSize=0,this.pages=[],this.numPages=0,this.pageIdx=0,this.pagePtr=0,this.realPtr=0,this.newPage()}set pointer(t){this.setPointer(t)}get pointer(){return this.realPtr}newPage(){this.pages[this.numPages]=new Uint8Array(this.pageSize),this.numPages=this.pages.length,this.allocSize=this.numPages*this.pageSize}setPointer(t){for(;t>=this.allocSize;)this.newPage();t>this.realSize&&(this.realSize=t),this.pageIdx=Math.floor(t/this.pageSize),this.pagePtr=t%this.pageSize,this.realPtr=t}writeByte(t){this.pages[this.pageIdx][this.pagePtr]=t,this.setPointer(this.realPtr+1)}writeBytes(t,e,i){for(let s=i||t.length,r=e||0;r<s;r++)this.writeByte(t[r])}writeChars(t){for(let e=0;e<t.length;e++)this.writeByte(t.charCodeAt(e))}writeU8(t){this.writeByte(255&t)}writeU16(t){this.writeByte(t>>>0&255),this.writeByte(t>>>8&255)}writeU32(t){this.writeByte(t>>>0&255),this.writeByte(t>>>8&255),this.writeByte(t>>>16&255),this.writeByte(t>>>24&255)}getBytes(){const t=new Uint8Array(this.realSize),e=this.numPages;for(let i=0;i<e;i++){const s=this.pages[i];i===e-1?t.set(s.slice(0,this.realSize%this.pageSize),i*this.pageSize):t.set(s,i*this.pageSize)}return t}getBuffer(){return this.getBytes().buffer}}class i{constructor(t){this.buffer=t,this.data=new DataView(t),this.pointer=0}get bytes(){return new Uint8Array(this.buffer)}get byteLength(){return this.data.byteLength}seek(t,e){switch(e){case 2:this.pointer=this.data.byteLength+t;break;case 1:this.pointer+=t;break;case 0:default:this.pointer=t}}readUint8(){const t=this.data.getUint8(this.pointer);return this.pointer+=1,t}writeUint8(t){this.data.setUint8(this.pointer,t),this.pointer+=1}readInt8(){const t=this.data.getInt8(this.pointer);return this.pointer+=1,t}writeInt8(t){this.data.setInt8(this.pointer,t),this.pointer+=1}readUint16(t=!0){const e=this.data.getUint16(this.pointer,t);return this.pointer+=2,e}writeUint16(t,e=!0){this.data.setUint16(this.pointer,t,e),this.pointer+=2}readInt16(t=!0){const e=this.data.getInt16(this.pointer,t);return this.pointer+=2,e}writeInt16(t,e=!0){this.data.setInt16(this.pointer,t,e),this.pointer+=2}readUint32(t=!0){const e=this.data.getUint32(this.pointer,t);return this.pointer+=4,e}writeUint32(t,e=!0){this.data.setUint32(this.pointer,t,e),this.pointer+=4}readInt32(t=!0){const e=this.data.getInt32(this.pointer,t);return this.pointer+=4,e}writeInt32(t,e=!0){this.data.setInt32(this.pointer,t,e),this.pointer+=4}readBytes(t){const e=new Uint8Array(this.data.buffer,this.pointer,t);return this.pointer+=e.byteLength,e}writeBytes(t){t.forEach(t=>this.writeUint8(t))}readHex(t,e=!1){const i=this.readBytes(t);let s=[];for(let t=0;t<i.length;t++)s.push(i[t].toString(16).padStart(2,"0"));return e&&s.reverse(),s.join("").toUpperCase()}readChars(t){const e=this.readBytes(t);let i="";for(let t=0;t<e.length;t++){const s=e[t];if(0===s)break;i+=String.fromCharCode(s)}return i}writeChars(t){for(let e=0;e<t.length;e++){const i=t.charCodeAt(e);this.writeUint8(i)}}readWideChars(t){const e=new Uint16Array(this.data.buffer,this.pointer,t);let i="";for(let t=0;t<e.length;t++){const s=e[t];if(0==s)break;i+=String.fromCharCode(s)}return this.pointer+=e.byteLength,i}}const s=new Int8Array([-1,2,-1,2]),r=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),n=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]);function a(t,e,i){return t<e?e:t>i?i:t}function o(t,e,i){return i<0||i>=e?0:t[i]}function h(t){const e=t.length;let i=0;for(let s=0;s<e;s++){const e=t[s];(e<=-32768||e>=32767)&&(i+=1)}return i/e}function l(t){const e=t.length;let i=0;for(let s=0;s<e;s++)i+=Math.pow(t[s],2);return Math.sqrt(i/e)}function c(t,e="Assert failed"){if(!t)throw console.trace(e),new Error(e)}function d(t,e,i,s=""){c(t>=e&&t<=i,`${s||"value"} ${t} should be between ${e} and ${i}`)}function u(t,e){try{return t.require(e)}catch(t){throw new Error(`Could not require(${e})`)}}function f(){return g?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{}}const p="undefined"!=typeof window&&void 0!==window.document;function m(){return c(p,"This feature is only available in browser environments")}const g="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node;function y(){return c(g,"This feature is only available in NodeJS environments")}const v="object"==typeof self&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name,b=p&&(window.requestAnimationFrame||window.webkitRequestAnimationFrame);const S=(()=>{if(p||v){const t=f();return(t.crypto||t.msCrypto).subtle}if(g)return u(module,"crypto").webcrypto.subtle})();async function w(t,e){const i=t.split("\n").filter(t=>!t.startsWith("-----")&&!t.endsWith("-----")).join(""),s=atob(i),r=new Uint8Array(s.length).map((t,e)=>s.charCodeAt(e));return await S.importKey("spki",r.buffer,{name:"RSASSA-PKCS1-v1_5",hash:e},!1,["verify"])}async function _(t,e,i){return await S.verify("RSASSA-PKCS1-v1_5",t,e,i)}function E(t){return new Date(1e3*(t+946684800))}function x(t,e){return 100*t*(1/e)/100}var P;t.FlipnoteRegion=void 0,(P=t.FlipnoteRegion||(t.FlipnoteRegion={})).EUR="EUR",P.USA="USA",P.JPN="JPN",P.UNKNOWN="UNKNOWN";const A=/^[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}$/,F=/^[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{6}$/,C=/^(00|10|12|14)[0-9a-f]{2}-[0-9a-f]{4}-[0-9a-f]{3}0-[0-9a-f]{4}[0159]{1}[0-9a-f]{1}$/;function T(t){return"14E494E35A443235"===t||A.test(t)}function k(t){return F.test(t)}function U(t){return t.endsWith("3532445AE394E414")||C.test(t)}function B(e){switch(e.charAt(0)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}}function L(e){if(U(e))switch(e.charAt(19)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}switch(e.slice(0,2)){case"00":return t.FlipnoteRegion.JPN;case"02":return t.FlipnoteRegion.USA;case"04":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}}var I,N,M,R=Object.freeze({__proto__:null,get FlipnoteRegion(){return t.FlipnoteRegion},isPpmFsid:T,isKwzFsid:k,isKwzDsiLibraryFsid:U,isFsid:function(t){return T(t)||k(t)},getPpmFsidRegion:B,getKwzFsidRegion:L,getFsidRegion:function(e){return T(e)?B(e):k(e)?L(e):t.FlipnoteRegion.UNKNOWN}});!function(){if(!p)return function(){};var t=document.createElement("a")}(),t.FlipnoteFormat=void 0,(I=t.FlipnoteFormat||(t.FlipnoteFormat={})).PPM="PPM",I.KWZ="KWZ",t.FlipnoteAudioTrack=void 0,(N=t.FlipnoteAudioTrack||(t.FlipnoteAudioTrack={}))[N.BGM=0]="BGM",N[N.SE1=1]="SE1",N[N.SE2=2]="SE2",N[N.SE3=3]="SE3",N[N.SE4=4]="SE4",t.FlipnoteSoundEffectTrack=void 0,(M=t.FlipnoteSoundEffectTrack||(t.FlipnoteSoundEffectTrack={}))[M.SE1=1]="SE1",M[M.SE2=2]="SE2",M[M.SE3=3]="SE3",M[M.SE4=4]="SE4";class z extends i{constructor(){super(...arguments),this[Symbol.toStringTag]="Flipnote",this.titleFormats={COMMENT:"Comment by $USERNAME",FLIPNOTE:"Flipnote by $USERNAME",ICON:"Folder icon"},this.soundMeta=new Map,this.layerVisibility={1:!0,2:!0,3:!0},this.isFolderIcon=!1,this.isComment=!1,this.isDsiLibraryNote=!1}getTitle(t=this.titleFormats){if(this.isFolderIcon)return t.ICON;return(this.isComment?t.COMMENT:t.FLIPNOTE).replace("$USERNAME",this.meta.current.username)}toString(){return this.getTitle()}*[Symbol.iterator](){for(let t=0;t<this.frameCount;t++)yield t}getLayerPixels(t,e,i=new Uint8Array(this.imageWidth*this.imageHeight)){d(t,0,this.frameCount-1,"Frame index"),d(e,0,this.numLayers-1,"Layer index");const s=this.getFramePaletteIndices(t),r=e*this.numLayerColors,n=this.decodeFrame(t)[e],a=this.srcWidth,o=this.imageWidth,h=this.imageHeight,l=this.imageOffsetX,c=this.imageOffsetY;if(i.fill(0),!this.layerVisibility[e+1])return i;for(let t=c,e=0;e<h;t++,e++)for(let h=l,c=0;c<o;h++,c++){const l=e*o+c;let d=n[t*a+h];0!==d&&(i[l]=s[r+d])}return i}getLayerPixelsRgba(t,e,i=new Uint32Array(this.imageWidth*this.imageHeight),s=new Uint32Array(16)){d(t,0,this.frameCount-1,"Frame index"),d(e,0,this.numLayers-1,"Layer index"),this.getFramePaletteUint32(t,s);const r=e*this.numLayerColors,n=this.decodeFrame(t)[e],a=this.srcWidth,o=this.imageWidth,h=this.imageHeight,l=this.imageOffsetX,c=this.imageOffsetY;if(i.fill(s[0]),!this.layerVisibility[e+1])return i;for(let t=c,e=0;e<h;t++,e++)for(let h=l,c=0;c<o;h++,c++){const l=e*o+c;let d=n[t*a+h];0!==d&&(i[l]=s[r+d])}return i}getFramePixels(t,e=new Uint8Array(this.imageWidth*this.imageHeight)){const i=this.srcWidth,s=this.imageWidth,r=this.imageHeight,n=this.imageOffsetX,a=this.imageOffsetY,o=this.getFramePaletteIndices(t);e.fill(o[0]);const h=this.getFrameLayerOrder(t),l=this.decodeFrame(t);for(let t=0;t<this.numLayers;t++){const c=h[t],d=l[c],u=c*this.numLayerColors;if(this.layerVisibility[c+1])for(let t=a,h=0;h<r;t++,h++)for(let r=n,a=0;a<s;r++,a++){const n=h*s+a;let l=d[t*i+r];0!==l&&(e[n]=o[u+l])}}return e}getFramePixelsRgba(t,e=new Uint32Array(this.imageWidth*this.imageHeight),i=new Uint32Array(16)){d(t,0,this.frameCount-1,"Frame index");const s=this.srcWidth,r=this.imageWidth,n=this.imageHeight,a=this.imageOffsetX,o=this.imageOffsetY;this.getFramePaletteUint32(t,i),e.fill(i[0]);const h=this.getFrameLayerOrder(t),l=this.decodeFrame(t);for(let t=0;t<this.numLayers;t++){const c=h[t],d=l[c],u=c*this.numLayerColors;if(this.layerVisibility[c+1])for(let t=o,h=0;h<n;t++,h++)for(let n=a,o=0;o<r;n++,o++){const a=h*r+o;let l=d[t*s+n];0!==l&&(e[a]=i[u+l])}}return e}getFramePaletteUint32(t,e=new Uint32Array(16)){d(t,0,this.frameCount-1,"Frame index");const i=this.getFramePalette(t);return e.fill(0),i.forEach(([t,i,s,r],n)=>e[n]=r<<24|s<<16|i<<8|t),e}getSoundEffectFlagsForTrack(t){return this.getSoundEffectFlags().map(e=>e[t])}isSoundEffectUsedOnFrame(t,e){return d(e,0,this.frameCount-1,"Frame index"),!!this.soundEffectTracks.includes(t)&&this.getFrameSoundEffectFlags(e)[t]}hasAudioTrack(t){return this.soundMeta.has(t)&&this.soundMeta.get(t).length>0}}const O=[.5,.5,1,2,4,6,12,20,30],D={WHITE:[255,255,255,255],BLACK:[14,14,14,255],RED:[255,42,42,255],BLUE:[10,57,255,255]},W="-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCPLwTL6oSflv+gjywi/sM0TUB\n90xqOvuCpjduETjPoN2FwMebxNjdKIqHUyDu4AvrQ6BDJc6gKUbZ1E27BGZoCPH4\n9zQRb+zAM6M9EjHwQ6BABr0u2TcF7xGg2uQ9MBWz9AfbVQ91NjfrNWo0f7UPmffv\n1VvixmTk1BCtavZxBwIDAQAB\n-----END PUBLIC KEY-----";class V extends z{constructor(e,i={}){super(e),this.format=t.FlipnoteFormat.PPM,this[Symbol.toStringTag]="Flipnote Studio PPM animation file",this.imageWidth=V.width,this.imageHeight=V.height,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=V.numLayers,this.numLayerColors=V.numLayerColors,this.publicKey=V.publicKey,this.srcWidth=V.width,this.audioTracks=V.audioTracks,this.soundEffectTracks=V.soundEffectTracks,this.rawSampleRate=V.rawSampleRate,this.sampleRate=V.sampleRate,this.globalPalette=V.globalPalette,this.prevDecodedFrame=null,this.decodeHeader(),this.decodeAnimationHeader(),this.decodeSoundHeader(),0!=(this.version>>4&15)&&this.decodeMeta(),this.layerBuffers=[new Uint8Array(V.width*V.height),new Uint8Array(V.width*V.height)],this.prevLayerBuffers=[new Uint8Array(V.width*V.height),new Uint8Array(V.width*V.height)],this.lineEncodingBuffers=[new Uint8Array(V.height),new Uint8Array(V.height)],this.prevDecodedFrame=null}decodeHeader(){c(16<this.byteLength),this.seek(4),this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16();let t=1696+this.frameDataLength+this.frameCount;t%4!=0&&(t+=4-t%4),c(t<this.byteLength),this.soundDataOffset=t}readFilename(){return`${this.readHex(3)}_${this.readChars(13)}_${this.readUint16().toString().padStart(3,"0")}`}decodeMeta(){c(1704<this.byteLength),this.seek(16);const t=this.readUint16(),e=this.readInt16(),i=this.readWideChars(11),s=this.readWideChars(11),r=this.readWideChars(11),n=this.readHex(8,!0),a=this.readHex(8,!0),o=this.readFilename(),h=this.readFilename(),l=this.readHex(8,!0);this.seek(154);const d=E(this.readInt32());this.seek(1702);const u=this.readUint16();this.thumbFrameIndex=e,this.layerVisibility={1:0==(16&u),2:0==(32&u),3:!1},this.isSpinoff=a!==n||a!==l,this.meta={lock:1===t,loop:1==(u>>1&1),isSpinoff:this.isSpinoff,frameCount:this.frameCount,frameSpeed:this.frameSpeed,bgmSpeed:this.bgmSpeed,duration:this.duration,thumbIndex:e,timestamp:d,root:{username:i,fsid:l,region:B(l),filename:null},parent:{username:s,fsid:n,region:B(n),filename:o},current:{username:r,fsid:a,region:B(a),filename:h}}}decodeAnimationHeader(){this.seek(1696);const t=this.readUint16(),e=t/4;c(e<=this.frameCount),this.seek(1704);const i=new Uint32Array(e);for(let s=0;s<e;s++){const e=1704+t+this.readUint32();c(e<this.byteLength,`Frame ${s} pointer is out of bounds`),i[s]=e}this.frameOffsets=i}decodeSoundHeader(){let e=this.soundDataOffset;this.seek(e);const i=this.readUint32(),s=this.readUint32(),r=this.readUint32(),n=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),c(this.frameSpeed<=8&&this.bgmSpeed<=8),e+=32,this.framerate=O[this.frameSpeed],this.duration=x(this.frameCount,this.framerate),this.bgmrate=O[this.bgmSpeed];const a=new Map;a.set(t.FlipnoteAudioTrack.BGM,{ptr:e,length:i}),a.set(t.FlipnoteAudioTrack.SE1,{ptr:e+=i,length:s}),a.set(t.FlipnoteAudioTrack.SE2,{ptr:e+=s,length:r}),a.set(t.FlipnoteAudioTrack.SE3,{ptr:e+=r,length:n}),this.soundMeta=a}isKeyFrame(t){d(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameOffsets[t]);return this.readUint8()>>7&1}decodeFrame(t){if(d(t,0,this.frameCount-1,"Frame index"),this.prevDecodedFrame===t)return this.layerBuffers;this.prevDecodedFrame===t-1||this.isKeyFrame(t)||0===t||this.decodeFrame(t-1),this.prevDecodedFrame=t,this.seek(this.frameOffsets[t]);const e=this.readUint8(),i=e>>7&1,s=e>>5&3;this.layerBuffers[0].fill(0),this.layerBuffers[1].fill(0);let r=0,n=0;s&&(r=this.readInt8(),n=this.readInt8());for(let t=0;t<2;t++){const e=this.lineEncodingBuffers[t];e.fill(0);for(let t=0;t<e.length;){let i=this.readUint8();0!==i?(e[t++]=3&i,e[t++]=i>>2&3,e[t++]=i>>4&3,e[t++]=i>>6&3):t+=4}}for(let t=0;t<2;t++){const e=this.layerBuffers[t],i=this.lineEncodingBuffers[t];for(let t=0;t<V.height;t++){let s=t*V.width;switch(i[t]){case 0:break;case 1:for(var a=this.readUint32(!1);0!==a;a<<=1,s+=8)if(2147483648&a){let t=this.readUint8();for(let i=0;0!==t;i++,t>>=1)e[s+i]=1&t}break;case 2:e.fill(1,s,s+V.width);for(a=this.readUint32(!1);0!==a;a<<=1,s+=8)if(2147483648&a){let t=this.readUint8();for(let i=0;i<8;i++,t>>=1)e[s+i]=1&t}break;case 3:for(let t=0,i=0;i<V.width;i++)i%8==0&&(t=this.readUint8()),e[s++]=1&t,t>>=1}}}const o=this.layerBuffers[0],h=this.layerBuffers[1],l=this.prevLayerBuffers[0],c=this.prevLayerBuffers[1];if(i||0!==r||0!==n){if(!i){const t=V.width,e=V.height,i=Math.max(r,0),s=Math.max(n,0),a=Math.min(t+r,t),d=Math.min(e+n,e),u=n*t+r;let f,p;for(let e=s;e<d;e++)for(let s=i;s<a;s++)f=e*t+s,p=f-u,o[f]^=l[p],h[f]^=c[p]}}else{const t=V.height*V.width;for(let e=0;e<t;e++)o[e]^=l[e],h[e]^=c[e]}return this.prevLayerBuffers[0].set(this.layerBuffers[0]),this.prevLayerBuffers[1].set(this.layerBuffers[1]),this.layerBuffers}getFrameLayerOrder(t){return d(t,0,this.frameCount-1,"Frame index"),[1,0]}getFramePaletteIndices(t){d(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameOffsets[t]);const e=this.readUint8(),i=1!=(1&e),s=[i?0:1,i?0:1,2,3];return[i?1:0,s[e>>1&3],s[e>>3&3]]}getFramePalette(t){d(t,0,this.frameCount-1,"Frame index");return this.getFramePaletteIndices(t).map(t=>this.globalPalette[t])}decodeSoundFlags(){if(void 0!==this.soundFlags)return this.soundFlags;c(1696+this.frameDataLength<this.byteLength),this.seek(1696+this.frameDataLength);const t=this.frameCount,e=this.readBytes(t);this.soundFlags=new Array(t);for(let i=0;i<t;i++){const t=e[i];this.soundFlags[i]=[0!=(1&t),0!=(2&t),0!=(4&t)]}return this.soundFlags}getSoundEffectFlags(){return this.decodeSoundFlags().map(e=>({[t.FlipnoteSoundEffectTrack.SE1]:e[0],[t.FlipnoteSoundEffectTrack.SE2]:e[1],[t.FlipnoteSoundEffectTrack.SE3]:e[2]}))}getFrameSoundEffectFlags(e){d(e,0,this.frameCount-1,"Frame index"),this.seek(1696+this.frameDataLength+e);const i=this.readUint8();return{[t.FlipnoteSoundEffectTrack.SE1]:0!=(1&i),[t.FlipnoteSoundEffectTrack.SE2]:0!=(2&i),[t.FlipnoteSoundEffectTrack.SE3]:0!=(4&i)}}getAudioTrackRaw(t){const e=this.soundMeta.get(t);return c(e.ptr+e.length<this.byteLength),this.seek(e.ptr),this.readBytes(e.length)}decodeAudioTrack(t){const e=this.getAudioTrackRaw(t),i=e.length,s=new Int16Array(2*i);let o=0,h=0,l=0,c=0,d=0,u=!0;for(;o<i;){l=u?15&e[o]:e[o++]>>4,u=!u;const t=n[c];let i=t>>3;1&l&&(i+=t>>2),2&l&&(i+=t>>1),4&l&&(i+=t),8&l&&(i=-i),d+=i,d=a(d,-32768,32767),c+=r[l],c=a(c,0,88),s[h++]=d}return s}getAudioTrackPcm(e,i=this.sampleRate){const s=this.decodeAudioTrack(e);let r=this.rawSampleRate;if(e===t.FlipnoteAudioTrack.BGM){const t=1/this.bgmrate/(1/this.framerate);r=this.rawSampleRate*t}return r!==i?function(t,e,i){const s=t.length,r=s/e*i,n=new Int16Array(r),a=e/i;for(let e=0;e<r;e++)n[e]=o(t,s,Math.floor(e*a));return n}(s,r,i):s}pcmAudioMix(t,e,i=0){const s=t.length,r=e.length;for(let n=0;n<s&&!(i+n>r);n++){const s=e[i+n]+t[n]/2;e[i+n]=a(s,-32768,32767)}}getAudioMasterPcm(e=this.sampleRate){const i=Math.ceil(this.duration*e),s=new Int16Array(i),r=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),n=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3);if(r){const i=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,e);this.pcmAudioMix(i,s,0)}if(n||a||o){const i=e/this.framerate,r=n?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,e):null,h=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,e):null,l=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,e):null,c=this.decodeSoundFlags();for(let t=0;t<this.frameCount;t++){const e=Math.ceil(t*i),d=c[t];n&&d[0]&&this.pcmAudioMix(r,s,e),a&&d[1]&&this.pcmAudioMix(h,s,e),o&&d[2]&&this.pcmAudioMix(l,s,e)}}return this.audioClipRatio=h(s),s}getBody(){const t=this.soundDataOffset+this.soundDataLength+32;return this.bytes.subarray(0,t)}getSignature(){const t=this.soundDataOffset+this.soundDataLength+32;return this.bytes.subarray(t,t+128)}async verify(){const t=await w(W,"SHA-1");return await _(t,this.getSignature(),this.getBody())}}V.defaultSettings={},V.format=t.FlipnoteFormat.PPM,V.width=256,V.height=192,V.numLayers=2,V.numLayerColors=1,V.rawSampleRate=8192,V.sampleRate=32768,V.audioTracks=[t.FlipnoteAudioTrack.BGM,t.FlipnoteAudioTrack.SE1,t.FlipnoteAudioTrack.SE2,t.FlipnoteAudioTrack.SE3],V.soundEffectTracks=[t.FlipnoteSoundEffectTrack.SE1,t.FlipnoteSoundEffectTrack.SE2,t.FlipnoteSoundEffectTrack.SE3],V.globalPalette=[D.WHITE,D.BLACK,D.RED,D.BLUE],V.publicKey=W;const H=[.2,.5,1,2,4,6,8,12,20,24,30],$={WHITE:[255,255,255,255],BLACK:[16,16,16,255],RED:[255,16,16,255],YELLOW:[255,231,0,255],GREEN:[0,134,49,255],BLUE:[0,56,206,255],NONE:[255,255,255,0]},j="-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuv+zHAXXvbbtRqxADDeJ\nArX2b9RMxj3T+qpRg3FnIE/jeU3tj7eoDzsMduY+D/UT9CSnP+QHYY/vf0n5lqX9\ns6ljoZAmyUuruyj1e5Bg+fkDEu/yPEPQjqhbyywCyYL4TEAOJveopUBx9fdQxUJ6\nJ4J5oCE/Im1kFrlGW+puARiHmt3mmUyNzO8bI/Jx3cGSfoOHJG1foEaQsI5aaKqA\npBqxtzvwqMhudcZtAWSyRMBMlndvkRnVTDNTfTXLOYdHShCIgnKULCTH87uLBIP/\nnsmr4/bnQz8q2rp/HyVO+0yjR6mVr0NX5APJQ+6riJmGg3t3VOldhKP7aTHDUW+h\nkQIDAQAB\n-----END PUBLIC KEY-----",q=new Uint16Array(16);for(let t=0;t<16;t++)q[t]=(1<<t)-1;const K=new Uint8Array(52488),G=new Uint8Array(52488);var X=0;for(let t=0;t<3;t++)for(let e=0;e<3;e++)for(let i=0;i<3;i++)for(let s=0;s<3;s++)for(let r=0;r<3;r++)for(let n=0;n<3;n++)for(let a=0;a<3;a++)for(let o=0;o<3;o++)K.set([e,t,s,i,n,r,o,a],X),G.set([t,s,i,n,r,o,a,e],X),X+=8;const Y=new Uint8Array(256),Q=new Uint8Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach((t,e)=>{const i=8*t,s=K.subarray(i,i+8),r=G.subarray(i,i+8);Y.set(s,8*e),Q.set(r,8*e)});class J extends z{constructor(e,i={}){super(e),this.format=t.FlipnoteFormat.KWZ,this[Symbol.toStringTag]="Flipnote Studio 3D KWZ animation file",this.imageWidth=J.width,this.imageHeight=J.height,this.imageOffsetX=0,this.imageOffsetY=0,this.numLayers=J.numLayers,this.numLayerColors=J.numLayerColors,this.publicKey=J.publicKey,this.srcWidth=J.width,this.audioTracks=J.audioTracks,this.soundEffectTracks=J.soundEffectTracks,this.rawSampleRate=J.rawSampleRate,this.sampleRate=J.sampleRate,this.globalPalette=J.globalPalette,this.prevDecodedFrame=null,this.bitIndex=0,this.bitValue=0,this.settings=Object.assign(Object.assign({},J.defaultSettings),i),this.layerBuffers=[new Uint8Array(J.width*J.height),new Uint8Array(J.width*J.height),new Uint8Array(J.width*J.height)],this.buildSectionMap(),this.sectionMap.has("KIC")?(this.isFolderIcon=!0,this.imageWidth=24,this.imageHeight=24,this.frameCount=1,this.frameSpeed=0,this.framerate=H[0],this.thumbFrameIndex=0,this.getFrameOffsets()):this.sectionMap.has("KSN")?(this.decodeMeta(),this.getFrameOffsets(),this.decodeSoundHeader()):(this.isComment=!0,this.decodeMeta(),this.getFrameOffsets()),this.settings.dsiLibraryNote&&(this.isDsiLibraryNote=!0),this.settings.borderCrop&&(this.isDsiLibraryNote?(this.imageOffsetX=32,this.imageOffsetY=24,this.imageWidth=256,this.imageHeight=192):this.isFolderIcon||(this.imageOffsetX=5,this.imageOffsetY=5,this.imageWidth=310,this.imageHeight=230))}buildSectionMap(){const t=this.byteLength-256,e=new Map;let i=0,s=0;for(;s<t&&i<6;){this.seek(s);const t=this.readChars(4).substring(0,3),r=this.readUint32();e.set(t,{ptr:s,length:r}),s+=r+8,i+=1}this.bodyEndOffset=s,this.sectionMap=e,c(e.has("KMC")&&e.has("KMI"))}readBits(t){if(this.bitIndex+t>16){const t=this.readUint16();this.bitValue|=t<<16-this.bitIndex,this.bitIndex-=16}const e=this.bitValue&q[t];return this.bitValue>>=t,this.bitIndex+=t,e}readFsid(){if(this.settings.dsiLibraryNote){return this.readHex(10,!0).slice(2,18)}const t=this.readHex(10);return`${t.slice(0,4)}-${t.slice(4,8)}-${t.slice(8,12)}-${t.slice(12,18)}`.toLowerCase()}readFilename(){const t=this.pointer,e=this.readChars(28);if(28===e.length)return e;this.seek(t);const i=this.readHex(3),s=this.readChars(13),r=this.readUint16().toString().padStart(3,"0");return this.seek(t+28),`${i}_${s}_${r}`}decodeMeta(){if(this.settings.quickMeta)return this.decodeMetaQuick();c(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+12);const t=E(this.readUint32()),e=E(this.readUint32());this.readUint32();const i=this.readFsid(),s=this.readFsid(),r=this.readFsid(),n=this.readWideChars(11),a=this.readWideChars(11),o=this.readWideChars(11),h=this.readFilename(),l=this.readFilename(),d=this.readFilename(),u=this.readUint16(),f=this.readUint16(),p=this.readUint16(),m=this.readUint8(),g=this.readUint8();this.isSpinoff=r!==s||r!==i,this.frameCount=u,this.frameSpeed=m,this.framerate=H[m],this.duration=x(this.frameCount,this.framerate),this.thumbFrameIndex=f,this.layerVisibility={1:0==(1&g),2:0==(2&g),3:0==(3&g)},this.meta={lock:0!=(1&p),loop:0!=(2&p),isSpinoff:this.isSpinoff,frameCount:u,frameSpeed:m,duration:this.duration,thumbIndex:f,timestamp:e,creationTimestamp:t,root:{username:n,fsid:i,region:L(i),filename:h,isDsiFilename:28!==h.length},parent:{username:a,fsid:s,region:L(s),filename:l,isDsiFilename:28!==l.length},current:{username:o,fsid:r,region:L(r),filename:d,isDsiFilename:28!==d.length}}}decodeMetaQuick(){c(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+8+196);const t=this.readUint16(),e=this.readUint16();this.readUint16();const i=this.readUint8(),s=this.readUint8();this.frameCount=t,this.thumbFrameIndex=e,this.frameSpeed=i,this.framerate=H[i],this.duration=x(this.frameCount,this.framerate),this.layerVisibility={1:0==(1&s),2:0==(2&s),3:0==(3&s)}}getFrameOffsets(){c(this.sectionMap.has("KMI")&&this.sectionMap.has("KMC"));const t=this.frameCount,e=this.sectionMap.get("KMI"),i=this.sectionMap.get("KMC");c(e.length/28>=t);const s=new Uint32Array(t),r=new Uint32Array(t),n=[];let a=e.ptr+8,o=i.ptr+12;for(let e=0;e<t;e++){this.seek(a+4);const t=this.readUint16(),i=this.readUint16(),h=this.readUint16();s[e]=a,r[e]=o,a+=28,o+=t+i+h,c(a<this.byteLength,`frame${e} meta pointer out of bounds`),c(o<this.byteLength,`frame${e} data pointer out of bounds`),n.push([t,i,h])}this.frameMetaOffsets=s,this.frameDataOffsets=r,this.frameLayerSizes=n}decodeSoundHeader(){c(this.sectionMap.has("KSN"));let e=this.sectionMap.get("KSN").ptr+8;this.seek(e),this.bgmSpeed=this.readUint32(),c(this.bgmSpeed<=10),this.bgmrate=H[this.bgmSpeed];const i=new Uint32Array(this.buffer,e+4,20),s=new Map;s.set(t.FlipnoteAudioTrack.BGM,{ptr:e+=28,length:i[0]}),s.set(t.FlipnoteAudioTrack.SE1,{ptr:e+=i[0],length:i[1]}),s.set(t.FlipnoteAudioTrack.SE2,{ptr:e+=i[1],length:i[2]}),s.set(t.FlipnoteAudioTrack.SE3,{ptr:e+=i[2],length:i[3]}),s.set(t.FlipnoteAudioTrack.SE4,{ptr:e+=i[3],length:i[4]}),this.soundMeta=s}getFramePaletteIndices(t){d(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]);const e=this.readUint32();return[15&e,e>>8&15,e>>12&15,e>>16&15,e>>20&15,e>>24&15,e>>28&15]}getFramePalette(t){d(t,0,this.frameCount-1,"Frame index");return this.getFramePaletteIndices(t).map(t=>this.globalPalette[t])}getFrameDiffingFlag(t){d(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]);return this.readUint32()>>4&7}getFrameLayerSizes(t){return d(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+4),[this.readUint16(),this.readUint16(),this.readUint16()]}getFrameLayerDepths(t){d(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+20);return[this.readUint8(),this.readUint8(),this.readUint8()]}getFrameAuthor(t){return d(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+10),this.readFsid()}decodeFrameSoundFlags(t){d(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+23);const e=this.readUint8();return[0!=(1&e),0!=(2&e),0!=(4&e),0!=(8&e)]}getFrameCameraFlags(t){this.seek(this.frameMetaOffsets[t]+26);const e=this.readUint8();return[0!=(1&e),0!=(2&e),0!=(4&e)]}getFrameLayerOrder(t){d(t,0,this.frameCount-1,"Frame index");const e=this.getFrameLayerDepths(t);return[2,1,0].sort((t,i)=>e[i]-e[t])}decodeFrame(t,e=7,i=!1){if(d(t,0,this.frameCount-1,"Frame index"),this.prevDecodedFrame===t)return this.layerBuffers;this.prevDecodedFrame!==t-1&&0!==t&&(i&&(e&=~this.getFrameDiffingFlag(t+1)),0!==e&&this.decodeFrame(t-1,e,!0));let s=this.frameDataOffsets[t];const r=this.frameLayerSizes[t];for(let t=0;t<3&&(!this.settings.dsiLibraryNote||3!==t);t++){this.seek(s);let i=r[t];s+=i;const n=this.layerBuffers[t];if(38===i)continue;if(0==(e>>t&1))continue;this.bitIndex=16,this.bitValue=0;let a=0;for(let t=0;t<240;t+=128)for(let e=0;e<320;e+=128)for(let i=0;i<128;i+=8){const s=t+i;if(s>=240)break;for(let t=0;t<128;t+=8){const i=e+t;if(i>=320)break;if(a>0){a-=1;continue}let r=s*J.width+i;const o=this.readBits(3);if(0===o){const t=8*this.readBits(5),e=Y.subarray(t,t+8);n.set(e,r),n.set(e,r+=320),n.set(e,r+=320),n.set(e,r+=320),n.set(e,r+=320),n.set(e,r+=320),n.set(e,r+=320),n.set(e,r+=320)}else if(1===o){const t=8*this.readBits(13),e=K.subarray(t,t+8);n.set(e,r),n.set(e,r+=320),n.set(e,r+=320),n.set(e,r+=320),n.set(e,r+=320),n.set(e,r+=320),n.set(e,r+=320),n.set(e,r+=320)}else if(2===o){const t=8*this.readBits(5),e=Y.subarray(t,t+8),i=Q.subarray(t,t+8);n.set(e,r),n.set(i,r+=320),n.set(e,r+=320),n.set(i,r+=320),n.set(e,r+=320),n.set(i,r+=320),n.set(e,r+=320),n.set(i,r+=320)}else if(3===o){const t=8*this.readBits(13),e=K.subarray(t,t+8),i=G.subarray(t,t+8);n.set(e,r),n.set(i,r+=320),n.set(e,r+=320),n.set(i,r+=320),n.set(e,r+=320),n.set(i,r+=320),n.set(e,r+=320),n.set(i,r+=320)}else if(4===o){const t=this.readBits(8);for(let e=1;e<255;e<<=1){if(t&e){const t=8*this.readBits(5),e=Y.subarray(t,t+8);n.set(e,r)}else{const t=8*this.readBits(13),e=K.subarray(t,t+8);n.set(e,r)}r+=320}}else{if(5===o){a=this.readBits(5);continue}if(7===o){let t,e,i=this.readBits(2);if(0!==this.readBits(1)){const s=8*this.readBits(5),r=8*this.readBits(5);t=Y.subarray(s,s+8),e=Y.subarray(r,r+8),i+=1}else{const i=8*this.readBits(13),s=8*this.readBits(13);t=K.subarray(i,i+8),e=K.subarray(s,s+8)}switch(i%4){case 0:n.set(t,r),n.set(e,r+=320),n.set(t,r+=320),n.set(e,r+=320),n.set(t,r+=320),n.set(e,r+=320),n.set(t,r+=320),n.set(e,r+=320);break;case 1:n.set(t,r),n.set(t,r+=320),n.set(e,r+=320),n.set(t,r+=320),n.set(t,r+=320),n.set(e,r+=320),n.set(t,r+=320),n.set(t,r+=320);break;case 2:n.set(t,r),n.set(e,r+=320),n.set(t,r+=320),n.set(t,r+=320),n.set(e,r+=320),n.set(t,r+=320),n.set(t,r+=320),n.set(e,r+=320);break;case 3:n.set(t,r),n.set(e,r+=320),n.set(e,r+=320),n.set(t,r+=320),n.set(e,r+=320),n.set(e,r+=320),n.set(t,r+=320),n.set(e,r+=320)}}}}}}return this.prevDecodedFrame=t,this.layerBuffers}decodeSoundFlags(){return void 0!==this.soundFlags||(this.soundFlags=new Array(this.frameCount).fill(!1).map((t,e)=>this.decodeFrameSoundFlags(e))),this.soundFlags}getSoundEffectFlags(){return this.decodeSoundFlags().map(e=>({[t.FlipnoteSoundEffectTrack.SE1]:e[0],[t.FlipnoteSoundEffectTrack.SE2]:e[1],[t.FlipnoteSoundEffectTrack.SE3]:e[2],[t.FlipnoteSoundEffectTrack.SE4]:e[3]}))}getFrameSoundEffectFlags(e){const i=this.decodeFrameSoundFlags(e);return{[t.FlipnoteSoundEffectTrack.SE1]:i[0],[t.FlipnoteSoundEffectTrack.SE2]:i[1],[t.FlipnoteSoundEffectTrack.SE3]:i[2],[t.FlipnoteSoundEffectTrack.SE4]:i[3]}}getAudioTrackRaw(t){const e=this.soundMeta.get(t);return c(e.ptr+e.length<this.byteLength),new Uint8Array(this.buffer,e.ptr,e.length)}decodeAdpcm(t,e,i=0,o=0){const h=t.length;let l=0,c=0,d=0,u=0;for(let f=0;f<h;f++){let h=t[f],p=0;for(;p<8;)o<18||p>4?(c=3&h,d=n[o],u=d>>3,1&c&&(u+=d),2&c&&(u=-u),i+=u,o+=s[c],h>>=2,p+=2):(c=15&h,d=n[o],u=d>>3,1&c&&(u+=d>>2),2&c&&(u+=d>>1),4&c&&(u+=d),8&c&&(u=-u),i+=u,o+=r[c],h>>=4,p+=4),o=a(o,0,79),i=a(i,-2048,2047),e[l]=16*i,l+=1}return l}decodeAudioTrack(e){const i=this.settings,s=this.getAudioTrackRaw(e),r=60*this.rawSampleRate,n=new Int16Array(r);let a=0,o=40;if(this.isDsiLibraryNote)if(e===t.FlipnoteAudioTrack.BGM){if(null!==i.initialBgmPredictor&&(a=i.initialBgmPredictor),null!==i.initialBgmStepIndex&&(o=i.initialBgmStepIndex),i.guessInitialBgmState){let t=4294967295,e=0;for(o=0;o<=40;o++){const i=this.decodeAdpcm(s,n,a,o),r=l(n.subarray(0,i));r<t&&(t=r,e=o)}o=e}}else{const t=this.soundEffectTracks.indexOf(e);Array.isArray(i.initialSePredictors)&&void 0!==i.initialSePredictors[t]&&(a=i.initialSePredictors[t]),Array.isArray(i.initialSeStepIndices)&&void 0!==i.initialSeStepIndices[t]&&(o=i.initialSeStepIndices[t])}const h=this.decodeAdpcm(s,n,a,o);return n.slice(0,h)}getAudioTrackPcm(e,i=this.sampleRate){const s=this.decodeAudioTrack(e);let r=this.rawSampleRate;if(e===t.FlipnoteAudioTrack.BGM){const t=1/this.bgmrate/(1/this.framerate);r=this.rawSampleRate*t}return r!==i?function(t,e,i){const s=t.length,r=s/e*i,n=new Int16Array(r),a=e/i;for(let e=0,i=0,c=0,d=0;e<r;e++)i=e*a,c=Math.floor(i),d=i%1,n[e]=(h=o(t,s,c),l=o(t,s,c+1),h+d*(l-h));var h,l;return n}(s,r,i):s}pcmAudioMix(t,e,i=0){const s=t.length,r=e.length;for(let n=0;n<s&&!(i+n>r);n++){const s=e[i+n]+t[n];e[i+n]=a(s,-32768,32767)}}getAudioMasterPcm(e=this.sampleRate){const i=Math.ceil(this.duration*e),s=new Int16Array(i),r=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),n=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3),l=this.hasAudioTrack(t.FlipnoteAudioTrack.SE4);if(r){const i=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,e);this.pcmAudioMix(i,s,0)}if(n||a||o||l){const i=e/this.framerate,r=n?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,e):null,h=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,e):null,c=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,e):null,d=l?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE4,e):null,u=this.decodeSoundFlags();for(let t=0;t<this.frameCount;t++){const e=u[t],f=Math.ceil(t*i);n&&e[0]&&this.pcmAudioMix(r,s,f),a&&e[1]&&this.pcmAudioMix(h,s,f),o&&e[2]&&this.pcmAudioMix(c,s,f),l&&e[3]&&this.pcmAudioMix(d,s,f)}}return this.audioClipRatio=h(s),s}getBody(){const t=this.bodyEndOffset;return this.bytes.subarray(0,t)}getSignature(){const t=this.bodyEndOffset;return this.bytes.subarray(t,t+256)}async verify(){const t=await w(j,"SHA-256");return await _(t,this.getSignature(),this.getBody())}}J.defaultSettings={quickMeta:!1,dsiLibraryNote:!1,borderCrop:!1,guessInitialBgmState:!0,initialBgmPredictor:null,initialBgmStepIndex:null,initialSePredictors:null,initialSeStepIndices:null},J.format=t.FlipnoteFormat.KWZ,J.width=320,J.height=240,J.numLayers=3,J.numLayerColors=2,J.rawSampleRate=16364,J.sampleRate=32768,J.audioTracks=[t.FlipnoteAudioTrack.BGM,t.FlipnoteAudioTrack.SE1,t.FlipnoteAudioTrack.SE2,t.FlipnoteAudioTrack.SE3,t.FlipnoteAudioTrack.SE4],J.soundEffectTracks=[t.FlipnoteSoundEffectTrack.SE1,t.FlipnoteSoundEffectTrack.SE2,t.FlipnoteSoundEffectTrack.SE3,t.FlipnoteSoundEffectTrack.SE4],J.globalPalette=[$.WHITE,$.BLACK,$.RED,$.YELLOW,$.GREEN,$.BLUE,$.NONE],J.publicKey=j;const Z=[{matches:function(t){return p&&"string"==typeof t},load:function(t,e,i){const s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="arraybuffer",s.onreadystatechange=function(t){4===s.readyState&&(s.status>=200&&s.status<300?e(s.response):i({type:"httpError",status:s.status,statusText:s.statusText}))},s.send(null)}},{matches:function(t){return g&&"string"==typeof t},load:function(t,e,i){y();u(module,"https").get(t,t=>{const s=[];t.on("data",t=>s.push(t)),t.on("end",()=>{const t=Buffer.concat(s);e(t.buffer)}),t.on("error",t=>i(t))})}},{matches:function(t){return p&&"undefined"!=typeof File&&"undefined"!=typeof FileReader&&t instanceof File},load:function(t,e,i){const s=new FileReader;s.onload=t=>{e(s.result)},s.onerror=t=>{i({type:"fileReadError"})},s.readAsArrayBuffer(t)}},{matches:function(t){return p&&"undefined"!=typeof Blob&&"undefined"!=typeof Response&&t instanceof Blob},load:function(t,e,i){new Response(t).arrayBuffer().then(e).catch(i)}},{matches:function(t){return g&&t instanceof Buffer},load:function(t,e,i){e(t.buffer)}},{matches:function(t){return t instanceof ArrayBuffer},load:function(t,e,i){e(t)}}];function tt(t,e){return function(t){return new Promise((e,i)=>{for(let s=0;s<Z.length;s++){const r=Z[s];if(r.matches(t))return r.load(t,e,i)}i("No loader available for source type")})}(t).then(t=>new Promise((i,s)=>{const r=new Uint8Array(t.slice(0,4)),n=r[0]<<24|r[1]<<16|r[2]<<8|r[3];1346458177===n?i(new V(t,e)):1262897152==(4294967040&n)||1263092480==(4294967040&n)?i(new J(t,e)):s("Could not identify source as a valid Flipnote file")}))}var et;t.PlayerEvent=void 0,(et=t.PlayerEvent||(t.PlayerEvent={})).__Any="any",et.Play="play",et.Pause="pause",et.CanPlay="canplay",et.CanPlayThrough="canplaythrough",et.SeekStart="seeking",et.SeekEnd="seeked",et.Duration="durationchange",et.Loop="loop",et.Ended="ended",et.VolumeChange="volumechange",et.Progress="progress",et.TimeUpdate="timeupdate",et.FrameUpdate="frameupdate",et.FrameNext="framenext",et.FramePrev="frameprev",et.FrameFirst="framefirst",et.FrameLast="framelast",et.Ready="ready",et.Load="load",et.LoadStart="loadstart",et.LoadedData="loadeddata",et.LoadedMeta="loadedmetadata",et.Emptied="emptied",et.Close="close",et.Error="error",et.Destroy="destroy";const it=[t.PlayerEvent.Play,t.PlayerEvent.Pause,t.PlayerEvent.CanPlay,t.PlayerEvent.CanPlayThrough,t.PlayerEvent.SeekStart,t.PlayerEvent.SeekEnd,t.PlayerEvent.Duration,t.PlayerEvent.Loop,t.PlayerEvent.Ended,t.PlayerEvent.VolumeChange,t.PlayerEvent.Progress,t.PlayerEvent.TimeUpdate,t.PlayerEvent.FrameUpdate,t.PlayerEvent.FrameNext,t.PlayerEvent.FramePrev,t.PlayerEvent.FrameFirst,t.PlayerEvent.FrameLast,t.PlayerEvent.Ready,t.PlayerEvent.Load,t.PlayerEvent.LoadStart,t.PlayerEvent.LoadedData,t.PlayerEvent.LoadedMeta,t.PlayerEvent.Emptied,t.PlayerEvent.Close,t.PlayerEvent.Error];function st(t){return{length:t.length,start:e=>t[e][0],end:e=>t[e][1]}}function rt(t,e){return t.toString().padStart(e,"0")}function nt(t){return`${Math.floor(t%3600/60)}:${rt(Math.floor(t%60),2)}`}function at(t){if(t instanceof Int8Array)return 5120;if(t instanceof Uint8Array)return 5121;if(t instanceof Uint8ClampedArray)return 5121;if(t instanceof Int16Array)return 5122;if(t instanceof Uint16Array)return 5123;if(t instanceof Int32Array)return 5124;if(t instanceof Uint32Array)return 5125;if(t instanceof Float32Array)return 5126;throw new Error("unsupported typed array type")}const ot="undefined"!=typeof SharedArrayBuffer?function(t){return t&&t.buffer&&(t.buffer instanceof ArrayBuffer||t.buffer instanceof SharedArrayBuffer)}:function(t){return t&&t.buffer&&t.buffer instanceof ArrayBuffer};function ht(t,e){return"undefined"!=typeof WebGLTexture&&e instanceof WebGLTexture}const lt="";function ct(t,e,i,s){if(r=e,"undefined"!=typeof WebGLBuffer&&r instanceof WebGLBuffer)return e;var r;i=i||34962;const n=t.createBuffer();return function(t,e,i,s,r){t.bindBuffer(e,i),t.bufferData(e,s,r||35044)}(t,i,n,e,s),n}function dt(t){return"indices"===t}const ut=/coord|texture/i,ft=/color|colour/i;function pt(t,e){let i;if(i=ut.test(t)?2:ft.test(t)?4:3,e%i>0)throw new Error(`Can not guess numComponents for attribute '${t}'. Tried ${i} but ${e} values is not evenly divisible by ${i}. You should specify it.`);return i}function mt(t,e){if(ot(t))return t;if(ot(t.data))return t.data;Array.isArray(t)&&(t={data:t});let i=t.type;return i||(i=dt(e)?Uint16Array:Float32Array),new i(t.data)}function gt(t,e){const i={};return Object.keys(e).forEach((function(s){if(!dt(s)){const n=e[s],a=n.attrib||n.name||n.attribName||lt+s;if(n.value){if(!Array.isArray(n.value)&&!ot(n.value))throw new Error("array.value is not array or typedarray");i[a]={value:n.value}}else{let e,o,h,l;if(n.buffer&&n.buffer instanceof WebGLBuffer)e=n.buffer,l=n.numComponents||n.size,o=n.type,h=n.normalize;else if("number"==typeof n||"number"==typeof n.data){const i=n.data||n,a=n.type||Float32Array,c=i*a.BYTES_PER_ELEMENT;o=function(t){if(t===Int8Array)return 5120;if(t===Uint8Array)return 5121;if(t===Uint8ClampedArray)return 5121;if(t===Int16Array)return 5122;if(t===Uint16Array)return 5123;if(t===Int32Array)return 5124;if(t===Uint32Array)return 5125;if(t===Float32Array)return 5126;throw new Error("unsupported typed array type")}(a),h=void 0!==n.normalize?n.normalize:(r=a)===Int8Array||r===Uint8Array,l=n.numComponents||n.size||pt(s,i),e=t.createBuffer(),t.bindBuffer(34962,e),t.bufferData(34962,c,n.drawType||35044)}else{const i=mt(n,s);e=ct(t,i,void 0,n.drawType),o=at(i),h=void 0!==n.normalize?n.normalize:function(t){return t instanceof Int8Array||t instanceof Uint8Array}(i),l=function(t,e){return t.numComponents||t.size||pt(e,function(t){return t.length?t:t.data}(t).length)}(n,s)}i[a]={buffer:e,numComponents:l,type:o,normalize:h,stride:n.stride||0,offset:n.offset||0,divisor:void 0===n.divisor?void 0:n.divisor,drawType:n.drawType}}}var r})),t.bindBuffer(34962,null),i}const yt=["position","positions","a_position"];function vt(t,e,i){const s=gt(t,e),r=Object.assign({},i||{});r.attribs=Object.assign({},i?i.attribs:{},s);const n=e.indices;if(n){const e=mt(n,"indices");r.indices=ct(t,e,34963),r.numElements=e.length,r.elementType=at(e)}else r.numElements||(r.numElements=function(t,e){let i,s;for(s=0;s<yt.length&&(i=yt[s],!(i in e))&&(i=lt+i,!(i in e));++s);s===yt.length&&(i=Object.keys(e)[0]);const r=e[i];t.bindBuffer(34962,r.buffer);const n=t.getBufferParameter(34962,34660);var a;t.bindBuffer(34962,null);const o=n/(5120===(a=r.type)||5121===a?1:5122===a||5123===a?2:5124===a||5125===a||5126===a?4:0),h=r.numComponents||r.size,l=o/h;if(l%1!=0)throw new Error(`numComponents ${h} not correct for length ${length}`);return l}(t,r.attribs));return r}function bt(t){return!!t.texStorage2D}const St={};function wt(t,e){return St[e].bindPoint}function _t(t,e){return function(i){t.uniform1i(e,i)}}function Et(t,e){return function(i){t.uniform1iv(e,i)}}function xt(t,e){return function(i){t.uniform2iv(e,i)}}function Pt(t,e){return function(i){t.uniform3iv(e,i)}}function At(t,e){return function(i){t.uniform4iv(e,i)}}function Ft(t,e,i,s){const r=wt(0,e);return bt(t)?function(e){let n,a;ht(0,e)?(n=e,a=null):(n=e.texture,a=e.sampler),t.uniform1i(s,i),t.activeTexture(33984+i),t.bindTexture(r,n),t.bindSampler(i,a)}:function(e){t.uniform1i(s,i),t.activeTexture(33984+i),t.bindTexture(r,e)}}function Ct(t,e,i,s,r){const n=wt(0,e),a=new Int32Array(r);for(let t=0;t<r;++t)a[t]=i+t;return bt(t)?function(e){t.uniform1iv(s,a),e.forEach((function(e,s){let r,o;t.activeTexture(33984+a[s]),ht(0,e)?(r=e,o=null):(r=e.texture,o=e.sampler),t.bindSampler(i,o),t.bindTexture(n,r)}))}:function(e){t.uniform1iv(s,a),e.forEach((function(e,i){t.activeTexture(33984+a[i]),t.bindTexture(n,e)}))}}function Tt(t,e){return function(i){if(i.value)switch(t.disableVertexAttribArray(e),i.value.length){case 4:t.vertexAttrib4fv(e,i.value);break;case 3:t.vertexAttrib3fv(e,i.value);break;case 2:t.vertexAttrib2fv(e,i.value);break;case 1:t.vertexAttrib1fv(e,i.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else t.bindBuffer(34962,i.buffer),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,i.numComponents||i.size,i.type||5126,i.normalize||!1,i.stride||0,i.offset||0),void 0!==i.divisor&&t.vertexAttribDivisor(e,i.divisor)}}function kt(t,e){return function(i){if(i.value){if(t.disableVertexAttribArray(e),4!==i.value.length)throw new Error("The length of an integer constant value must be 4!");t.vertexAttrib4iv(e,i.value)}else t.bindBuffer(34962,i.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,i.numComponents||i.size,i.type||5124,i.stride||0,i.offset||0),void 0!==i.divisor&&t.vertexAttribDivisor(e,i.divisor)}}function Ut(t,e){return function(i){if(i.value){if(t.disableVertexAttribArray(e),4!==i.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");t.vertexAttrib4uiv(e,i.value)}else t.bindBuffer(34962,i.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,i.numComponents||i.size,i.type||5125,i.stride||0,i.offset||0),void 0!==i.divisor&&t.vertexAttribDivisor(e,i.divisor)}}function Bt(t,e,i){const s=i.size,r=i.count;return function(i){t.bindBuffer(34962,i.buffer);const n=i.size||i.numComponents||s,a=n/r,o=i.type||5126,h=St[o].size*n,l=i.normalize||!1,c=i.offset||0,d=h/r;for(let s=0;s<r;++s)t.enableVertexAttribArray(e+s),t.vertexAttribPointer(e+s,a,o,l,h,c+d*s),void 0!==i.divisor&&t.vertexAttribDivisor(e+s,i.divisor)}}St[5126]={Type:Float32Array,size:4,setter:function(t,e){return function(i){t.uniform1f(e,i)}},arraySetter:function(t,e){return function(i){t.uniform1fv(e,i)}}},St[35664]={Type:Float32Array,size:8,setter:function(t,e){return function(i){t.uniform2fv(e,i)}},cols:2},St[35665]={Type:Float32Array,size:12,setter:function(t,e){return function(i){t.uniform3fv(e,i)}},cols:3},St[35666]={Type:Float32Array,size:16,setter:function(t,e){return function(i){t.uniform4fv(e,i)}},cols:4},St[5124]={Type:Int32Array,size:4,setter:_t,arraySetter:Et},St[35667]={Type:Int32Array,size:8,setter:xt,cols:2},St[35668]={Type:Int32Array,size:12,setter:Pt,cols:3},St[35669]={Type:Int32Array,size:16,setter:At,cols:4},St[5125]={Type:Uint32Array,size:4,setter:function(t,e){return function(i){t.uniform1ui(e,i)}},arraySetter:function(t,e){return function(i){t.uniform1uiv(e,i)}}},St[36294]={Type:Uint32Array,size:8,setter:function(t,e){return function(i){t.uniform2uiv(e,i)}},cols:2},St[36295]={Type:Uint32Array,size:12,setter:function(t,e){return function(i){t.uniform3uiv(e,i)}},cols:3},St[36296]={Type:Uint32Array,size:16,setter:function(t,e){return function(i){t.uniform4uiv(e,i)}},cols:4},St[35670]={Type:Uint32Array,size:4,setter:_t,arraySetter:Et},St[35671]={Type:Uint32Array,size:8,setter:xt,cols:2},St[35672]={Type:Uint32Array,size:12,setter:Pt,cols:3},St[35673]={Type:Uint32Array,size:16,setter:At,cols:4},St[35674]={Type:Float32Array,size:32,setter:function(t,e){return function(i){t.uniformMatrix2fv(e,!1,i)}},rows:2,cols:2},St[35675]={Type:Float32Array,size:48,setter:function(t,e){return function(i){t.uniformMatrix3fv(e,!1,i)}},rows:3,cols:3},St[35676]={Type:Float32Array,size:64,setter:function(t,e){return function(i){t.uniformMatrix4fv(e,!1,i)}},rows:4,cols:4},St[35685]={Type:Float32Array,size:32,setter:function(t,e){return function(i){t.uniformMatrix2x3fv(e,!1,i)}},rows:2,cols:3},St[35686]={Type:Float32Array,size:32,setter:function(t,e){return function(i){t.uniformMatrix2x4fv(e,!1,i)}},rows:2,cols:4},St[35687]={Type:Float32Array,size:48,setter:function(t,e){return function(i){t.uniformMatrix3x2fv(e,!1,i)}},rows:3,cols:2},St[35688]={Type:Float32Array,size:48,setter:function(t,e){return function(i){t.uniformMatrix3x4fv(e,!1,i)}},rows:3,cols:4},St[35689]={Type:Float32Array,size:64,setter:function(t,e){return function(i){t.uniformMatrix4x2fv(e,!1,i)}},rows:4,cols:2},St[35690]={Type:Float32Array,size:64,setter:function(t,e){return function(i){t.uniformMatrix4x3fv(e,!1,i)}},rows:4,cols:3},St[35678]={Type:null,size:0,setter:Ft,arraySetter:Ct,bindPoint:3553},St[35680]={Type:null,size:0,setter:Ft,arraySetter:Ct,bindPoint:34067},St[35679]={Type:null,size:0,setter:Ft,arraySetter:Ct,bindPoint:32879},St[35682]={Type:null,size:0,setter:Ft,arraySetter:Ct,bindPoint:3553},St[36289]={Type:null,size:0,setter:Ft,arraySetter:Ct,bindPoint:35866},St[36292]={Type:null,size:0,setter:Ft,arraySetter:Ct,bindPoint:35866},St[36293]={Type:null,size:0,setter:Ft,arraySetter:Ct,bindPoint:34067},St[36298]={Type:null,size:0,setter:Ft,arraySetter:Ct,bindPoint:3553},St[36299]={Type:null,size:0,setter:Ft,arraySetter:Ct,bindPoint:32879},St[36300]={Type:null,size:0,setter:Ft,arraySetter:Ct,bindPoint:34067},St[36303]={Type:null,size:0,setter:Ft,arraySetter:Ct,bindPoint:35866},St[36306]={Type:null,size:0,setter:Ft,arraySetter:Ct,bindPoint:3553},St[36307]={Type:null,size:0,setter:Ft,arraySetter:Ct,bindPoint:32879},St[36308]={Type:null,size:0,setter:Ft,arraySetter:Ct,bindPoint:34067},St[36311]={Type:null,size:0,setter:Ft,arraySetter:Ct,bindPoint:35866};const Lt={};function It(t){const e=t.name;return e.startsWith("gl_")||e.startsWith("webgl_")}Lt[5126]={size:4,setter:Tt},Lt[35664]={size:8,setter:Tt},Lt[35665]={size:12,setter:Tt},Lt[35666]={size:16,setter:Tt},Lt[5124]={size:4,setter:kt},Lt[35667]={size:8,setter:kt},Lt[35668]={size:12,setter:kt},Lt[35669]={size:16,setter:kt},Lt[5125]={size:4,setter:Ut},Lt[36294]={size:8,setter:Ut},Lt[36295]={size:12,setter:Ut},Lt[36296]={size:16,setter:Ut},Lt[35670]={size:4,setter:kt},Lt[35671]={size:8,setter:kt},Lt[35672]={size:12,setter:kt},Lt[35673]={size:16,setter:kt},Lt[35674]={size:4,setter:Bt,count:2},Lt[35675]={size:9,setter:Bt,count:3},Lt[35676]={size:16,setter:Bt,count:4};const Nt=/(\.|\[|]|\w+)/g;function Mt(t,e,i,s){const r=t.split(Nt).filter(t=>""!==t);let n=0,a="";for(;;){const t=r[n++];a+=t;const h=(o=t[0])>="0"&&o<="9",l=h?parseInt(t):t;h&&(a+=r[n++]);if(n===r.length){i[l]=e;break}{const t=r[n++],e="["===t,o=i[l]||(e?[]:{});i[l]=o,i=o,s[a]=s[a]||function(t){return function(e){Rt(t,e)}}(o),a+=t}}var o}function Rt(t,e){for(const i in e){const s=t[i];"function"==typeof s?s(e[i]):Rt(t[i],e[i])}}function zt(t,e){const i={program:e,uniformSetters:function(t,e){let i=0;function s(e,s,r){const n=s.name.endsWith("[0]"),a=s.type,o=St[a];if(!o)throw new Error("unknown type: 0x"+a.toString(16));let h;if(o.bindPoint){const e=i;i+=s.size,h=n?o.arraySetter(t,a,e,r,s.size):o.setter(t,a,e,r,s.size)}else h=o.arraySetter&&n?o.arraySetter(t,r):o.setter(t,r);return h.location=r,h}const r={},n={},a=t.getProgramParameter(e,35718);for(let i=0;i<a;++i){const a=t.getActiveUniform(e,i);if(It(a))continue;let o=a.name;o.endsWith("[0]")&&(o=o.substr(0,o.length-3));const h=t.getUniformLocation(e,a.name);if(h){const t=s(0,a,h);r[o]=t,Mt(o,t,n,r)}}return r}(t,e),attribSetters:function(t,e){const i={},s=t.getProgramParameter(e,35721);for(let r=0;r<s;++r){const s=t.getActiveAttrib(e,r);if(It(s))continue;const n=t.getAttribLocation(e,s.name),a=Lt[s.type],o=a.setter(t,n,a);o.location=n,i[s.name]=o}return i}(t,e)};return bt(t)&&(i.uniformBlockSpec=function(t,e){const i=t.getProgramParameter(e,35718),s=[],r=[];for(let n=0;n<i;++n){r.push(n),s.push({});const i=t.getActiveUniform(e,n);s[n].name=i.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(i){const n=i[0],a=i[1];t.getActiveUniforms(e,r,t[n]).forEach((function(t,e){s[e][a]=t}))}));const n={},a=t.getProgramParameter(e,35382);for(let i=0;i<a;++i){const s=t.getActiveUniformBlockName(e,i),r={index:t.getUniformBlockIndex(e,s),usedByVertexShader:t.getActiveUniformBlockParameter(e,i,35396),usedByFragmentShader:t.getActiveUniformBlockParameter(e,i,35398),size:t.getActiveUniformBlockParameter(e,i,35392),uniformIndices:t.getActiveUniformBlockParameter(e,i,35395)};r.used=r.usedByVertexShader||r.usedByFragmentShader,n[s]=r}return{blockSpecs:n,uniformData:s}}(t,e),i.transformFeedbackInfo=function(t,e){const i={},s=t.getProgramParameter(e,35971);for(let r=0;r<s;++r){const s=t.getTransformFeedbackVarying(e,r);i[s.name]={index:r,type:s.type,size:s.size}}return i}(t,e)),i}class Ot{constructor(t,e=640,i=480,s={}){this.paletteBuffer=new Uint32Array(16),this.refs={programs:[],shaders:[],textures:[],buffers:[]},this.isCtxLost=!1,this.handleContextLoss=t=>{t&&t.preventDefault(),this.destroy(),this.isCtxLost||this.options.onlost(),this.isCtxLost=!0},this.handleContextRestored=t=>{this.isCtxLost=!1,this.init(),this.options.onrestored()},m(),this.options=Object.assign(Object.assign({},Ot.defaultOptions),s),this.width=e,this.height=i,this.canvas=document.createElement("canvas"),this.canvas.addEventListener("webglcontextlost",this.handleContextLoss,!1),this.canvas.addEventListener("webglcontextrestored",this.handleContextRestored,!1),this.canvas.className="FlipnoteCanvas FlipnoteCanvas--webgl",this.gl=this.canvas.getContext("webgl",{antialias:!1,alpha:!0}),t&&t.appendChild(this.canvas),this.init()}static isSupported(){if(!p)return!1;let t=document.createElement("canvas"),e=t.getContext("2d");const i=null!==e;return t=null,e=null,i}init(){this.setCanvasSize(this.width,this.height);const t=this.gl;this.checkContextLoss()||(this.program=this.createProgram("#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_texel;varying vec2 v_uv;varying float v_scale;uniform bool u_flipY;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){v_uv=texcoord;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);gl_Position=position;if(u_flipY){gl_Position.y*=-1.;}}","precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 v_texel=v_uv*u_textureSize;vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;gl_FragColor=texture2D(u_tex,coord);}"),this.quadBuffer=this.createScreenQuad(-1,-1,2,2,1,1),this.setBuffersAndAttribs(this.program,this.quadBuffer),this.frameTexture=this.createTexture(t.RGBA,t.LINEAR,t.CLAMP_TO_EDGE),t.useProgram(this.program.program),t.bindTexture(t.TEXTURE_2D,this.frameTexture))}createProgram(t,e){if(this.checkContextLoss())return;const i=this.gl,s=this.createShader(i.VERTEX_SHADER,t),r=this.createShader(i.FRAGMENT_SHADER,e),n=i.createProgram();if(i.attachShader(n,s),i.attachShader(n,r),i.linkProgram(n),!i.getProgramParameter(n,i.LINK_STATUS)){const t=i.getProgramInfoLog(n);throw i.deleteProgram(n),new Error(t)}const a=zt(i,n);return this.refs.programs.push(n),a}createShader(t,e){if(this.checkContextLoss())return;const i=this.gl,s=i.createShader(t);if(i.shaderSource(s,e),i.compileShader(s),!i.getShaderParameter(s,i.COMPILE_STATUS)){const t=i.getShaderInfoLog(s);throw i.deleteShader(s),new Error(t)}return this.refs.shaders.push(s),s}createScreenQuad(t,e,i,s,r,n){if(this.checkContextLoss())return;const a=(r+1)*(n+1),o=r+1,h=new Float32Array(2*a),l=new Float32Array(2*a);let c=0,d=0;for(let a=0;a<=n;a++)for(let o=0;o<=r;o++){const u=o/r,f=a/n;h[c++]=t+i*u,h[c++]=e+s*f,l[d++]=u,l[d++]=f}const u=new Uint16Array(r*n*2*3);let f=0;for(let t=0;t<n;t++)for(let e=0;e<r;e++)u[f++]=(t+0)*o+e,u[f++]=(t+1)*o+e,u[f++]=(t+0)*o+e+1,u[f++]=(t+0)*o+e+1,u[f++]=(t+1)*o+e,u[f++]=(t+1)*o+e+1;const p=vt(this.gl,{position:{numComponents:2,data:h},texcoord:{numComponents:2,data:l},indices:u});for(let t in p.attribs)this.refs.buffers.push(p.attribs[t].buffer);return p}setBuffersAndAttribs(t,e){if(this.checkContextLoss())return;const i=this.gl;!function(t,e){for(const i in e){const s=t[i];s&&s(e[i])}}(t.attribSetters,e.attribs),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.indices)}createTexture(t,e,i,s=1,r=1){if(this.checkContextLoss())return;const n=this.gl,a=n.createTexture();return n.bindTexture(n.TEXTURE_2D,a),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,e),n.texImage2D(n.TEXTURE_2D,0,t,s,r,0,t,n.UNSIGNED_BYTE,null),this.refs.textures.push(a),a}setCanvasSize(t,e){const i=this.options.useDpi&&window.devicePixelRatio||1,s=t*i,r=e*i;this.width=t,this.height=e,this.canvas.width=s,this.canvas.height=r,this.dstWidth=s,this.dstHeight=r,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px";const n=this.gl;this.checkContextLoss()||n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight)}setNote(t){if(this.checkContextLoss())return;const e=this.gl,i=t.imageWidth,s=t.imageHeight;this.note=t,this.srcWidth=i,this.srcHeight=s,e.bindTexture(e.TEXTURE_2D,this.frameTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.srcWidth,this.srcHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),this.frameBuffer=new Uint32Array(i*s),this.frameBufferBytes=new Uint8Array(this.frameBuffer.buffer),this.prevFrameIndex=void 0,this.canvas.title=t.getTitle()}clear(t){if(!this.checkContextLoss()){if(t){const[e,i,s,r]=t;this.gl.clearColor(e/255,i/255,s/255,r/255)}this.gl.clear(this.gl.COLOR_BUFFER_BIT)}}drawFrame(t){if(this.checkContextLoss())return;const{gl:e,srcWidth:i,srcHeight:s}=this;this.note.getFramePixelsRgba(t,this.frameBuffer,this.paletteBuffer),e.clear(this.gl.COLOR_BUFFER_BIT),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,i,s,0,e.RGBA,e.UNSIGNED_BYTE,this.frameBufferBytes),function t(e,...i){const s=e.uniformSetters||e,r=i.length;for(let e=0;e<r;++e){const r=i[e];if(Array.isArray(r)){const e=r.length;for(let i=0;i<e;++i)t(s,r[i])}else for(const t in r){const e=s[t];e&&e(r[t])}}}(this.program,{u_flipY:!0,u_tex:this.frameTexture,u_textureSize:[this.srcWidth,this.srcHeight],u_screenSize:[e.drawingBufferWidth,e.drawingBufferHeight]}),e.drawElements(e.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0),this.prevFrameIndex=t}forceUpdate(){void 0!==this.prevFrameIndex&&this.drawFrame(this.prevFrameIndex)}isErrorState(){const t=this.gl;return null===t||t.getError()!==t.NO_ERROR}checkContextLoss(){const t=this.isCtxLost||this.isErrorState();return t&&this.handleContextLoss(),t}getDataUrl(t,e){return this.canvas.toDataURL(t,e)}async getBlob(t,e){return new Promise((i,s)=>this.canvas.toBlob(i,t,e))}destroy(){const t=this.refs,e=this.gl,i=this.canvas;t.shaders.forEach(t=>{e.deleteShader(t)}),t.shaders=[],t.textures.forEach(t=>{e.deleteTexture(t)}),t.textures=[],t.buffers.forEach(t=>{e.deleteBuffer(t)}),t.buffers=[],t.programs.forEach(t=>{e.deleteProgram(t)}),t.programs=[],this.paletteBuffer=null,this.frameBuffer=null,this.frameBufferBytes=null,i&&i.parentElement&&(i.width=1,i.height=1,i.parentNode.removeChild(i))}}Ot.defaultOptions={onlost:()=>{},onrestored:()=>{},useDpi:!0};class Dt{constructor(t,e,i,s={}){this.paletteBuffer=new Uint32Array(16),m(),this.options=Object.assign(Object.assign({},Dt.defaultOptions),s),this.width=e,this.height=i,this.canvas=document.createElement("canvas"),this.canvas.className="FlipnoteCanvas FlipnoteCanvas--html5",this.ctx=this.canvas.getContext("2d"),this.srcCanvas=document.createElement("canvas"),this.srcCtx=this.srcCanvas.getContext("2d"),c(null!==this.ctx&&null!==this.srcCtx,"Could not create HTML5 canvas"),t&&t.appendChild(this.canvas),this.setCanvasSize(e,i)}static isSupported(){if(!p)return!1;let t=document.createElement("canvas"),e=t.getContext("2d");const i=null!==e;return t=null,e=null,i}setCanvasSize(t,e){const i=this.canvas,s=this.options.useDpi&&window.devicePixelRatio||1,r=t*s,n=e*s;this.width=t,this.height=e,this.dstWidth=r,this.dstHeight=n,i.style.width=t+"px",i.style.height=e+"px",i.width=r,i.height=n}setNote(t){const e=t.imageWidth,i=t.imageHeight;this.note=t,this.srcWidth=e,this.srcHeight=i,this.srcCanvas.width=e,this.srcCanvas.height=i,this.frameImage=this.srcCtx.createImageData(e,i),this.frameBuffer=new Uint32Array(this.frameImage.data.buffer),this.prevFrameIndex=void 0,this.canvas.title=t.getTitle()}clear(t){if(this.frameBuffer.fill(0),this.ctx.clearRect(0,0,this.dstWidth,this.dstHeight),t){const[e,i,s,r]=t;this.ctx.fillStyle=`rgba(${e}, ${i}, ${s}, ${r})`,this.ctx.fillRect(0,0,this.dstWidth,this.dstHeight)}}drawFrame(t){this.clear(),this.options.useSmoothing||(this.ctx.imageSmoothingEnabled=!1),this.note.getFramePixelsRgba(t,this.frameBuffer,this.paletteBuffer),this.srcCtx.putImageData(this.frameImage,0,0),this.ctx.drawImage(this.srcCanvas,0,0,this.srcWidth,this.srcHeight,0,0,this.dstWidth,this.dstHeight),this.prevFrameIndex=t}forceUpdate(){void 0!==this.prevFrameIndex&&this.drawFrame(this.prevFrameIndex)}getDataUrl(t,e){return this.canvas.toDataURL(t,e)}async getBlob(t,e){return new Promise((i,s)=>this.canvas.toBlob(i,t,e))}destroy(){this.frameImage=null,this.paletteBuffer=null,this.frameBuffer=null,this.canvas.parentNode.removeChild(this.canvas),this.canvas.width=1,this.canvas.height=1,this.canvas=null,this.srcCanvas.width=1,this.srcCanvas.height=1,this.srcCanvas=null}}Dt.defaultOptions={useDpi:!0,useSmoothing:!0};class Wt{constructor(t,e=640,i=480,s={}){this.options={},this.isReady=!1,this.isHtml5=!1,this.parent=t,this.options=s;try{this.renderer=new Ot(t,e,i,Object.assign(Object.assign({},s),{onlost:()=>{if(console.warn("WebGL failed, attempting HTML5 fallback"),!this.isReady||this.isHtml5)throw"";this.switchToHtml5()}}))}catch(t){this.switchToHtml5()}this.isReady=!0}switchToHtml5(){var t;const e=new Dt(this.parent,this.width,this.height,this.options);this.note&&(e.setNote(this.note),e.prevFrameIndex=null===(t=this.renderer)||void 0===t?void 0:t.prevFrameIndex,e.forceUpdate()),this.isHtml5=!0,this.renderer=e}setCanvasSize(t,e){const i=this.renderer;i.setCanvasSize(t,e),this.width=t,this.width=e,this.dstWidth=i.dstWidth,this.dstHeight=i.dstHeight}setNote(t){this.note=t,this.renderer.setNote(t),this.prevFrameIndex=void 0,this.srcWidth=this.renderer.srcWidth,this.srcHeight=this.renderer.srcHeight}clear(t){this.renderer.clear(t)}drawFrame(t){this.renderer.drawFrame(t),this.prevFrameIndex=t}forceUpdate(){this.renderer.forceUpdate()}getDataUrl(t,e){return this.renderer.getDataUrl()}async getBlob(t,e){return this.renderer.getBlob()}destroy(){this.renderer.destroy(),this.note=null}}const Vt=p?window.AudioContext||window.webkitAudioContext:null;class Ht{constructor(){this.useEq=!1,this.useAnalyser=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],this._volume=1,this._loop=!1,this._startTime=0,this._ctxStartTime=0,this.nodeRefs=[],m()}set volume(t){this.setVolume(t)}get volume(){return this._volume}set loop(t){this._loop=t,this.source&&(this.source.loop=t)}get loop(){return this._loop}getCtx(){return this.ctx||(this.ctx=new Vt),this.ctx}setBuffer(t,e){const i=this.getCtx(),s=t.length,r=i.createBuffer(1,s,e),n=r.getChannelData(0);if(t instanceof Float32Array)n.set(t,0);else if(t instanceof Int16Array)for(let e=0;e<s;e++)n[e]=t[e]/32768;this.buffer=r,this.sampleRate=e}connectEqNodesTo(t){const e=this.getCtx(),i=this.eqSettings;let s=t;return i.forEach(([t,r],n)=>{const a=e.createBiquadFilter();this.nodeRefs.push(a),a.frequency.value=t,a.gain.value=r,0===n?a.type="lowshelf":n===i.length-1?a.type="highshelf":a.type="peaking",s.connect(a),s=a}),s}initNodes(){const t=this.getCtx();this.nodeRefs=[];const e=t.createBufferSource();this.nodeRefs.push(e),e.buffer=this.buffer;const i=t.createGain();if(this.nodeRefs.push(i),this.useEq){this.connectEqNodesTo(e).connect(i)}else e.connect(i);if(this.useAnalyser){const e=t.createAnalyser();this.nodeRefs.push(e),this.analyser=e,i.connect(e),e.connect(t.destination)}else this.analyser=void 0,i.connect(t.destination);this.source=e,this.gainNode=i,this.setVolume(this._volume)}setAnalyserEnabled(t){this.useAnalyser=t,this.initNodes()}setVolume(t){this._volume=t,this.gainNode&&(this.gainNode.gain.value=Math.pow(t,2))}playFrom(t){this.initNodes(),this._startTime=t,this._ctxStartTime=this.ctx.currentTime,this.source.loop=this._loop,this.source.start(0,t)}stop(){this.source&&this.source.stop(0)}getCurrentTime(){return this._startTime+(this.ctx.currentTime-this._ctxStartTime)}async destroy(){this.stop();const t=this.getCtx();this.nodeRefs.forEach(t=>t.disconnect()),this.nodeRefs=[],this.analyser=void 0,"closed"!==t.state&&"function"==typeof t.close&&await t.close(),this.buffer=null}}class $t{constructor(e,i,s,r={}){this.duration=0,this.autoplay=!1,this.supportedEvents=it,this._src=null,this._loop=!1,this._volume=1,this._muted=!1,this._frame=null,this._hasEnded=!1,this.isNoteLoaded=!1,this.events=new Map,this.playbackStartTime=0,this.playbackTime=0,this.playbackLoopId=null,this.showThumbnail=!0,this.hasPlaybackStarted=!1,this.isPlaying=!1,this.wasPlaying=!1,this.isSeeking=!1,this.playbackLoop=e=>{if(!this.isPlaying)return;const i=e/1e3,s=this.duration,r=this.audio.getCurrentTime();let n=i-this.playbackStartTime;if(Math.abs(n%s-r%s)>.01&&(n=r),n>=s){if(!this.loop)return this.pause(),this._hasEnded=!0,void this.emit(t.PlayerEvent.Ended);this.playbackStartTime=i,this.emit(t.PlayerEvent.Loop)}this.setCurrentTime(n%s),this.playbackLoopId=requestAnimationFrame(this.playbackLoop)},m();const n="string"==typeof e?document.querySelector(e):e;this.parserSettings=r,this.renderer=new Wt(n,i,s,{onlost:()=>this.emit(t.PlayerEvent.Error),onrestored:()=>this.load()}),this.audio=new Ht,this.el=n}get src(){return this._src}set src(t){this.load(t)}get paused(){return!this.isPlaying}set paused(t){t?this.pause():this.play()}get currentFrame(){return this._frame}set currentFrame(t){this.setCurrentFrame(t)}get currentTime(){return this.isNoteLoaded?this.playbackTime:null}set currentTime(t){this.setCurrentTime(t)}get progress(){return this.isNoteLoaded?this.playbackTime/this.duration*100:null}set progress(t){this.setProgress(t)}get volume(){return this.getVolume()}set volume(t){this.setVolume(t)}get muted(){return this.getMuted()}set muted(t){this.setMuted(t)}get loop(){return this.getLoop()}set loop(t){this.setLoop(t)}get framerate(){return this.note.framerate}get frameCount(){return this.note.frameCount}get frameSpeed(){return this.note.frameSpeed}get buffered(){return st([[0,this.duration]])}get seekable(){return st([[0,this.duration]])}get currentSrc(){return this._src}get videoWidth(){return this.isNoteLoaded?this.note.imageWidth:0}get videoHeight(){return this.isNoteLoaded?this.note.imageHeight:0}async load(e=null){return this.isNoteLoaded&&this.closeNote(),this._src=e,e?(this.emit(t.PlayerEvent.LoadStart),tt(e,this.parserSettings).then(t=>{this.openNote(t)}).catch(e=>{throw this.emit(t.PlayerEvent.Error,e),new Error("Error loading Flipnote: "+e.message)})):this.openNote(this.note)}async reload(){if(this.note)return await this.load(this.note.buffer)}async updateSettings(t){return this.parserSettings=t,await this.reload()}closeNote(){this.pause(),this.note=null,this.isNoteLoaded=!1,this.meta=null,this._src=null,this._frame=0,this.playbackTime=0,this.duration=0,this.loop=!1,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.showThumbnail=!0,this.renderer.clear()}openNote(e){this.isNoteLoaded&&this.closeNote(),this.note=e,this.meta=e.meta,this.emit(t.PlayerEvent.LoadedMeta),this.noteFormat=e.format,this.duration=e.duration,this.playbackTime=0,this._frame=0,this.isNoteLoaded=!0,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.layerVisibility=e.layerVisibility,this.showThumbnail=!0,this.audio.setBuffer(e.getAudioMasterPcm(),e.sampleRate),this.emit(t.PlayerEvent.CanPlay),this.emit(t.PlayerEvent.CanPlayThrough),this.setLoop(e.meta.loop),this.renderer.setNote(e),this.drawFrame(e.thumbFrameIndex),this.emit(t.PlayerEvent.LoadedData),this.emit(t.PlayerEvent.Load),this.emit(t.PlayerEvent.Ready),this.autoplay&&this.play()}setCurrentTime(e){this.assertNoteLoaded();const i=Math.floor(e/(1/this.framerate));this.setCurrentFrame(i),this.playbackTime=e,this.emit(t.PlayerEvent.Progress,this.progress)}getCurrentTime(){return this.currentTime}getTimeCounter(){return`${nt(Math.max(this.currentTime,0))} / ${nt(this.duration)}`}getFrameCounter(){return`${rt(this.currentFrame+1,3)} / ${rt(this.frameCount,3)}`}setProgress(t){this.assertNoteLoaded(),d(t,0,100,"progress"),this.currentTime=this.duration*(t/100)}getProgress(){return this.progress}async play(){if(this.assertNoteLoaded(),this.isPlaying)return;this._hasEnded&&(this.playbackTime=0,this._hasEnded=!1);const e=performance.now();this.playbackStartTime=e/1e3-this.playbackTime,this.isPlaying=!0,this.hasPlaybackStarted=!0,this.playAudio(),this.playbackLoop(e),this.emit(t.PlayerEvent.Play)}pause(){this.isPlaying&&(this.isPlaying=!1,null!==this.playbackLoopId&&cancelAnimationFrame(this.playbackLoopId),this.stopAudio(),this.emit(t.PlayerEvent.Pause))}togglePlay(){this.isPlaying?this.pause():this.play()}getPaused(){return!this.isPlaying}getDuration(){return this.duration}getLoop(){return this._loop}setLoop(t){this._loop=t,this.audio.loop=t}toggleLoop(){this.setLoop(!this._loop)}setCurrentFrame(e){this.assertNoteLoaded();const i=Math.max(0,Math.min(Math.floor(e),this.frameCount-1));(i!==this.currentFrame||this.showThumbnail)&&(this._frame=i,this.drawFrame(i),this.showThumbnail=!1,this.isPlaying||(this.playbackTime=i*(1/this.framerate),this.emit(t.PlayerEvent.SeekEnd)),this.emit(t.PlayerEvent.FrameUpdate,this.currentFrame),this.emit(t.PlayerEvent.Progress,this.progress),this.emit(t.PlayerEvent.TimeUpdate,this.currentFrame))}nextFrame(){this.loop&&this.currentFrame===this.frameCount-1?this.currentFrame=0:this.currentFrame+=1,this.emit(t.PlayerEvent.FrameNext)}prevFrame(){this.loop&&0===this.currentFrame?this.currentFrame=this.frameCount-1:this.currentFrame-=1,this.emit(t.PlayerEvent.FramePrev)}lastFrame(){this.currentFrame=this.frameCount-1,this.emit(t.PlayerEvent.FrameLast)}firstFrame(){this.currentFrame=0,this.emit(t.PlayerEvent.FrameFirst)}thumbnailFrame(){this.currentFrame=this.note.thumbFrameIndex}startSeek(){this.isSeeking||(this.emit(t.PlayerEvent.SeekStart),this.wasPlaying=this.isPlaying,this.pause(),this.isSeeking=!0)}seek(t){this.isSeeking&&(this.progress=100*t)}endSeek(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1}drawFrame(t){this.renderer.drawFrame(t)}forceUpdate(){this.renderer.forceUpdate()}resize(t,e){e!==.75*t&&console.warn(`Canvas width to height ratio should be 3:4 for best results (got ${t}x${e})`),this.renderer.setCanvasSize(t,e),this.forceUpdate()}setLayerVisibility(t,e){this.note.layerVisibility[t]=e,this.layerVisibility[t]=e,this.forceUpdate()}getLayerVisibility(t){return this.layerVisibility[t]}toggleLayerVisibility(t){this.setLayerVisibility(t,!this.layerVisibility[t])}playAudio(){this.audio.playFrom(this.currentTime)}stopAudio(){this.audio.stop()}toggleAudioEq(){this.setAudioEq(!this.audio.useEq)}setAudioEq(t){this.isPlaying&&(this.wasPlaying=!0,this.stopAudio()),this.audio.useEq=t,this.wasPlaying&&(this.wasPlaying=!1,this.playAudio())}mute(){this.setMuted(!0)}unmute(){this.setMuted(!1)}setMuted(e){this.audio.volume=e?0:this._volume,this._muted=e,this.emit(t.PlayerEvent.VolumeChange,this.audio.volume)}getMuted(){return 0===this.volume||this._muted}toggleMuted(){this.setMuted(!this._muted)}setVolume(e){d(e,0,1,"volume"),this._volume=e,this.audio.volume=e,this.emit(t.PlayerEvent.VolumeChange,this.audio.volume)}getVolume(){return this._muted?0:this._volume}seekToNextFrame(){this.nextFrame()}fastSeek(t){this.currentTime=t}canPlayType(t){switch(t){case"application/x-ppm":case"application/x-kwz":case"video/x-ppm":case"video/x-kwz":case"video/vnd.nintendo.ugomemo.ppm":case"video/vnd.nintendo.ugomemo.kwz":return"probably";case"application/octet-stream":return"maybe";case"video/vnd.nintendo.ugomemo.fykt":default:return""}}getVideoPlaybackQuality(){return{creationTime:0,droppedVideoFrames:0,totalVideoFrames:this.frameCount}}requestPictureInPicture(){throw new Error("Not implemented")}captureStream(){throw new Error("Not implemented")}on(t,e){const i=this.events;(Array.isArray(t)?t:[t]).forEach(t=>{i.has(t)?i.get(t).push(e):i.set(t,[e])})}off(t,e){const i=this.events;(Array.isArray(t)?t:[t]).forEach(t=>{if(!i.has(t))return;const s=i.get(t);i.set(t,s.splice(s.indexOf(e),1))})}emit(e,...i){const s=this.events;if(e!==t.PlayerEvent.__Any&&s.has(e)){s.get(e).forEach(t=>t.apply(null,i));const t="on"+e,r=this;"function"==typeof r[t]&&r[t].apply(null,i)}if(s.has(t.PlayerEvent.__Any)){s.get(t.PlayerEvent.__Any).forEach(t=>t.apply(null,[e,...i]))}}clearEvents(){this.events.clear()}async destroy(){this.clearEvents(),this.emit(t.PlayerEvent.Destroy),this.closeNote(),await this.renderer.destroy(),await this.audio.destroy()}supports(t){const e=this.supportedEvents.includes(t),i="function"==typeof this[t];return e||i}assertNoteLoaded(){c(this.isNoteLoaded,"No Flipnote is currently loaded in this player")}}function jt(t){class e extends t{get renderer(){return this.player.renderer}get audio(){return this.player.audio}get canvasEl(){return this.player.canvasEl}get note(){return this.player.note}get noteFormat(){return this.player.noteFormat}get meta(){return this.player.meta}get duration(){return this.player.duration}get layerVisibility(){return this.player.layerVisibility}get autoplay(){return this.player.autoplay}set autoplay(t){this.player.autoplay=t}}for(let i of Reflect.ownKeys($t.prototype)){let s=Object.getOwnPropertyDescriptor($t.prototype,i);i in t.prototype||"constructor"===i||"name"===i||"prototype"===i||(s.value&&"function"==typeof s.value?Object.defineProperty(e.prototype,i,Object.assign(Object.assign({},s),{value:function(...t){return this.player[i](...t)}})):(s.get||s.set)&&Object.defineProperty(e.prototype,i,Object.assign(Object.assign({},s),{set:function(t){this.player[i]=t},get:function(){return this.player[i]}})))}return e}class qt{constructor(){this.dataUrl=null}getBuffer(){return y(),Buffer.from(this.getArrayBuffer())}getBlob(){return m(),new Blob([this.getArrayBuffer()],{type:this.mimeType})}getUrl(){return m(),this.dataUrl?this.dataUrl:window.URL.createObjectURL(this.getBlob())}revokeUrl(){m(),this.dataUrl&&window.URL.revokeObjectURL(this.dataUrl)}}const Kt=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];class Gt{constructor(t,e,i){this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=e,this.colorDepth=i,this.reset()}reset(){this.initCodeSize=Math.max(2,this.colorDepth),this.accum.fill(0),this.htab.fill(0),this.codetab.fill(0),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0}char_out(t,e){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(e)}cl_block(t){this.cl_hash(5003),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)}cl_hash(t){for(var e=0;e<t;++e)this.htab[e]=-1}compress(t,e){var i,s,r,n,a,o;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,n=this.nextPixel(),o=0,i=5003;i<65536;i*=2)++o;o=8-o,this.cl_hash(5003),this.output(this.ClearCode,e);t:for(;-1!=(s=this.nextPixel());)if(i=(s<<12)+n,r=s<<o^n,this.htab[r]!==i){if(this.htab[r]>=0){a=5003-r,0===r&&(a=1);do{if((r-=a)<0&&(r+=5003),this.htab[r]===i){n=this.codetab[r];continue t}}while(this.htab[r]>=0)}this.output(n,e),n=s,this.free_ent<4096?(this.codetab[r]=this.free_ent++,this.htab[r]=i):this.cl_block(e)}else n=this.codetab[r];this.output(n,e),this.output(this.EOFCode,e)}encode(t,e){this.pixels=t,e.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,e),e.writeByte(0)}flush_char(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)}get_maxcode(t){return(1<<t)-1}nextPixel(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])}output(t,e){for(this.cur_accum&=Kt[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(e)}}}class Xt extends qt{constructor(t,i,s={}){super(),this.mimeType="gif/image",this.frameCount=0,this.width=t,this.height=i,this.data=new e,this.settings=Object.assign(Object.assign({},Xt.defaultSettings),s),this.compressor=new Gt(t,i,s.colorDepth)}static fromFlipnote(t,e={}){var i;const s=new Xt(t.imageWidth,t.imageHeight,Object.assign({delay:100/t.framerate,repeat:(null===(i=t.meta)||void 0===i?void 0:i.loop)?-1:0},e));s.palette=t.globalPalette;for(let e=0;e<t.frameCount;e++)s.writeFrame(t.getFramePixels(e));return s.finish(),s}static fromFlipnoteFrame(t,e,i={}){const s=new Xt(t.imageWidth,t.imageHeight,Object.assign({delay:0,repeat:0},i));return s.palette=t.globalPalette,s.writeFrame(t.getFramePixels(e)),s.finish(),s}writeFrame(t){0===this.frameCount?this.writeFirstFrame(t):this.writeAdditionalFrame(t),this.frameCount+=1}finish(){this.data.writeByte(59)}writeFirstFrame(t){this.writeHeader(),this.writeLogicalScreenDescriptor(),this.writeColorTable(),this.writeNetscapeExt(),this.writeGraphicControlExt(),this.writeImageDescriptor(),this.writePixels(t)}writeAdditionalFrame(t){this.writeGraphicControlExt(),this.writeImageDescriptor(),this.writePixels(t)}writeHeader(){this.data.writeChars("GIF89a")}writeGraphicControlExt(){this.data.writeByte(33),this.data.writeByte(249),this.data.writeByte(4),this.data.writeByte(0),this.data.writeU16(this.settings.delay),this.data.writeByte(0),this.data.writeByte(0)}writeLogicalScreenDescriptor(){const t=this.palette,e=128|this.settings.colorDepth-1<<4|this.colorTableSize(t.length)-1;this.data.writeU16(this.width),this.data.writeU16(this.height),this.data.writeBytes([e,0,0])}writeNetscapeExt(){this.data.writeByte(33),this.data.writeByte(255),this.data.writeByte(11),this.data.writeChars("NETSCAPE2.0"),this.data.writeByte(3),this.data.writeByte(1),this.data.writeU16(this.settings.repeat),this.data.writeByte(0)}writeColorTable(){const t=this.palette,e=1<<this.colorTableSize(t.length);for(let i=0;i<e;i++){let e=[0,0,0];i<t.length&&(e=t[i]),this.data.writeByte(e[0]),this.data.writeByte(e[1]),this.data.writeByte(e[2])}}writeImageDescriptor(){this.data.writeByte(44),this.data.writeU16(0),this.data.writeU16(0),this.data.writeU16(this.width),this.data.writeU16(this.height),this.data.writeByte(0)}colorTableSize(t){return Math.max(Math.ceil(Math.log2(t)),1)}writePixels(t){this.compressor.colorDepth=this.settings.colorDepth,this.compressor.reset(),this.compressor.encode(t,this.data)}getArrayBuffer(){return this.data.getBuffer()}getImage(){m();const t=new Image(this.width,this.height);return t.src=this.getUrl(),t}}Xt.defaultSettings={delay:100,repeat:-1,colorDepth:8};class Yt extends qt{constructor(t,e=1,s=16){super(),this.sampleRate=t,this.channels=e,this.bitsPerSample=s;const r=new ArrayBuffer(44),n=new i(r);n.writeChars("RIFF"),n.writeUint32(0),n.writeChars("WAVE"),n.writeChars("fmt "),n.writeUint32(16),n.writeUint16(1),n.writeUint16(this.channels),n.writeUint32(this.sampleRate),n.writeUint32(this.sampleRate*this.bitsPerSample*this.channels/8),n.writeUint16(this.bitsPerSample*this.channels/8),n.writeUint16(this.bitsPerSample),n.writeChars("data"),n.writeUint32(0),this.header=n,this.pcmData=null}static fromFlipnote(t){const e=t.sampleRate,i=new Yt(e,1,16),s=t.getAudioMasterPcm(e);return i.writeSamples(s),i}static fromFlipnoteTrack(t,e){const i=t.sampleRate,s=new Yt(i,1,16),r=t.getAudioTrackPcm(e,i);return s.writeSamples(r),s}writeSamples(t){let e=this.header;e.seek(4),e.writeUint32(e.byteLength+t.byteLength),e.seek(40),e.writeUint32(t.byteLength),this.pcmData=t}getArrayBuffer(){const t=this.header.bytes,e=new Uint8Array(this.pcmData.buffer),i=new Uint8Array(this.header.byteLength+this.pcmData.byteLength);return i.set(t),i.set(e,t.byteLength),i.buffer}}function Qt(t,e,i,s){for(var r,n=arguments.length,a=n<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s,o=t.length-1;o>=0;o--)(r=t[o])&&(a=(n<3?r(a):n>3?r(e,i,a):r(e,i))||a);return n>3&&a&&Object.defineProperty(e,i,a),a}const Jt="undefined"!=typeof window&&null!=window.customElements&&void 0!==window.customElements.polyfillWrapFlushCallback,Zt=(t,e,i=null)=>{for(;e!==i;){const i=e.nextSibling;t.removeChild(e),e=i}},te=`{{lit-${String(Math.random()).slice(2)}}}`,ee=`\x3c!--${te}--\x3e`,ie=new RegExp(`${te}|${ee}`);class se{constructor(t,e){this.parts=[],this.element=e;const i=[],s=[],r=document.createTreeWalker(e.content,133,null,!1);let n=0,a=-1,o=0;const{strings:h,values:{length:l}}=t;for(;o<l;){const t=r.nextNode();if(null!==t){if(a++,1===t.nodeType){if(t.hasAttributes()){const e=t.attributes,{length:i}=e;let s=0;for(let t=0;t<i;t++)re(e[t].name,"$lit$")&&s++;for(;s-- >0;){const e=h[o],i=oe.exec(e)[2],s=i.toLowerCase()+"$lit$",r=t.getAttribute(s);t.removeAttribute(s);const n=r.split(ie);this.parts.push({type:"attribute",index:a,name:i,strings:n}),o+=n.length-1}}"TEMPLATE"===t.tagName&&(s.push(t),r.currentNode=t.content)}else if(3===t.nodeType){const e=t.data;if(e.indexOf(te)>=0){const s=t.parentNode,r=e.split(ie),n=r.length-1;for(let e=0;e<n;e++){let i,n=r[e];if(""===n)i=ae();else{const t=oe.exec(n);null!==t&&re(t[2],"$lit$")&&(n=n.slice(0,t.index)+t[1]+t[2].slice(0,-"$lit$".length)+t[3]),i=document.createTextNode(n)}s.insertBefore(i,t),this.parts.push({type:"node",index:++a})}""===r[n]?(s.insertBefore(ae(),t),i.push(t)):t.data=r[n],o+=n}}else if(8===t.nodeType)if(t.data===te){const e=t.parentNode;null!==t.previousSibling&&a!==n||(a++,e.insertBefore(ae(),t)),n=a,this.parts.push({type:"node",index:a}),null===t.nextSibling?t.data="":(i.push(t),a--),o++}else{let e=-1;for(;-1!==(e=t.data.indexOf(te,e+1));)this.parts.push({type:"node",index:-1}),o++}}else r.currentNode=s.pop()}for(const t of i)t.parentNode.removeChild(t)}}const re=(t,e)=>{const i=t.length-e.length;return i>=0&&t.slice(i)===e},ne=t=>-1!==t.index,ae=()=>document.createComment(""),oe=/([ \x09\x0a\x0c\x0d])([^\0-\x1F\x7F-\x9F "'>=/]+)([ \x09\x0a\x0c\x0d]*=[ \x09\x0a\x0c\x0d]*(?:[^ \x09\x0a\x0c\x0d"'`<>=]*|"[^"]*|'[^']*))$/;function he(t,e){const{element:{content:i},parts:s}=t,r=document.createTreeWalker(i,133,null,!1);let n=ce(s),a=s[n],o=-1,h=0;const l=[];let c=null;for(;r.nextNode();){o++;const t=r.currentNode;for(t.previousSibling===c&&(c=null),e.has(t)&&(l.push(t),null===c&&(c=t)),null!==c&&h++;void 0!==a&&a.index===o;)a.index=null!==c?-1:a.index-h,n=ce(s,n),a=s[n]}l.forEach(t=>t.parentNode.removeChild(t))}const le=t=>{let e=11===t.nodeType?0:1;const i=document.createTreeWalker(t,133,null,!1);for(;i.nextNode();)e++;return e},ce=(t,e=-1)=>{for(let i=e+1;i<t.length;i++){const e=t[i];if(ne(e))return i}return-1};const de=new WeakMap,ue=t=>(...e)=>{const i=t(...e);return de.set(i,!0),i},fe=t=>"function"==typeof t&&de.has(t),pe={},me={};class ge{constructor(t,e,i){this.__parts=[],this.template=t,this.processor=e,this.options=i}update(t){let e=0;for(const i of this.__parts)void 0!==i&&i.setValue(t[e]),e++;for(const t of this.__parts)void 0!==t&&t.commit()}_clone(){const t=Jt?this.template.element.content.cloneNode(!0):document.importNode(this.template.element.content,!0),e=[],i=this.template.parts,s=document.createTreeWalker(t,133,null,!1);let r,n=0,a=0,o=s.nextNode();for(;n<i.length;)if(r=i[n],ne(r)){for(;a<r.index;)a++,"TEMPLATE"===o.nodeName&&(e.push(o),s.currentNode=o.content),null===(o=s.nextNode())&&(s.currentNode=e.pop(),o=s.nextNode());if("node"===r.type){const t=this.processor.handleTextExpression(this.options);t.insertAfterNode(o.previousSibling),this.__parts.push(t)}else this.__parts.push(...this.processor.handleAttributeExpressions(o,r.name,r.strings,this.options));n++}else this.__parts.push(void 0),n++;return Jt&&(document.adoptNode(t),customElements.upgrade(t)),t}}const ye=window.trustedTypes&&trustedTypes.createPolicy("lit-html",{createHTML:t=>t}),ve=` ${te} `;class be{constructor(t,e,i,s){this.strings=t,this.values=e,this.type=i,this.processor=s}getHTML(){const t=this.strings.length-1;let e="",i=!1;for(let s=0;s<t;s++){const t=this.strings[s],r=t.lastIndexOf("\x3c!--");i=(r>-1||i)&&-1===t.indexOf("--\x3e",r+1);const n=oe.exec(t);e+=null===n?t+(i?ve:ee):t.substr(0,n.index)+n[1]+n[2]+"$lit$"+n[3]+te}return e+=this.strings[t],e}getTemplateElement(){const t=document.createElement("template");let e=this.getHTML();return void 0!==ye&&(e=ye.createHTML(e)),t.innerHTML=e,t}}const Se=t=>null===t||!("object"==typeof t||"function"==typeof t),we=t=>Array.isArray(t)||!(!t||!t[Symbol.iterator]);class _e{constructor(t,e,i){this.dirty=!0,this.element=t,this.name=e,this.strings=i,this.parts=[];for(let t=0;t<i.length-1;t++)this.parts[t]=this._createPart()}_createPart(){return new Ee(this)}_getValue(){const t=this.strings,e=t.length-1,i=this.parts;if(1===e&&""===t[0]&&""===t[1]){const t=i[0].value;if("symbol"==typeof t)return String(t);if("string"==typeof t||!we(t))return t}let s="";for(let r=0;r<e;r++){s+=t[r];const e=i[r];if(void 0!==e){const t=e.value;if(Se(t)||!we(t))s+="string"==typeof t?t:String(t);else for(const e of t)s+="string"==typeof e?e:String(e)}}return s+=t[e],s}commit(){this.dirty&&(this.dirty=!1,this.element.setAttribute(this.name,this._getValue()))}}class Ee{constructor(t){this.value=void 0,this.committer=t}setValue(t){t===pe||Se(t)&&t===this.value||(this.value=t,fe(t)||(this.committer.dirty=!0))}commit(){for(;fe(this.value);){const t=this.value;this.value=pe,t(this)}this.value!==pe&&this.committer.commit()}}class xe{constructor(t){this.value=void 0,this.__pendingValue=void 0,this.options=t}appendInto(t){this.startNode=t.appendChild(ae()),this.endNode=t.appendChild(ae())}insertAfterNode(t){this.startNode=t,this.endNode=t.nextSibling}appendIntoPart(t){t.__insert(this.startNode=ae()),t.__insert(this.endNode=ae())}insertAfterPart(t){t.__insert(this.startNode=ae()),this.endNode=t.endNode,t.endNode=this.startNode}setValue(t){this.__pendingValue=t}commit(){if(null===this.startNode.parentNode)return;for(;fe(this.__pendingValue);){const t=this.__pendingValue;this.__pendingValue=pe,t(this)}const t=this.__pendingValue;t!==pe&&(Se(t)?t!==this.value&&this.__commitText(t):t instanceof be?this.__commitTemplateResult(t):t instanceof Node?this.__commitNode(t):we(t)?this.__commitIterable(t):t===me?(this.value=me,this.clear()):this.__commitText(t))}__insert(t){this.endNode.parentNode.insertBefore(t,this.endNode)}__commitNode(t){this.value!==t&&(this.clear(),this.__insert(t),this.value=t)}__commitText(t){const e=this.startNode.nextSibling,i="string"==typeof(t=null==t?"":t)?t:String(t);e===this.endNode.previousSibling&&3===e.nodeType?e.data=i:this.__commitNode(document.createTextNode(i)),this.value=t}__commitTemplateResult(t){const e=this.options.templateFactory(t);if(this.value instanceof ge&&this.value.template===e)this.value.update(t.values);else{const i=new ge(e,t.processor,this.options),s=i._clone();i.update(t.values),this.__commitNode(s),this.value=i}}__commitIterable(t){Array.isArray(this.value)||(this.value=[],this.clear());const e=this.value;let i,s=0;for(const r of t)i=e[s],void 0===i&&(i=new xe(this.options),e.push(i),0===s?i.appendIntoPart(this):i.insertAfterPart(e[s-1])),i.setValue(r),i.commit(),s++;s<e.length&&(e.length=s,this.clear(i&&i.endNode))}clear(t=this.startNode){Zt(this.startNode.parentNode,t.nextSibling,this.endNode)}}class Pe{constructor(t,e,i){if(this.value=void 0,this.__pendingValue=void 0,2!==i.length||""!==i[0]||""!==i[1])throw new Error("Boolean attributes can only contain a single expression");this.element=t,this.name=e,this.strings=i}setValue(t){this.__pendingValue=t}commit(){for(;fe(this.__pendingValue);){const t=this.__pendingValue;this.__pendingValue=pe,t(this)}if(this.__pendingValue===pe)return;const t=!!this.__pendingValue;this.value!==t&&(t?this.element.setAttribute(this.name,""):this.element.removeAttribute(this.name),this.value=t),this.__pendingValue=pe}}class Ae extends _e{constructor(t,e,i){super(t,e,i),this.single=2===i.length&&""===i[0]&&""===i[1]}_createPart(){return new Fe(this)}_getValue(){return this.single?this.parts[0].value:super._getValue()}commit(){this.dirty&&(this.dirty=!1,this.element[this.name]=this._getValue())}}class Fe extends Ee{}let Ce=!1;(()=>{try{const t={get capture(){return Ce=!0,!1}};window.addEventListener("test",t,t),window.removeEventListener("test",t,t)}catch(t){}})();class Te{constructor(t,e,i){this.value=void 0,this.__pendingValue=void 0,this.element=t,this.eventName=e,this.eventContext=i,this.__boundHandleEvent=t=>this.handleEvent(t)}setValue(t){this.__pendingValue=t}commit(){for(;fe(this.__pendingValue);){const t=this.__pendingValue;this.__pendingValue=pe,t(this)}if(this.__pendingValue===pe)return;const t=this.__pendingValue,e=this.value,i=null==t||null!=e&&(t.capture!==e.capture||t.once!==e.once||t.passive!==e.passive),s=null!=t&&(null==e||i);i&&this.element.removeEventListener(this.eventName,this.__boundHandleEvent,this.__options),s&&(this.__options=ke(t),this.element.addEventListener(this.eventName,this.__boundHandleEvent,this.__options)),this.value=t,this.__pendingValue=pe}handleEvent(t){"function"==typeof this.value?this.value.call(this.eventContext||this.element,t):this.value.handleEvent(t)}}const ke=t=>t&&(Ce?{capture:t.capture,passive:t.passive,once:t.once}:t.capture);function Ue(t){let e=Be.get(t.type);void 0===e&&(e={stringsArray:new WeakMap,keyString:new Map},Be.set(t.type,e));let i=e.stringsArray.get(t.strings);if(void 0!==i)return i;const s=t.strings.join(te);return i=e.keyString.get(s),void 0===i&&(i=new se(t,t.getTemplateElement()),e.keyString.set(s,i)),e.stringsArray.set(t.strings,i),i}const Be=new Map,Le=new WeakMap;const Ie=new class{handleAttributeExpressions(t,e,i,s){const r=e[0];if("."===r){return new Ae(t,e.slice(1),i).parts}if("@"===r)return[new Te(t,e.slice(1),s.eventContext)];if("?"===r)return[new Pe(t,e.slice(1),i)];return new _e(t,e,i).parts}handleTextExpression(t){return new xe(t)}};"undefined"!=typeof window&&(window.litHtmlVersions||(window.litHtmlVersions=[])).push("1.4.1");const Ne=(t,...e)=>new be(t,e,"html",Ie),Me=(t,e)=>`${t}--${e}`;let Re=!0;void 0===window.ShadyCSS?Re=!1:void 0===window.ShadyCSS.prepareTemplateDom&&(console.warn("Incompatible ShadyCSS version detected. Please update to at least @webcomponents/webcomponentsjs@2.0.2 and @webcomponents/shadycss@1.3.1."),Re=!1);const ze=t=>e=>{const i=Me(e.type,t);let s=Be.get(i);void 0===s&&(s={stringsArray:new WeakMap,keyString:new Map},Be.set(i,s));let r=s.stringsArray.get(e.strings);if(void 0!==r)return r;const n=e.strings.join(te);if(r=s.keyString.get(n),void 0===r){const i=e.getTemplateElement();Re&&window.ShadyCSS.prepareTemplateDom(i,t),r=new se(e,i),s.keyString.set(n,r)}return s.stringsArray.set(e.strings,r),r},Oe=["html","svg"],De=new Set,We=(t,e,i)=>{De.add(t);const s=i?i.element:document.createElement("template"),r=e.querySelectorAll("style"),{length:n}=r;if(0===n)return void window.ShadyCSS.prepareTemplateStyles(s,t);const a=document.createElement("style");for(let t=0;t<n;t++){const e=r[t];e.parentNode.removeChild(e),a.textContent+=e.textContent}(t=>{Oe.forEach(e=>{const i=Be.get(Me(e,t));void 0!==i&&i.keyString.forEach(t=>{const{element:{content:e}}=t,i=new Set;Array.from(e.querySelectorAll("style")).forEach(t=>{i.add(t)}),he(t,i)})})})(t);const o=s.content;i?function(t,e,i=null){const{element:{content:s},parts:r}=t;if(null==i)return void s.appendChild(e);const n=document.createTreeWalker(s,133,null,!1);let a=ce(r),o=0,h=-1;for(;n.nextNode();){h++;for(n.currentNode===i&&(o=le(e),i.parentNode.insertBefore(e,i));-1!==a&&r[a].index===h;){if(o>0){for(;-1!==a;)r[a].index+=o,a=ce(r,a);return}a=ce(r,a)}}}(i,a,o.firstChild):o.insertBefore(a,o.firstChild),window.ShadyCSS.prepareTemplateStyles(s,t);const h=o.querySelector("style");if(window.ShadyCSS.nativeShadow&&null!==h)e.insertBefore(h.cloneNode(!0),e.firstChild);else if(i){o.insertBefore(a,o.firstChild);const t=new Set;t.add(a),he(i,t)}};window.JSCompiler_renameProperty=(t,e)=>t;const Ve={toAttribute(t,e){switch(e){case Boolean:return t?"":null;case Object:case Array:return null==t?t:JSON.stringify(t)}return t},fromAttribute(t,e){switch(e){case Boolean:return null!==t;case Number:return null===t?null:Number(t);case Object:case Array:return JSON.parse(t)}return t}},He=(t,e)=>e!==t&&(e==e||t==t),$e={attribute:!0,type:String,converter:Ve,reflect:!1,hasChanged:He};class je extends HTMLElement{constructor(){super(),this.initialize()}static get observedAttributes(){this.finalize();const t=[];return this._classProperties.forEach((e,i)=>{const s=this._attributeNameForProperty(i,e);void 0!==s&&(this._attributeToPropertyMap.set(s,i),t.push(s))}),t}static _ensureClassProperties(){if(!this.hasOwnProperty(JSCompiler_renameProperty("_classProperties",this))){this._classProperties=new Map;const t=Object.getPrototypeOf(this)._classProperties;void 0!==t&&t.forEach((t,e)=>this._classProperties.set(e,t))}}static createProperty(t,e=$e){if(this._ensureClassProperties(),this._classProperties.set(t,e),e.noAccessor||this.prototype.hasOwnProperty(t))return;const i="symbol"==typeof t?Symbol():"__"+t,s=this.getPropertyDescriptor(t,i,e);void 0!==s&&Object.defineProperty(this.prototype,t,s)}static getPropertyDescriptor(t,e,i){return{get(){return this[e]},set(s){const r=this[t];this[e]=s,this.requestUpdateInternal(t,r,i)},configurable:!0,enumerable:!0}}static getPropertyOptions(t){return this._classProperties&&this._classProperties.get(t)||$e}static finalize(){const t=Object.getPrototypeOf(this);if(t.hasOwnProperty("finalized")||t.finalize(),this.finalized=!0,this._ensureClassProperties(),this._attributeToPropertyMap=new Map,this.hasOwnProperty(JSCompiler_renameProperty("properties",this))){const t=this.properties,e=[...Object.getOwnPropertyNames(t),..."function"==typeof Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(t):[]];for(const i of e)this.createProperty(i,t[i])}}static _attributeNameForProperty(t,e){const i=e.attribute;return!1===i?void 0:"string"==typeof i?i:"string"==typeof t?t.toLowerCase():void 0}static _valueHasChanged(t,e,i=He){return i(t,e)}static _propertyValueFromAttribute(t,e){const i=e.type,s=e.converter||Ve,r="function"==typeof s?s:s.fromAttribute;return r?r(t,i):t}static _propertyValueToAttribute(t,e){if(void 0===e.reflect)return;const i=e.type,s=e.converter;return(s&&s.toAttribute||Ve.toAttribute)(t,i)}initialize(){this._updateState=0,this._updatePromise=new Promise(t=>this._enableUpdatingResolver=t),this._changedProperties=new Map,this._saveInstanceProperties(),this.requestUpdateInternal()}_saveInstanceProperties(){this.constructor._classProperties.forEach((t,e)=>{if(this.hasOwnProperty(e)){const t=this[e];delete this[e],this._instanceProperties||(this._instanceProperties=new Map),this._instanceProperties.set(e,t)}})}_applyInstanceProperties(){this._instanceProperties.forEach((t,e)=>this[e]=t),this._instanceProperties=void 0}connectedCallback(){this.enableUpdating()}enableUpdating(){void 0!==this._enableUpdatingResolver&&(this._enableUpdatingResolver(),this._enableUpdatingResolver=void 0)}disconnectedCallback(){}attributeChangedCallback(t,e,i){e!==i&&this._attributeToProperty(t,i)}_propertyToAttribute(t,e,i=$e){const s=this.constructor,r=s._attributeNameForProperty(t,i);if(void 0!==r){const t=s._propertyValueToAttribute(e,i);if(void 0===t)return;this._updateState=8|this._updateState,null==t?this.removeAttribute(r):this.setAttribute(r,t),this._updateState=-9&this._updateState}}_attributeToProperty(t,e){if(8&this._updateState)return;const i=this.constructor,s=i._attributeToPropertyMap.get(t);if(void 0!==s){const t=i.getPropertyOptions(s);this._updateState=16|this._updateState,this[s]=i._propertyValueFromAttribute(e,t),this._updateState=-17&this._updateState}}requestUpdateInternal(t,e,i){let s=!0;if(void 0!==t){const r=this.constructor;i=i||r.getPropertyOptions(t),r._valueHasChanged(this[t],e,i.hasChanged)?(this._changedProperties.has(t)||this._changedProperties.set(t,e),!0!==i.reflect||16&this._updateState||(void 0===this._reflectingProperties&&(this._reflectingProperties=new Map),this._reflectingProperties.set(t,i))):s=!1}!this._hasRequestedUpdate&&s&&(this._updatePromise=this._enqueueUpdate())}requestUpdate(t,e){return this.requestUpdateInternal(t,e),this.updateComplete}async _enqueueUpdate(){this._updateState=4|this._updateState;try{await this._updatePromise}catch(t){}const t=this.performUpdate();return null!=t&&await t,!this._hasRequestedUpdate}get _hasRequestedUpdate(){return 4&this._updateState}get hasUpdated(){return 1&this._updateState}performUpdate(){if(!this._hasRequestedUpdate)return;this._instanceProperties&&this._applyInstanceProperties();let t=!1;const e=this._changedProperties;try{t=this.shouldUpdate(e),t?this.update(e):this._markUpdated()}catch(e){throw t=!1,this._markUpdated(),e}t&&(1&this._updateState||(this._updateState=1|this._updateState,this.firstUpdated(e)),this.updated(e))}_markUpdated(){this._changedProperties=new Map,this._updateState=-5&this._updateState}get updateComplete(){return this._getUpdateComplete()}_getUpdateComplete(){return this._updatePromise}shouldUpdate(t){return!0}update(t){void 0!==this._reflectingProperties&&this._reflectingProperties.size>0&&(this._reflectingProperties.forEach((t,e)=>this._propertyToAttribute(e,this[e],t)),this._reflectingProperties=void 0),this._markUpdated()}updated(t){}firstUpdated(t){}}je.finalized=!0;const qe=t=>e=>"function"==typeof e?((t,e)=>(window.customElements.define(t,e),e))(t,e):((t,e)=>{const{kind:i,elements:s}=e;return{kind:i,elements:s,finisher(e){window.customElements.define(t,e)}}})(t,e),Ke=(t,e)=>"method"===e.kind&&e.descriptor&&!("value"in e.descriptor)?Object.assign(Object.assign({},e),{finisher(i){i.createProperty(e.key,t)}}):{kind:"field",key:Symbol(),placement:"own",descriptor:{},initializer(){"function"==typeof e.initializer&&(this[e.key]=e.initializer.call(this))},finisher(i){i.createProperty(e.key,t)}};function Ge(t){return(e,i)=>void 0!==i?((t,e,i)=>{e.constructor.createProperty(i,t)})(t,e,i):Ke(t,e)}function Xe(t){return Ge({attribute:!1,hasChanged:null==t?void 0:t.hasChanged})}function Ye(t,e){return(i,s)=>{const r={get(){return this.renderRoot.querySelector(t)},enumerable:!0,configurable:!0};if(e){const e="symbol"==typeof s?Symbol():"__"+s;r.get=function(){return void 0===this[e]&&(this[e]=this.renderRoot.querySelector(t)),this[e]}}return void 0!==s?Qe(r,i,s):Je(r,i)}}const Qe=(t,e,i)=>{Object.defineProperty(e,i,t)},Je=(t,e)=>({kind:"method",placement:"prototype",key:e.key,descriptor:t}),Ze=window.ShadowRoot&&(void 0===window.ShadyCSS||window.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,ti=Symbol();class ei{constructor(t,e){if(e!==ti)throw new Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=t}get styleSheet(){return void 0===this._styleSheet&&(Ze?(this._styleSheet=new CSSStyleSheet,this._styleSheet.replaceSync(this.cssText)):this._styleSheet=null),this._styleSheet}toString(){return this.cssText}}const ii=(t,...e)=>{const i=e.reduce((e,i,s)=>e+(t=>{if(t instanceof ei)return t.cssText;if("number"==typeof t)return t;throw new Error(`Value passed to 'css' function must be a 'css' function result: ${t}. Use 'unsafeCSS' to pass non-literal values, but\n            take care to ensure page security.`)})(i)+t[s+1],t[0]);return new ei(i,ti)};(window.litElementVersions||(window.litElementVersions=[])).push("2.4.0");const si={};class ri extends je{static getStyles(){return this.styles}static _getUniqueStyles(){if(this.hasOwnProperty(JSCompiler_renameProperty("_styles",this)))return;const t=this.getStyles();if(Array.isArray(t)){const e=(t,i)=>t.reduceRight((t,i)=>Array.isArray(i)?e(i,t):(t.add(i),t),i),i=e(t,new Set),s=[];i.forEach(t=>s.unshift(t)),this._styles=s}else this._styles=void 0===t?[]:[t];this._styles=this._styles.map(t=>{if(t instanceof CSSStyleSheet&&!Ze){const e=Array.prototype.slice.call(t.cssRules).reduce((t,e)=>t+e.cssText,"");return new ei(String(e),ti)}return t})}initialize(){super.initialize(),this.constructor._getUniqueStyles(),this.renderRoot=this.createRenderRoot(),window.ShadowRoot&&this.renderRoot instanceof window.ShadowRoot&&this.adoptStyles()}createRenderRoot(){return this.attachShadow({mode:"open"})}adoptStyles(){const t=this.constructor._styles;0!==t.length&&(void 0===window.ShadyCSS||window.ShadyCSS.nativeShadow?Ze?this.renderRoot.adoptedStyleSheets=t.map(t=>t instanceof CSSStyleSheet?t:t.styleSheet):this._needsShimAdoptedStyleSheets=!0:window.ShadyCSS.ScopingShim.prepareAdoptedCssText(t.map(t=>t.cssText),this.localName))}connectedCallback(){super.connectedCallback(),this.hasUpdated&&void 0!==window.ShadyCSS&&window.ShadyCSS.styleElement(this)}update(t){const e=this.render();super.update(t),e!==si&&this.constructor.render(e,this.renderRoot,{scopeName:this.localName,eventContext:this}),this._needsShimAdoptedStyleSheets&&(this._needsShimAdoptedStyleSheets=!1,this.constructor._styles.forEach(t=>{const e=document.createElement("style");e.textContent=t.cssText,this.renderRoot.appendChild(e)}))}render(){return si}}ri.finalized=!0,ri.render=(t,e,i)=>{if(!i||"object"!=typeof i||!i.scopeName)throw new Error("The `scopeName` option is required.");const s=i.scopeName,r=Le.has(e),n=Re&&11===e.nodeType&&!!e.host,a=n&&!De.has(s),o=a?document.createDocumentFragment():e;if(((t,e,i)=>{let s=Le.get(e);void 0===s&&(Zt(e,e.firstChild),Le.set(e,s=new xe(Object.assign({templateFactory:Ue},i))),s.appendInto(e)),s.setValue(t),s.commit()})(t,o,Object.assign({templateFactory:ze(s)},i)),a){const t=Le.get(o);Le.delete(o);const i=t.value instanceof ge?t.value.template:void 0;We(s,o,i),Zt(e,e.firstChild),e.appendChild(o),Le.set(e,t)}!r&&n&&window.ShadyCSS.styleElement(e.host)};let ni=class extends(jt(ri)){constructor(){super(),this._width="auto",this._cssWidth="auto",this._progress=0,this._counter="",this._isLoading=!1,this._isError=!1,this._isPlaying=!1,this._isMuted=!1,this._volumeLevel=0,this._isPlayerAvailable=!1,this.handleResize=t=>{this.updateCanvasSize()},this.handleKeyInput=t=>{switch(t.preventDefault(),t.key.toLowerCase()){case" ":this.togglePlay();break;case"a":case"arrowleft":t.shiftKey?this.firstFrame():this.prevFrame();break;case"d":case"arrowright":t.shiftKey?this.lastFrame():this.nextFrame()}},this.handlePlayToggle=t=>{this.focus(),this.togglePlay()},this.handleMuteToggle=t=>{this.focus(),this.toggleMuted()},this.handleProgressSliderChange=t=>{this.focus(),this.seek(t.detail.value)},this.handleProgressSliderInputStart=()=>{this.focus(),this.startSeek()},this.handleProgressSliderInputEnd=()=>{this.focus(),this.endSeek()},this.handleVolumeBarChange=t=>{this.focus(),this.setVolume(t.detail.value)},this._resizeObserver=new ResizeObserver(this.handleResize)}static get styles(){return ii`:host{display:inline-block}.Player{display:inline-block;position:relative;font-family:var(--flipnote-player-font-family,sans-serif)}.CanvasArea{position:relative}.PlayerCanvas{position:relative;display:block}.Overlay{position:absolute;top:0;left:0;background:#ebf0f3;color:#4b4c53;width:100%;height:100%;display:flex;justify-content:center;align-items:center}.Overlay--error{background:#ff8b8b;color:#ca2a32}@keyframes spin{from{transform:rotateZ(0)}to{transform:rotateZ(360deg)}}.LoaderIcon{animation:spin infinite 1.2s linear}.Controls{background:var(--flipnote-player-controls-background,none)}.MuteIcon{width:28px;height:28px}.Controls__groupLeft,.Controls__groupRight,.Controls__row{display:flex;align-items:center}.Controls__groupLeft{margin-right:auto}.Controls__groupRight{margin-left:auto}.Controls__playButton{height:32px;width:32px;padding:2px}.MuteIcon{width:28px;height:28px}.LoaderIcon{width:40px;height:40px}.Controls.Controls--compact{margin:6px 0}.Controls__frameCounter{min-width:90px;font-variant-numeric:tabular-nums}.Controls__progressBar{flex:1}.Controls--compact .Controls__playButton{margin-right:8px}.Controls--compact .Controls__progressBar{flex:1}.Controls--default .Controls__playButton{margin-right:8px}.Controls--default .Controls__volumeBar{width:70px;margin-left:8px}.Button{border:0;padding:0;outline:0;-webkit-appearance:none;display:block;font-family:inherit;font-size:inherit;text-align:center;cursor:pointer;background:var(--flipnote-player-button-background,#ffd3a6);color:var(--flipnote-player-button-color,#f36a2d);border-radius:4px}.Button flipnote-player-icon{display:block}`}get width(){return this._width}set width(t){const e=this._width;var i;this._width=t,this._cssWidth=isNaN(+t)?t:t+"px",i=()=>this.updateCanvasSize(),p?b(()=>b(()=>i())):i(),this.requestUpdate("width",e)}get src(){return this._playerSrc}set src(t){const e=this._playerSrc;this._isPlayerAvailable&&(this.player.src=t),this._playerSrc=t,this.requestUpdate("src",e)}get autoplay(){return this.player.autoplay}set autoplay(t){const e=this.player.autoplay;this.player.autoplay=t,this.requestUpdate("autoplay",e)}render(){return Ne`<style>:host{width:${this._cssWidth}}</style><div class="Player" @keydown="${this.handleKeyInput}"><div class="CanvasArea" @click="${this.handlePlayToggle}"><div class="PlayerCanvas" id="canvasWrapper"></div>${this._isLoading?Ne`<div class="Overlay"><flipnote-player-icon icon="loader" class="LoaderIcon"></flipnote-player-icon></div>`:""} ${this._isError?Ne`<div class="Overlay Overlay--error">Error</div>`:""}</div>${this.renderControls()}</div>`}renderControls(){return"compact"===this.controls?Ne`<div class="Controls Controls--compact Controls__row"><button @click="${this.handlePlayToggle}" class="Button Controls__playButton"><flipnote-player-icon icon="${this._isPlaying?"pause":"play"}"></flipnote-player-icon></button><flipnote-player-slider class="Controls__progressBar" value="${this._progress}" @change="${this.handleProgressSliderChange}" @inputstart="${this.handleProgressSliderInputStart}" @inputend="${this.handleProgressSliderInputEnd}"></div>`:Ne`<div class="Controls Controls--default"><flipnote-player-slider class="Controls__progressBar" value="${this._progress}" @change="${this.handleProgressSliderChange}" @inputstart="${this.handleProgressSliderInputStart}" @inputend="${this.handleProgressSliderInputEnd}"></flipnote-player-slider><div class="Controls__row"><div class="Controls__groupLeft"><button @click="${this.handlePlayToggle}" class="Button Controls__playButton"><flipnote-player-icon icon="${this._isPlaying?"pause":"play"}"></flipnote-player-icon></button> <span class="Controls__frameCounter">${this._counter}</span></div><div class="Controls__groupRight"><flipnote-player-icon class="MuteIcon" @click="${this.handleMuteToggle}" icon="${this._isMuted?"volumeOff":"volumeOn"}"></flipnote-player-icon><flipnote-player-slider class="Controls__volumeBar" value="${this._volumeLevel}" @change="${this.handleVolumeBarChange}"></flipnote-player-slider></div></div></div>`}firstUpdated(e){this.updateSettingsFromProps();const i=new $t(this.playerCanvasWrapper,256,192,this.parserSettings);this._resizeObserver.observe(this),this.player=i,i.on(t.PlayerEvent.LoadStart,()=>{this._isLoading=!0}),i.on(t.PlayerEvent.Load,()=>{this.updateCanvasSize()}),i.on(t.PlayerEvent.Error,()=>{this._isLoading=!1,this._isError=!0}),i.on([t.PlayerEvent.Load,t.PlayerEvent.Close,t.PlayerEvent.Progress],()=>{this._isLoading=!1,this._isError=!1,this._progress=i.getProgress()/100,this._counter=i.getFrameCounter()}),i.on(t.PlayerEvent.Play,()=>{this._isPlaying=!0}),i.on(t.PlayerEvent.Pause,()=>{this._isPlaying=!1}),i.on([t.PlayerEvent.Load,t.PlayerEvent.VolumeChange],()=>{this._volumeLevel=i.volume,this._isMuted=i.muted}),i.on(t.PlayerEvent.__Any,(t,e)=>{this.dispatchEvent(new Event(t))}),this._playerSrc&&i.load(this._playerSrc),this._isPlayerAvailable=!0}disconnectedCallback(){this._resizeObserver.disconnect(),this.destroy()}updateSettingsFromProps(){this.parserSettings={dsiLibraryNote:this.dsiLibrary,borderCrop:this.cropBorder,initialBgmPredictor:this.bgmPredictor,initialBgmStepIndex:this.bgmStepIndex,initialSePredictors:this.parseListProp(null==this?void 0:this.sePredictors),initialSeStepIndices:this.parseListProp(null==this?void 0:this.seStepIndices)}}parseListProp(t){if(t)return t.split(",").map(t=>/^\s*$/.test(t)?void 0:parseInt(t))}updateCanvasSize(){const t=this._isPlayerAvailable;let e=256;"auto"===this._width&&t&&this.player.isNoteLoaded?e=this.player.note.imageWidth:"auto"!==this._width&&(e=this.getBoundingClientRect().width),t&&this.player.resize(e,.75*e)}};Qt([Ge({type:String})],ni.prototype,"controls",void 0),Qt([Ge({type:Boolean})],ni.prototype,"dsiLibrary",void 0),Qt([Ge({type:Boolean})],ni.prototype,"cropBorder",void 0),Qt([Ge({type:Number})],ni.prototype,"bgmPredictor",void 0),Qt([Ge({type:Number})],ni.prototype,"bgmStepIndex",void 0),Qt([Ge({type:String})],ni.prototype,"sePredictors",void 0),Qt([Ge({type:String})],ni.prototype,"seStepIndices",void 0),Qt([Ge({type:String})],ni.prototype,"width",null),Qt([Ge({type:String})],ni.prototype,"src",null),Qt([Ge({type:Boolean})],ni.prototype,"autoplay",null),Qt([Xe()],ni.prototype,"_width",void 0),Qt([Xe()],ni.prototype,"_cssWidth",void 0),Qt([Xe()],ni.prototype,"_progress",void 0),Qt([Xe()],ni.prototype,"_counter",void 0),Qt([Xe()],ni.prototype,"_isLoading",void 0),Qt([Xe()],ni.prototype,"_isError",void 0),Qt([Xe()],ni.prototype,"_isPlaying",void 0),Qt([Xe()],ni.prototype,"_isMuted",void 0),Qt([Xe()],ni.prototype,"_volumeLevel",void 0),Qt([Ye("#canvasWrapper")],ni.prototype,"playerCanvasWrapper",void 0),ni=Qt([qe("flipnote-player")],ni);class ai{constructor(t){this.classes=new Set,this.changed=!1,this.element=t;const e=(t.getAttribute("class")||"").split(/\s+/);for(const t of e)this.classes.add(t)}add(t){this.classes.add(t),this.changed=!0}remove(t){this.classes.delete(t),this.changed=!0}commit(){if(this.changed){let t="";this.classes.forEach(e=>t+=e+" "),this.element.setAttribute("class",t)}}}const oi=new WeakMap,hi=ue(t=>e=>{if(!(e instanceof Ee)||e instanceof Fe||"class"!==e.committer.name||e.committer.parts.length>1)throw new Error("The `classMap` directive must be used in the `class` attribute and must be the only part in the attribute.");const{committer:i}=e,{element:s}=i;let r=oi.get(e);void 0===r&&(s.setAttribute("class",i.strings.join(" ")),oi.set(e,r=new Set));const n=s.classList||new ai(s);r.forEach(e=>{e in t||(n.remove(e),r.delete(e))});for(const e in t){const i=t[e];i!=r.has(e)&&(i?(n.add(e),r.add(e)):(n.remove(e),r.delete(e)))}"function"==typeof n.commit&&n.commit()}),li=new WeakMap,ci=ue(t=>e=>{if(!(e instanceof Ee)||e instanceof Fe||"style"!==e.committer.name||e.committer.parts.length>1)throw new Error("The `styleMap` directive must be used in the style attribute and must be the only part in the attribute.");const{committer:i}=e,{style:s}=i.element;let r=li.get(e);void 0===r&&(s.cssText=i.strings.join(" "),li.set(e,r=new Set)),r.forEach(e=>{e in t||(r.delete(e),-1===e.indexOf("-")?s[e]=null:s.removeProperty(e))});for(const e in t)r.add(e),-1===e.indexOf("-")?s[e]=t[e]:s.setProperty(e,t[e])});let di=class extends ri{constructor(){super(...arguments),this.value=0,this.orientation="horizontal",this.isActive=!1,this.onSliderInputStart=t=>{t.preventDefault(),this.isActive=!0,document.addEventListener("mousemove",this.onSliderInput),document.addEventListener("mouseup",this.onSliderInputEnd),this.dispatch("inputstart"),this.onSliderInput(t)},this.onSliderInputEnd=t=>{t.preventDefault(),document.removeEventListener("mousemove",this.onSliderInput),document.removeEventListener("mouseup",this.onSliderInputEnd),this.dispatch("inputend"),this.onSliderInput(t),this.isActive=!1},this.onSliderInput=t=>{t.preventDefault();const e=this.sliderElement.getBoundingClientRect();let i;if("horizontal"===this.orientation){const s=e.height/2,r=e.width-2*s,n=(t.clientX-e.left-s)/r;i=Math.max(0,Math.min(n,1))}else if("vertical"===this.orientation){const s=e.width/2,r=e.height-2*s,n=1-(t.clientY-e.top-s)/r;i=Math.max(0,Math.min(n,1))}this.value!==i&&this.dispatch("change",{value:i})}}static get styles(){return ii`.Slider{padding:4px 0;cursor:pointer}.Slider--vertical{height:100px;width:14px}.Slider__track{position:relative;border-radius:3px;background:var(--flipnote-player-slider-track,#ffd3a6)}.Slider--horizontal .Slider__track{height:4px;margin:6px 0}.Slider--vertical .Slider__track{width:4px;height:100%;margin:0 6px}.Slider__level{position:absolute;width:100%;height:6px;margin:-1px;border-radius:8px;background:var(--flipnote-player-slider-level,#f36a2d)}.Slider--horizontal .Slider__level{width:100%;height:6px}.Slider--vertical .Slider__level{width:6px;height:100%;bottom:0}.Slider__handle{display:none;position:absolute;height:10px;width:10px;border-radius:5px;box-sizing:border-box;border:3px solid var(--flipnote-player-slider-handle,#f36a2d);background:var(--flipnote-player-slider-handle-fill,#fff)}.Slider--isActive .Slider__handle,.Slider:hover .Slider__handle{display:block}.Slider--horizontal .Slider__handle{top:0;margin-top:-3px;margin-left:-6px}.Slider--vertical .Slider__handle{left:0;margin-bottom:-6px;margin-left:-3px}`}render(){const t=100*this.value+"%",e="horizontal"===this.orientation?"width":"height",i="horizontal"===this.orientation?"left":"bottom",s={Slider:!0,"Slider--horizontal":"horizontal"===this.orientation,"Slider--vertical":"vertical"===this.orientation,"Slider--isActive":this.isActive};return Ne`<div class="${hi(s)}" @mousedown="${this.onSliderInputStart}"><div class="Slider__track"><div class="Slider__level" style="${ci({[e]:t})}"></div><div class="Slider__handle" style="${ci({[i]:t})}"></div></div></div>`}dispatch(t,e){const i=new CustomEvent(t,{detail:e});this.dispatchEvent(i)}};Qt([Ge({type:Number})],di.prototype,"value",void 0),Qt([Ge({type:String})],di.prototype,"orientation",void 0),Qt([Xe()],di.prototype,"isActive",void 0),Qt([Ye(".Slider__track")],di.prototype,"sliderElement",void 0),di=Qt([qe("flipnote-player-slider")],di);const ui=new WeakMap,fi=window.navigator.userAgent.indexOf("Trident/")>0,pi=ue(t=>e=>{if(!(e instanceof xe))throw new Error("unsafeSVG can only be used in text bindings");const i=ui.get(e);if(void 0!==i&&Se(t)&&t===i.value&&e.value===i.fragment)return;const s=document.createElement("template"),r=s.content;let n;fi?(s.innerHTML=`<svg>${t}</svg>`,n=r.firstChild):(n=document.createElementNS("http://www.w3.org/2000/svg","svg"),r.appendChild(n),n.innerHTML=t),r.removeChild(n),((t,e,i=null,s=null)=>{for(;e!==i;){const i=e.nextSibling;t.insertBefore(e,s),e=i}})(r,n.firstChild);const a=document.importNode(r,!0);e.setValue(a),ui.set(e,{value:t,fragment:a})});function mi(t){return t.replace(/<svg ([^>]*)>/,(t,e)=>`<svg ${e} class="Icon" style="fill:currentColor">`)}const gi={play:mi('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M74.137 48h8.985a4 4 0 012.129.614l91.994 57.84c7.48 4.704 9.732 14.582 5.028 22.062a16 16 0 01-5.028 5.03l-91.994 57.84a4 4 0 01-2.13.614h-8.984C68.54 192 64 187.461 64 181.863V58.137C64 52.54 68.539 48 74.137 48z"/></svg>'),pause:mi('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M64 48h24c8.837 0 16 7.163 16 16v112c0 8.837-7.163 16-16 16H64c-8.837 0-16-7.163-16-16V64c0-8.837 7.163-16 16-16zm88 0h24c8.837 0 16 7.163 16 16v112c0 8.837-7.163 16-16 16h-24c-8.837 0-16-7.163-16-16V64c0-8.837 7.163-16 16-16z"/></svg>'),loader:mi('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path fill-rule="evenodd" d="M120 176c8.837 0 16 7.163 16 16s-7.163 16-16 16-16-7.163-16-16 7.163-16 16-16zm48.497-28c4.419-7.653 14.204-10.275 21.857-5.856 7.653 4.418 10.275 14.203 5.856 21.856-4.418 7.653-14.203 10.275-21.856 5.856-7.653-4.418-10.275-14.203-5.857-21.856zm-118.85-5.856c7.652-4.419 17.437-1.797 21.856 5.856 4.418 7.653 1.796 17.438-5.857 21.856-7.653 4.419-17.438 1.797-21.856-5.856-4.419-7.653-1.797-17.438 5.856-21.856zm124.707-72c7.653-4.419 17.438-1.797 21.856 5.856 4.419 7.653 1.797 17.438-5.856 21.856-7.653 4.419-17.438 1.797-21.857-5.856-4.418-7.653-1.796-17.438 5.857-21.856zM43.79 76c4.418-7.653 14.203-10.275 21.856-5.856C73.3 74.562 75.921 84.347 71.503 92c-4.419 7.653-14.204 10.275-21.857 5.856C41.993 93.438 39.371 83.653 43.79 76zM120 32c8.837 0 16 7.163 16 16s-7.163 16-16 16-16-7.163-16-16 7.163-16 16-16z"/></svg>'),volumeOn:mi('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M113.3 42.022a10 10 0 0110-1.2 10 10 0 015.7 9v140a10 10 0 01-5.7 9 9.116 9.116 0 01-4.3 1.001 10.009 10.009 0 01-6.2-2.2l-47.3-37.8H29c-5.523 0-10-4.478-10-10v-60c0-5.524 4.477-10 10-10h36.5zm82.986 17.298c17.008 16.234 25.715 36.022 25.715 58.68 0 22.37-8.465 43.147-24.992 61.928-4.378 4.975-11.96 5.459-16.936 1.08-4.975-4.378-5.46-11.96-1.08-16.936C191.798 149.52 198 134.297 198 118c0-16.009-5.96-29.554-18.286-41.32-4.794-4.576-4.97-12.172-.395-16.966 4.577-4.794 12.172-4.97 16.966-.394zM165.201 87.4c10.904 8.178 16.8 18.987 16.8 31.6 0 12.433-5.712 23.38-16.318 32.219-5.091 4.242-12.658 3.555-16.9-1.537-4.174-5.008-3.577-12.41 1.289-16.69l.246-.21c5.395-4.496 7.683-8.881 7.683-13.782 0-4.613-2.01-8.403-6.857-12.14l-.343-.26c-5.302-3.976-6.377-11.498-2.4-16.8 3.976-5.302 11.498-6.376 16.8-2.4z"/></svg>'),volumeOff:mi('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M123.3 40.822a10 10 0 00-10 1.2l-47.8 37.8H29c-5.523 0-10 4.477-10 10v60c0 5.523 4.477 10 10 10h36.5l47.3 37.8a10.009 10.009 0 006.2 2.201 9.116 9.116 0 004.3-1 10 10 0 005.7-9v-140a10 10 0 00-5.7-9zm70.451 50.462c4.702-4.454 12.126-4.377 16.734.23 4.608 4.609 4.685 12.033.23 16.735l-.23.236L198.971 120l11.514 11.515c4.687 4.686 4.687 12.284 0 16.97-4.608 4.608-12.032 4.685-16.734.23l-.236-.23L182 136.971l-11.515 11.514-.236.23c-4.702 4.455-12.126 4.378-16.734-.23-4.608-4.608-4.685-12.032-.23-16.734l.23-.236L165.029 120l-11.514-11.515c-4.687-4.686-4.687-12.284 0-16.97 4.608-4.608 12.032-4.685 16.734-.23l.236.23L182 103.029l11.515-11.514.236-.23z"/></svg>')};let yi=class extends ri{constructor(){super(...arguments),this.icon="loader"}static get styles(){return ii`.Icon{width:100%;height:100%;color:var(--flipnote-player-icon-color,#f36a2d)}`}render(){return Ne`${pi(gi[this.icon])}`}};Qt([Ge({type:String})],yi.prototype,"icon",void 0),yi=Qt([qe("flipnote-player-icon")],yi);let vi=class extends ri{constructor(){super(...arguments),this._src="",this._frame="0",this.cropped=!1,this.gifUrl="",this.imgTitle=""}static get styles(){return ii`.Image{width:inherit;height:inherit;image-rendering:-moz-crisp-edges;image-rendering:-webkit-crisp-edges;image-rendering:pixelated;image-rendering:crisp-edges;-ms-interpolation-mode:nearest-neighbor}`}set src(t){this.load(t)}get src(){return this._src}set frame(t){this._frame=t,this.note&&this.loadNote(this.note)}get frame(){return this._frame}render(){return Ne`<img class="Image" src="${this.gifUrl}" alt="${this.imgTitle}" title="${this.imgTitle}">`}revokeUrl(){this.gif&&this.gif.dataUrl&&(this.gif.revokeUrl(),this.gifUrl="")}loadNote(t){this.note=t,this.revokeUrl();const e=this._frame;if("all"===e)this.gif=Xt.fromFlipnote(t),this.gifUrl=this.gif.getUrl();else if("thumb"===e)this.gif=Xt.fromFlipnoteFrame(t,t.thumbFrameIndex),this.gifUrl=this.gif.getUrl();else if(!isNaN(+e)){const i=parseInt(e);this.gif=Xt.fromFlipnoteFrame(t,i),this.gifUrl=this.gif.getUrl()}this.gifUrl?(this.dispatchLoad(),this.imgTitle=t.getTitle()):this.dispatchError("Invalid frame attribute")}load(t){this._src=t,this.note=void 0;tt(t,{borderCrop:"true"===this.getAttribute("cropped")}).then(t=>this.loadNote(t)).catch(t=>this.dispatchError(t))}disconnectedCallback(){this.revokeUrl()}dispatchLoad(){this.dispatchEvent(new Event("load"))}dispatchError(t){throw this.dispatchEvent(new ErrorEvent("error",{error:t})),new Error(t)}};Qt([Ge()],vi.prototype,"src",null),Qt([Ge()],vi.prototype,"frame",null),Qt([Ge({type:Boolean})],vi.prototype,"cropped",void 0),Qt([Xe()],vi.prototype,"gifUrl",void 0),Qt([Xe()],vi.prototype,"imgTitle",void 0),vi=Qt([qe("flipnote-image")],vi);const bi=ni,Si=vi;t.CanvasInterface=class{constructor(t,e,i){}},t.GifImage=Xt,t.Html5Canvas=Dt,t.ImageComponent=Si,t.KwzParser=J,t.Player=$t,t.PlayerComponent=bi,t.PlayerMixin=jt,t.PpmParser=V,t.UniversalCanvas=Wt,t.WavAudio=Yt,t.WebAudioPlayer=Ht,t.WebglCanvas=Ot,t.parseSource=tt,t.utils=R,t.version="5.6.7",Object.defineProperty(t,"__esModule",{value:!0})}));
