/*!!
flipnote.js v5.6.7 (web build)
https://flipnote.js.org
A JavaScript library for parsing, converting, and in-browser playback of the proprietary animation formats used by Nintendo's Flipnote Studio and Flipnote Studio 3D apps.
2018 - 2021 James Daniel
Flipnote Studio is (c) Nintendo Co., Ltd. This project isn't affiliated with or endorsed by them in any way.
Keep on Flipnoting!
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).flipnote={})}(this,(function(t){"use strict";var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(t,r)};function r(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}var i=function(){return(i=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};function n(t,e,r,i){return new(r||(r=Promise))((function(n,o){function a(t){try{u(i.next(t))}catch(t){o(t)}}function s(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,s)}u((i=i.apply(t,e||[])).next())}))}function o(t,e){var r,i,n,o,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,i&&(n=2&o[0]?i.return:o[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,o[1])).done)return n;switch(i=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,i=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(n=a.trys,(n=n.length>0&&n[n.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){a.label=o[1];break}if(6===o[0]&&a.label<n[1]){a.label=n[1],n=o;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(o);break}n[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],i=0}finally{r=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function a(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var i,n,o=r.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)a.push(i.value)}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return a}function s(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(a(arguments[e]));return t}var u=function(){function t(){this.pageSize=4096,this.allocSize=0,this.realSize=0,this.pages=[],this.numPages=0,this.pageIdx=0,this.pagePtr=0,this.realPtr=0,this.newPage()}return Object.defineProperty(t.prototype,"pointer",{get:function(){return this.realPtr},set:function(t){this.setPointer(t)},enumerable:!1,configurable:!0}),t.prototype.newPage=function(){this.pages[this.numPages]=new Uint8Array(this.pageSize),this.numPages=this.pages.length,this.allocSize=this.numPages*this.pageSize},t.prototype.setPointer=function(t){for(;t>=this.allocSize;)this.newPage();t>this.realSize&&(this.realSize=t),this.pageIdx=Math.floor(t/this.pageSize),this.pagePtr=t%this.pageSize,this.realPtr=t},t.prototype.writeByte=function(t){this.pages[this.pageIdx][this.pagePtr]=t,this.setPointer(this.realPtr+1)},t.prototype.writeBytes=function(t,e,r){for(var i=r||t.length,n=e||0;n<i;n++)this.writeByte(t[n])},t.prototype.writeChars=function(t){for(var e=0;e<t.length;e++)this.writeByte(t.charCodeAt(e))},t.prototype.writeU8=function(t){this.writeByte(255&t)},t.prototype.writeU16=function(t){this.writeByte(t>>>0&255),this.writeByte(t>>>8&255)},t.prototype.writeU32=function(t){this.writeByte(t>>>0&255),this.writeByte(t>>>8&255),this.writeByte(t>>>16&255),this.writeByte(t>>>24&255)},t.prototype.getBytes=function(){for(var t=new Uint8Array(this.realSize),e=this.numPages,r=0;r<e;r++){var i=this.pages[r];r===e-1?t.set(i.slice(0,this.realSize%this.pageSize),r*this.pageSize):t.set(i,r*this.pageSize)}return t},t.prototype.getBuffer=function(){return this.getBytes().buffer},t}(),h=function(){function t(t){this.buffer=t,this.data=new DataView(t),this.pointer=0}return Object.defineProperty(t.prototype,"bytes",{get:function(){return new Uint8Array(this.buffer)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"byteLength",{get:function(){return this.data.byteLength},enumerable:!1,configurable:!0}),t.prototype.seek=function(t,e){switch(e){case 2:this.pointer=this.data.byteLength+t;break;case 1:this.pointer+=t;break;case 0:default:this.pointer=t}},t.prototype.readUint8=function(){var t=this.data.getUint8(this.pointer);return this.pointer+=1,t},t.prototype.writeUint8=function(t){this.data.setUint8(this.pointer,t),this.pointer+=1},t.prototype.readInt8=function(){var t=this.data.getInt8(this.pointer);return this.pointer+=1,t},t.prototype.writeInt8=function(t){this.data.setInt8(this.pointer,t),this.pointer+=1},t.prototype.readUint16=function(t){void 0===t&&(t=!0);var e=this.data.getUint16(this.pointer,t);return this.pointer+=2,e},t.prototype.writeUint16=function(t,e){void 0===e&&(e=!0),this.data.setUint16(this.pointer,t,e),this.pointer+=2},t.prototype.readInt16=function(t){void 0===t&&(t=!0);var e=this.data.getInt16(this.pointer,t);return this.pointer+=2,e},t.prototype.writeInt16=function(t,e){void 0===e&&(e=!0),this.data.setInt16(this.pointer,t,e),this.pointer+=2},t.prototype.readUint32=function(t){void 0===t&&(t=!0);var e=this.data.getUint32(this.pointer,t);return this.pointer+=4,e},t.prototype.writeUint32=function(t,e){void 0===e&&(e=!0),this.data.setUint32(this.pointer,t,e),this.pointer+=4},t.prototype.readInt32=function(t){void 0===t&&(t=!0);var e=this.data.getInt32(this.pointer,t);return this.pointer+=4,e},t.prototype.writeInt32=function(t,e){void 0===e&&(e=!0),this.data.setInt32(this.pointer,t,e),this.pointer+=4},t.prototype.readBytes=function(t){var e=new Uint8Array(this.data.buffer,this.pointer,t);return this.pointer+=e.byteLength,e},t.prototype.writeBytes=function(t){var e=this;t.forEach((function(t){return e.writeUint8(t)}))},t.prototype.readHex=function(t,e){void 0===e&&(e=!1);for(var r=this.readBytes(t),i=[],n=0;n<r.length;n++)i.push(r[n].toString(16).padStart(2,"0"));return e&&i.reverse(),i.join("").toUpperCase()},t.prototype.readChars=function(t){for(var e=this.readBytes(t),r="",i=0;i<e.length;i++){var n=e[i];if(0===n)break;r+=String.fromCharCode(n)}return r},t.prototype.writeChars=function(t){for(var e=0;e<t.length;e++){var r=t.charCodeAt(e);this.writeUint8(r)}},t.prototype.readWideChars=function(t){for(var e=new Uint16Array(this.data.buffer,this.pointer,t),r="",i=0;i<e.length;i++){var n=e[i];if(0==n)break;r+=String.fromCharCode(n)}return this.pointer+=e.byteLength,r},t}(),f=new Int8Array([-1,2,-1,2]),c=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),l=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]);function d(t,e,r){return t<e?e:t>r?r:t}var p=function(t,e,r){return t+r*(e-t)};function y(t,e,r){return r<0||r>=e?0:t[r]}function m(t){for(var e=t.length,r=0,i=0;i<e;i++){var n=t[i];(n<=-32768||n>=32767)&&(r+=1)}return r/e}function g(t){for(var e=t.length,r=0,i=0;i<e;i++)r+=Math.pow(t[i],2);return Math.sqrt(r/e)}function v(t,e){if(void 0===e&&(e="Assert failed"),!t)throw console.trace(e),new Error(e)}function b(t,e,r,i){void 0===i&&(i=""),v(t>=e&&t<=r,(i||"value")+" "+t+" should be between "+e+" and "+r)}function w(t,e){try{return t.require(e)}catch(t){throw new Error("Could not require("+e+")")}}var F="undefined"!=typeof window&&void 0!==window.document;function S(){return v(F,"This feature is only available in browser environments")}var E="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node;function A(){return v(E,"This feature is only available in NodeJS environments")}var P="object"==typeof self&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name,T=function(){if(F||P){var t=E?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{};return(t.crypto||t.msCrypto).subtle}if(E)return w(module,"crypto").webcrypto.subtle}();function x(t,e){return n(this,void 0,void 0,(function(){var r,i,n;return o(this,(function(o){switch(o.label){case 0:return r=t.split("\n").filter((function(t){return!t.startsWith("-----")&&!t.endsWith("-----")})).join(""),i=atob(r),n=new Uint8Array(i.length).map((function(t,e){return i.charCodeAt(e)})),[4,T.importKey("spki",n.buffer,{name:"RSASSA-PKCS1-v1_5",hash:e},!1,["verify"])];case 1:return[2,o.sent()]}}))}))}function C(t,e,r){return n(this,void 0,void 0,(function(){return o(this,(function(i){switch(i.label){case 0:return[4,T.verify("RSASSA-PKCS1-v1_5",t,e,r)];case 1:return[2,i.sent()]}}))}))}var U;function k(t){return new Date(1e3*(t+946684800))}function B(t,e){return 100*t*(1/e)/100}t.FlipnoteRegion=void 0,(U=t.FlipnoteRegion||(t.FlipnoteRegion={})).EUR="EUR",U.USA="USA",U.JPN="JPN",U.UNKNOWN="UNKNOWN";var _=/^[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}$/,L=/^[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{6}$/,I=/^(00|10|12|14)[0-9a-f]{2}-[0-9a-f]{4}-[0-9a-f]{3}0-[0-9a-f]{4}[0159]{1}[0-9a-f]{1}$/;function M(t){return"14E494E35A443235"===t||_.test(t)}function R(t){return L.test(t)}function O(t){return t.endsWith("3532445AE394E414")||I.test(t)}function z(e){switch(e.charAt(0)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}}function N(e){if(O(e))switch(e.charAt(19)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}switch(e.slice(0,2)){case"00":return t.FlipnoteRegion.JPN;case"02":return t.FlipnoteRegion.USA;case"04":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}}var D,W,H,j=Object.freeze({__proto__:null,get FlipnoteRegion(){return t.FlipnoteRegion},isPpmFsid:M,isKwzFsid:R,isKwzDsiLibraryFsid:O,isFsid:function(t){return M(t)||R(t)},getPpmFsidRegion:z,getKwzFsidRegion:N,getFsidRegion:function(e){return M(e)?z(e):R(e)?N(e):t.FlipnoteRegion.UNKNOWN}});!function(){if(!F)return function(){};var t=document.createElement("a")}(),t.FlipnoteFormat=void 0,(D=t.FlipnoteFormat||(t.FlipnoteFormat={})).PPM="PPM",D.KWZ="KWZ",t.FlipnoteAudioTrack=void 0,(W=t.FlipnoteAudioTrack||(t.FlipnoteAudioTrack={}))[W.BGM=0]="BGM",W[W.SE1=1]="SE1",W[W.SE2=2]="SE2",W[W.SE3=3]="SE3",W[W.SE4=4]="SE4",t.FlipnoteSoundEffectTrack=void 0,(H=t.FlipnoteSoundEffectTrack||(t.FlipnoteSoundEffectTrack={}))[H.SE1=1]="SE1",H[H.SE2=2]="SE2",H[H.SE3=3]="SE3",H[H.SE4=4]="SE4";for(var K=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e[Symbol.toStringTag]="Flipnote",e.titleFormats={COMMENT:"Comment by $USERNAME",FLIPNOTE:"Flipnote by $USERNAME",ICON:"Folder icon"},e.soundMeta=new Map,e.layerVisibility={1:!0,2:!0,3:!0},e.isFolderIcon=!1,e.isComment=!1,e.isDsiLibraryNote=!1,e}return r(e,t),e.prototype.getTitle=function(t){return void 0===t&&(t=this.titleFormats),this.isFolderIcon?t.ICON:(this.isComment?t.COMMENT:t.FLIPNOTE).replace("$USERNAME",this.meta.current.username)},e.prototype.toString=function(){return this.getTitle()},e.prototype[Symbol.iterator]=function(){var t;return o(this,(function(e){switch(e.label){case 0:t=0,e.label=1;case 1:return t<this.frameCount?[4,t]:[3,4];case 2:e.sent(),e.label=3;case 3:return t++,[3,1];case 4:return[2]}}))},e.prototype.getLayerPixels=function(t,e,r){void 0===r&&(r=new Uint8Array(this.imageWidth*this.imageHeight)),b(t,0,this.frameCount-1,"Frame index"),b(e,0,this.numLayers-1,"Layer index");var i=this.getFramePaletteIndices(t),n=e*this.numLayerColors,o=this.decodeFrame(t)[e],a=this.srcWidth,s=this.imageWidth,u=this.imageHeight,h=this.imageOffsetX,f=this.imageOffsetY;if(r.fill(0),!this.layerVisibility[e+1])return r;for(var c=f,l=0;l<u;c++,l++)for(var d=h,p=0;p<s;d++,p++){var y=l*s+p,m=o[c*a+d];0!==m&&(r[y]=i[n+m])}return r},e.prototype.getLayerPixelsRgba=function(t,e,r,i){void 0===r&&(r=new Uint32Array(this.imageWidth*this.imageHeight)),void 0===i&&(i=new Uint32Array(16)),b(t,0,this.frameCount-1,"Frame index"),b(e,0,this.numLayers-1,"Layer index"),this.getFramePaletteUint32(t,i);var n=e*this.numLayerColors,o=this.decodeFrame(t)[e],a=this.srcWidth,s=this.imageWidth,u=this.imageHeight,h=this.imageOffsetX,f=this.imageOffsetY;if(r.fill(i[0]),!this.layerVisibility[e+1])return r;for(var c=f,l=0;l<u;c++,l++)for(var d=h,p=0;p<s;d++,p++){var y=l*s+p,m=o[c*a+d];0!==m&&(r[y]=i[n+m])}return r},e.prototype.getFramePixels=function(t,e){void 0===e&&(e=new Uint8Array(this.imageWidth*this.imageHeight));var r=this.srcWidth,i=this.imageWidth,n=this.imageHeight,o=this.imageOffsetX,a=this.imageOffsetY,s=this.getFramePaletteIndices(t);e.fill(s[0]);for(var u=this.getFrameLayerOrder(t),h=this.decodeFrame(t),f=0;f<this.numLayers;f++){var c=u[f],l=h[c],d=c*this.numLayerColors;if(this.layerVisibility[c+1])for(var p=a,y=0;y<n;p++,y++)for(var m=o,g=0;g<i;m++,g++){var v=y*i+g,b=l[p*r+m];0!==b&&(e[v]=s[d+b])}}return e},e.prototype.getFramePixelsRgba=function(t,e,r){void 0===e&&(e=new Uint32Array(this.imageWidth*this.imageHeight)),void 0===r&&(r=new Uint32Array(16)),b(t,0,this.frameCount-1,"Frame index");var i=this.srcWidth,n=this.imageWidth,o=this.imageHeight,a=this.imageOffsetX,s=this.imageOffsetY;this.getFramePaletteUint32(t,r),e.fill(r[0]);for(var u=this.getFrameLayerOrder(t),h=this.decodeFrame(t),f=0;f<this.numLayers;f++){var c=u[f],l=h[c],d=c*this.numLayerColors;if(this.layerVisibility[c+1])for(var p=s,y=0;y<o;p++,y++)for(var m=a,g=0;g<n;m++,g++){var v=y*n+g,w=l[p*i+m];0!==w&&(e[v]=r[d+w])}}return e},e.prototype.getFramePaletteUint32=function(t,e){void 0===e&&(e=new Uint32Array(16)),b(t,0,this.frameCount-1,"Frame index");var r=this.getFramePalette(t);return e.fill(0),r.forEach((function(t,r){var i=a(t,4),n=i[0],o=i[1],s=i[2],u=i[3];return e[r]=u<<24|s<<16|o<<8|n})),e},e.prototype.getSoundEffectFlagsForTrack=function(t){return this.getSoundEffectFlags().map((function(e){return e[t]}))},e.prototype.isSoundEffectUsedOnFrame=function(t,e){return b(e,0,this.frameCount-1,"Frame index"),!!this.soundEffectTracks.includes(t)&&this.getFrameSoundEffectFlags(e)[t]},e.prototype.hasAudioTrack=function(t){return this.soundMeta.has(t)&&this.soundMeta.get(t).length>0},e}(h),V=[.5,.5,1,2,4,6,12,20,30],G={WHITE:[255,255,255,255],BLACK:[14,14,14,255],RED:[255,42,42,255],BLUE:[10,57,255,255]},q="-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCPLwTL6oSflv+gjywi/sM0TUB\n90xqOvuCpjduETjPoN2FwMebxNjdKIqHUyDu4AvrQ6BDJc6gKUbZ1E27BGZoCPH4\n9zQRb+zAM6M9EjHwQ6BABr0u2TcF7xGg2uQ9MBWz9AfbVQ91NjfrNWo0f7UPmffv\n1VvixmTk1BCtavZxBwIDAQAB\n-----END PUBLIC KEY-----",X=function(e){function i(r,n){var o=e.call(this,r)||this;return o.format=t.FlipnoteFormat.PPM,o[Symbol.toStringTag]="Flipnote Studio PPM animation file",o.imageWidth=i.width,o.imageHeight=i.height,o.imageOffsetX=0,o.imageOffsetY=0,o.numLayers=i.numLayers,o.numLayerColors=i.numLayerColors,o.publicKey=i.publicKey,o.srcWidth=i.width,o.audioTracks=i.audioTracks,o.soundEffectTracks=i.soundEffectTracks,o.rawSampleRate=i.rawSampleRate,o.sampleRate=i.sampleRate,o.globalPalette=i.globalPalette,o.prevDecodedFrame=null,o.decodeHeader(),o.decodeAnimationHeader(),o.decodeSoundHeader(),0!=(o.version>>4&15)&&o.decodeMeta(),o.layerBuffers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],o.prevLayerBuffers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],o.lineEncodingBuffers=[new Uint8Array(i.height),new Uint8Array(i.height)],o.prevDecodedFrame=null,o}return r(i,e),i.prototype.decodeHeader=function(){v(16<this.byteLength),this.seek(4),this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16();var t=1696+this.frameDataLength+this.frameCount;t%4!=0&&(t+=4-t%4),v(t<this.byteLength),this.soundDataOffset=t},i.prototype.readFilename=function(){return this.readHex(3)+"_"+this.readChars(13)+"_"+this.readUint16().toString().padStart(3,"0")},i.prototype.decodeMeta=function(){v(1704<this.byteLength),this.seek(16);var t=this.readUint16(),e=this.readInt16(),r=this.readWideChars(11),i=this.readWideChars(11),n=this.readWideChars(11),o=this.readHex(8,!0),a=this.readHex(8,!0),s=this.readFilename(),u=this.readFilename(),h=this.readHex(8,!0);this.seek(154);var f=k(this.readInt32());this.seek(1702);var c=this.readUint16();this.thumbFrameIndex=e,this.layerVisibility={1:0==(16&c),2:0==(32&c),3:!1},this.isSpinoff=a!==o||a!==h,this.meta={lock:1===t,loop:1==(c>>1&1),isSpinoff:this.isSpinoff,frameCount:this.frameCount,frameSpeed:this.frameSpeed,bgmSpeed:this.bgmSpeed,duration:this.duration,thumbIndex:e,timestamp:f,root:{username:r,fsid:h,region:z(h),filename:null},parent:{username:i,fsid:o,region:z(o),filename:s},current:{username:n,fsid:a,region:z(a),filename:u}}},i.prototype.decodeAnimationHeader=function(){this.seek(1696);var t=this.readUint16(),e=t/4;v(e<=this.frameCount),this.seek(1704);for(var r=new Uint32Array(e),i=0;i<e;i++){var n=1704+t+this.readUint32();v(n<this.byteLength,"Frame "+i+" pointer is out of bounds"),r[i]=n}this.frameOffsets=r},i.prototype.decodeSoundHeader=function(){var e=this.soundDataOffset;this.seek(e);var r=this.readUint32(),i=this.readUint32(),n=this.readUint32(),o=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),v(this.frameSpeed<=8&&this.bgmSpeed<=8),e+=32,this.framerate=V[this.frameSpeed],this.duration=B(this.frameCount,this.framerate),this.bgmrate=V[this.bgmSpeed];var a=new Map;a.set(t.FlipnoteAudioTrack.BGM,{ptr:e,length:r}),a.set(t.FlipnoteAudioTrack.SE1,{ptr:e+=r,length:i}),a.set(t.FlipnoteAudioTrack.SE2,{ptr:e+=i,length:n}),a.set(t.FlipnoteAudioTrack.SE3,{ptr:e+=n,length:o}),this.soundMeta=a},i.prototype.isKeyFrame=function(t){return b(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameOffsets[t]),this.readUint8()>>7&1},i.prototype.decodeFrame=function(t){if(b(t,0,this.frameCount-1,"Frame index"),this.prevDecodedFrame===t)return this.layerBuffers;this.prevDecodedFrame===t-1||this.isKeyFrame(t)||0===t||this.decodeFrame(t-1),this.prevDecodedFrame=t,this.seek(this.frameOffsets[t]);var e=this.readUint8(),r=e>>7&1,n=e>>5&3;this.layerBuffers[0].fill(0),this.layerBuffers[1].fill(0);var o=0,a=0;n&&(o=this.readInt8(),a=this.readInt8());for(var s=0;s<2;s++){(c=this.lineEncodingBuffers[s]).fill(0);for(var u=0;u<c.length;){var h=this.readUint8();0!==h?(c[u++]=3&h,c[u++]=h>>2&3,c[u++]=h>>4&3,c[u++]=h>>6&3):u+=4}}for(s=0;s<2;s++)for(var f=this.layerBuffers[s],c=this.lineEncodingBuffers[s],l=0;l<i.height;l++){var d=l*i.width;switch(c[l]){case 0:break;case 1:for(var p=this.readUint32(!1);0!==p;p<<=1,d+=8)if(2147483648&p)for(var y=this.readUint8(),m=0;0!==y;m++,y>>=1)f[d+m]=1&y;break;case 2:f.fill(1,d,d+i.width);for(p=this.readUint32(!1);0!==p;p<<=1,d+=8)if(2147483648&p)for(y=this.readUint8(),m=0;m<8;m++,y>>=1)f[d+m]=1&y;break;case 3:y=0;for(var g=0;g<i.width;g++)g%8==0&&(y=this.readUint8()),f[d++]=1&y,y>>=1}}var v=this.layerBuffers[0],w=this.layerBuffers[1],F=this.prevLayerBuffers[0],S=this.prevLayerBuffers[1];if(r||0!==o||0!==a){if(!r){var E=i.width,A=i.height,P=Math.max(o,0),T=Math.max(a,0),x=Math.min(E+o,E),C=Math.min(A+a,A),U=a*E+o,k=void 0,B=void 0;for(l=T;l<C;l++)for(var _=P;_<x;_++)B=(k=l*E+_)-U,v[k]^=F[B],w[k]^=S[B]}}else{var L=i.height*i.width;for(g=0;g<L;g++)v[g]^=F[g],w[g]^=S[g]}return this.prevLayerBuffers[0].set(this.layerBuffers[0]),this.prevLayerBuffers[1].set(this.layerBuffers[1]),this.layerBuffers},i.prototype.getFrameLayerOrder=function(t){return b(t,0,this.frameCount-1,"Frame index"),[1,0]},i.prototype.getFramePaletteIndices=function(t){b(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameOffsets[t]);var e=this.readUint8(),r=1!=(1&e),i=[r?0:1,r?0:1,2,3];return[r?1:0,i[e>>1&3],i[e>>3&3]]},i.prototype.getFramePalette=function(t){var e=this;return b(t,0,this.frameCount-1,"Frame index"),this.getFramePaletteIndices(t).map((function(t){return e.globalPalette[t]}))},i.prototype.decodeSoundFlags=function(){if(void 0!==this.soundFlags)return this.soundFlags;v(1696+this.frameDataLength<this.byteLength),this.seek(1696+this.frameDataLength);var t=this.frameCount,e=this.readBytes(t);this.soundFlags=new Array(t);for(var r=0;r<t;r++){var i=e[r];this.soundFlags[r]=[0!=(1&i),0!=(2&i),0!=(4&i)]}return this.soundFlags},i.prototype.getSoundEffectFlags=function(){return this.decodeSoundFlags().map((function(e){var r;return(r={})[t.FlipnoteSoundEffectTrack.SE1]=e[0],r[t.FlipnoteSoundEffectTrack.SE2]=e[1],r[t.FlipnoteSoundEffectTrack.SE3]=e[2],r}))},i.prototype.getFrameSoundEffectFlags=function(e){var r;b(e,0,this.frameCount-1,"Frame index"),this.seek(1696+this.frameDataLength+e);var i=this.readUint8();return(r={})[t.FlipnoteSoundEffectTrack.SE1]=0!=(1&i),r[t.FlipnoteSoundEffectTrack.SE2]=0!=(2&i),r[t.FlipnoteSoundEffectTrack.SE3]=0!=(4&i),r},i.prototype.getAudioTrackRaw=function(t){var e=this.soundMeta.get(t);return v(e.ptr+e.length<this.byteLength),this.seek(e.ptr),this.readBytes(e.length)},i.prototype.decodeAudioTrack=function(t){for(var e=this.getAudioTrackRaw(t),r=e.length,i=new Int16Array(2*r),n=0,o=0,a=0,s=0,u=0,h=!0;n<r;){a=h?15&e[n]:e[n++]>>4,h=!h;var f=l[s],p=f>>3;1&a&&(p+=f>>2),2&a&&(p+=f>>1),4&a&&(p+=f),8&a&&(p=-p),u=d(u+=p,-32768,32767),s=d(s+=c[a],0,88),i[o++]=u}return i},i.prototype.getAudioTrackPcm=function(e,r){void 0===r&&(r=this.sampleRate);var i=this.decodeAudioTrack(e),n=this.rawSampleRate;if(e===t.FlipnoteAudioTrack.BGM){var o=1/this.bgmrate/(1/this.framerate);n=this.rawSampleRate*o}return n!==r?function(t,e,r){for(var i=t.length,n=i/e*r,o=new Int16Array(n),a=e/r,s=0;s<n;s++)o[s]=y(t,i,Math.floor(s*a));return o}(i,n,r):i},i.prototype.pcmAudioMix=function(t,e,r){void 0===r&&(r=0);for(var i=t.length,n=e.length,o=0;o<i&&!(r+o>n);o++){var a=e[r+o]+t[o]/2;e[r+o]=d(a,-32768,32767)}},i.prototype.getAudioMasterPcm=function(e){void 0===e&&(e=this.sampleRate);var r=Math.ceil(this.duration*e),i=new Int16Array(r),n=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),s=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3);if(n){var u=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,e);this.pcmAudioMix(u,i,0)}if(o||a||s)for(var h=e/this.framerate,f=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,e):null,c=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,e):null,l=s?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,e):null,d=this.decodeSoundFlags(),p=0;p<this.frameCount;p++){var y=Math.ceil(p*h),g=d[p];o&&g[0]&&this.pcmAudioMix(f,i,y),a&&g[1]&&this.pcmAudioMix(c,i,y),s&&g[2]&&this.pcmAudioMix(l,i,y)}return this.audioClipRatio=m(i),i},i.prototype.getBody=function(){var t=this.soundDataOffset+this.soundDataLength+32;return this.bytes.subarray(0,t)},i.prototype.getSignature=function(){var t=this.soundDataOffset+this.soundDataLength+32;return this.bytes.subarray(t,t+128)},i.prototype.verify=function(){return n(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,x(q,"SHA-1")];case 1:return[4,C(t.sent(),this.getSignature(),this.getBody())];case 2:return[2,t.sent()]}}))}))},i.defaultSettings={},i.format=t.FlipnoteFormat.PPM,i.width=256,i.height=192,i.numLayers=2,i.numLayerColors=1,i.rawSampleRate=8192,i.sampleRate=32768,i.audioTracks=[t.FlipnoteAudioTrack.BGM,t.FlipnoteAudioTrack.SE1,t.FlipnoteAudioTrack.SE2,t.FlipnoteAudioTrack.SE3],i.soundEffectTracks=[t.FlipnoteSoundEffectTrack.SE1,t.FlipnoteSoundEffectTrack.SE2,t.FlipnoteSoundEffectTrack.SE3],i.globalPalette=[G.WHITE,G.BLACK,G.RED,G.BLUE],i.publicKey=q,i}(K),Y=[.2,.5,1,2,4,6,8,12,20,24,30],Q={WHITE:[255,255,255,255],BLACK:[16,16,16,255],RED:[255,16,16,255],YELLOW:[255,231,0,255],GREEN:[0,134,49,255],BLUE:[0,56,206,255],NONE:[255,255,255,0]},J="-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuv+zHAXXvbbtRqxADDeJ\nArX2b9RMxj3T+qpRg3FnIE/jeU3tj7eoDzsMduY+D/UT9CSnP+QHYY/vf0n5lqX9\ns6ljoZAmyUuruyj1e5Bg+fkDEu/yPEPQjqhbyywCyYL4TEAOJveopUBx9fdQxUJ6\nJ4J5oCE/Im1kFrlGW+puARiHmt3mmUyNzO8bI/Jx3cGSfoOHJG1foEaQsI5aaKqA\npBqxtzvwqMhudcZtAWSyRMBMlndvkRnVTDNTfTXLOYdHShCIgnKULCTH87uLBIP/\nnsmr4/bnQz8q2rp/HyVO+0yjR6mVr0NX5APJQ+6riJmGg3t3VOldhKP7aTHDUW+h\nkQIDAQAB\n-----END PUBLIC KEY-----",$=new Uint16Array(16),Z=0;Z<16;Z++)$[Z]=(1<<Z)-1;for(var tt=new Uint8Array(52488),et=new Uint8Array(52488),rt=0,it=0;it<3;it++)for(var nt=0;nt<3;nt++)for(var ot=0;ot<3;ot++)for(var at=0;at<3;at++)for(var st=0;st<3;st++)for(var ut=0;ut<3;ut++)for(var ht=0;ht<3;ht++)for(var ft=0;ft<3;ft++)tt.set([nt,it,at,ot,ut,st,ft,ht],rt),et.set([it,at,ot,ut,st,ft,ht,nt],rt),rt+=8;var ct=new Uint8Array(256),lt=new Uint8Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach((function(t,e){var r=8*t,i=tt.subarray(r,r+8),n=et.subarray(r,r+8);ct.set(i,8*e),lt.set(n,8*e)}));var dt,pt=function(e){function a(r,n){void 0===n&&(n={});var o=e.call(this,r)||this;return o.format=t.FlipnoteFormat.KWZ,o[Symbol.toStringTag]="Flipnote Studio 3D KWZ animation file",o.imageWidth=a.width,o.imageHeight=a.height,o.imageOffsetX=0,o.imageOffsetY=0,o.numLayers=a.numLayers,o.numLayerColors=a.numLayerColors,o.publicKey=a.publicKey,o.srcWidth=a.width,o.audioTracks=a.audioTracks,o.soundEffectTracks=a.soundEffectTracks,o.rawSampleRate=a.rawSampleRate,o.sampleRate=a.sampleRate,o.globalPalette=a.globalPalette,o.prevDecodedFrame=null,o.bitIndex=0,o.bitValue=0,o.settings=i(i({},a.defaultSettings),n),o.layerBuffers=[new Uint8Array(a.width*a.height),new Uint8Array(a.width*a.height),new Uint8Array(a.width*a.height)],o.buildSectionMap(),o.sectionMap.has("KIC")?(o.isFolderIcon=!0,o.imageWidth=24,o.imageHeight=24,o.frameCount=1,o.frameSpeed=0,o.framerate=Y[0],o.thumbFrameIndex=0,o.getFrameOffsets()):o.sectionMap.has("KSN")?(o.decodeMeta(),o.getFrameOffsets(),o.decodeSoundHeader()):(o.isComment=!0,o.decodeMeta(),o.getFrameOffsets()),o.settings.dsiLibraryNote&&(o.isDsiLibraryNote=!0),o.settings.borderCrop&&(o.isDsiLibraryNote?(o.imageOffsetX=32,o.imageOffsetY=24,o.imageWidth=256,o.imageHeight=192):o.isFolderIcon||(o.imageOffsetX=5,o.imageOffsetY=5,o.imageWidth=310,o.imageHeight=230)),o}return r(a,e),a.prototype.buildSectionMap=function(){for(var t=this.byteLength-256,e=new Map,r=0,i=0;i<t&&r<6;){this.seek(i);var n=this.readChars(4).substring(0,3),o=this.readUint32();e.set(n,{ptr:i,length:o}),i+=o+8,r+=1}this.bodyEndOffset=i,this.sectionMap=e,v(e.has("KMC")&&e.has("KMI"))},a.prototype.readBits=function(t){if(this.bitIndex+t>16){var e=this.readUint16();this.bitValue|=e<<16-this.bitIndex,this.bitIndex-=16}var r=this.bitValue&$[t];return this.bitValue>>=t,this.bitIndex+=t,r},a.prototype.readFsid=function(){if(this.settings.dsiLibraryNote)return this.readHex(10,!0).slice(2,18);var t=this.readHex(10);return(t.slice(0,4)+"-"+t.slice(4,8)+"-"+t.slice(8,12)+"-"+t.slice(12,18)).toLowerCase()},a.prototype.readFilename=function(){var t=this.pointer,e=this.readChars(28);if(28===e.length)return e;this.seek(t);var r=this.readHex(3),i=this.readChars(13),n=this.readUint16().toString().padStart(3,"0");return this.seek(t+28),r+"_"+i+"_"+n},a.prototype.decodeMeta=function(){if(this.settings.quickMeta)return this.decodeMetaQuick();v(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+12);var t=k(this.readUint32()),e=k(this.readUint32());this.readUint32();var r=this.readFsid(),i=this.readFsid(),n=this.readFsid(),o=this.readWideChars(11),a=this.readWideChars(11),s=this.readWideChars(11),u=this.readFilename(),h=this.readFilename(),f=this.readFilename(),c=this.readUint16(),l=this.readUint16(),d=this.readUint16(),p=this.readUint8(),y=this.readUint8();this.isSpinoff=n!==i||n!==r,this.frameCount=c,this.frameSpeed=p,this.framerate=Y[p],this.duration=B(this.frameCount,this.framerate),this.thumbFrameIndex=l,this.layerVisibility={1:0==(1&y),2:0==(2&y),3:0==(3&y)},this.meta={lock:0!=(1&d),loop:0!=(2&d),isSpinoff:this.isSpinoff,frameCount:c,frameSpeed:p,duration:this.duration,thumbIndex:l,timestamp:e,creationTimestamp:t,root:{username:o,fsid:r,region:N(r),filename:u,isDsiFilename:28!==u.length},parent:{username:a,fsid:i,region:N(i),filename:h,isDsiFilename:28!==h.length},current:{username:s,fsid:n,region:N(n),filename:f,isDsiFilename:28!==f.length}}},a.prototype.decodeMetaQuick=function(){v(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+8+196);var t=this.readUint16(),e=this.readUint16();this.readUint16();var r=this.readUint8(),i=this.readUint8();this.frameCount=t,this.thumbFrameIndex=e,this.frameSpeed=r,this.framerate=Y[r],this.duration=B(this.frameCount,this.framerate),this.layerVisibility={1:0==(1&i),2:0==(2&i),3:0==(3&i)}},a.prototype.getFrameOffsets=function(){v(this.sectionMap.has("KMI")&&this.sectionMap.has("KMC"));var t=this.frameCount,e=this.sectionMap.get("KMI"),r=this.sectionMap.get("KMC");v(e.length/28>=t);for(var i=new Uint32Array(t),n=new Uint32Array(t),o=[],a=e.ptr+8,s=r.ptr+12,u=0;u<t;u++){this.seek(a+4);var h=this.readUint16(),f=this.readUint16(),c=this.readUint16();i[u]=a,n[u]=s,s+=h+f+c,v((a+=28)<this.byteLength,"frame"+u+" meta pointer out of bounds"),v(s<this.byteLength,"frame"+u+" data pointer out of bounds"),o.push([h,f,c])}this.frameMetaOffsets=i,this.frameDataOffsets=n,this.frameLayerSizes=o},a.prototype.decodeSoundHeader=function(){v(this.sectionMap.has("KSN"));var e=this.sectionMap.get("KSN").ptr+8;this.seek(e),this.bgmSpeed=this.readUint32(),v(this.bgmSpeed<=10),this.bgmrate=Y[this.bgmSpeed];var r=new Uint32Array(this.buffer,e+4,20),i=new Map;i.set(t.FlipnoteAudioTrack.BGM,{ptr:e+=28,length:r[0]}),i.set(t.FlipnoteAudioTrack.SE1,{ptr:e+=r[0],length:r[1]}),i.set(t.FlipnoteAudioTrack.SE2,{ptr:e+=r[1],length:r[2]}),i.set(t.FlipnoteAudioTrack.SE3,{ptr:e+=r[2],length:r[3]}),i.set(t.FlipnoteAudioTrack.SE4,{ptr:e+=r[3],length:r[4]}),this.soundMeta=i},a.prototype.getFramePaletteIndices=function(t){b(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]);var e=this.readUint32();return[15&e,e>>8&15,e>>12&15,e>>16&15,e>>20&15,e>>24&15,e>>28&15]},a.prototype.getFramePalette=function(t){var e=this;return b(t,0,this.frameCount-1,"Frame index"),this.getFramePaletteIndices(t).map((function(t){return e.globalPalette[t]}))},a.prototype.getFrameDiffingFlag=function(t){return b(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]),this.readUint32()>>4&7},a.prototype.getFrameLayerSizes=function(t){return b(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+4),[this.readUint16(),this.readUint16(),this.readUint16()]},a.prototype.getFrameLayerDepths=function(t){return b(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+20),[this.readUint8(),this.readUint8(),this.readUint8()]},a.prototype.getFrameAuthor=function(t){return b(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+10),this.readFsid()},a.prototype.decodeFrameSoundFlags=function(t){b(t,0,this.frameCount-1,"Frame index"),this.seek(this.frameMetaOffsets[t]+23);var e=this.readUint8();return[0!=(1&e),0!=(2&e),0!=(4&e),0!=(8&e)]},a.prototype.getFrameCameraFlags=function(t){this.seek(this.frameMetaOffsets[t]+26);var e=this.readUint8();return[0!=(1&e),0!=(2&e),0!=(4&e)]},a.prototype.getFrameLayerOrder=function(t){b(t,0,this.frameCount-1,"Frame index");var e=this.getFrameLayerDepths(t);return[2,1,0].sort((function(t,r){return e[r]-e[t]}))},a.prototype.decodeFrame=function(t,e,r){if(void 0===e&&(e=7),void 0===r&&(r=!1),b(t,0,this.frameCount-1,"Frame index"),this.prevDecodedFrame===t)return this.layerBuffers;this.prevDecodedFrame!==t-1&&0!==t&&(r&&(e&=~this.getFrameDiffingFlag(t+1)),0!==e&&this.decodeFrame(t-1,e,!0));for(var i=this.frameDataOffsets[t],n=this.frameLayerSizes[t],o=0;o<3&&(!this.settings.dsiLibraryNote||3!==o);o++){this.seek(i);var s=n[o];i+=s;var u=this.layerBuffers[o];if(38!==s&&0!=(e>>o&1)){this.bitIndex=16,this.bitValue=0;for(var h=0,f=0;f<240;f+=128)for(var c=0;c<320;c+=128)for(var l=0;l<128;l+=8){var d=f+l;if(d>=240)break;for(var p=0;p<128;p+=8){var y=c+p;if(y>=320)break;if(h>0)h-=1;else{var m=d*a.width+y,g=this.readBits(3);if(0===g){var v=8*this.readBits(5),w=ct.subarray(v,v+8);u.set(w,m),u.set(w,m+=320),u.set(w,m+=320),u.set(w,m+=320),u.set(w,m+=320),u.set(w,m+=320),u.set(w,m+=320),u.set(w,m+=320)}else if(1===g){v=8*this.readBits(13),w=tt.subarray(v,v+8);u.set(w,m),u.set(w,m+=320),u.set(w,m+=320),u.set(w,m+=320),u.set(w,m+=320),u.set(w,m+=320),u.set(w,m+=320),u.set(w,m+=320)}else if(2===g){v=8*this.readBits(5);var F=ct.subarray(v,v+8),S=lt.subarray(v,v+8);u.set(F,m),u.set(S,m+=320),u.set(F,m+=320),u.set(S,m+=320),u.set(F,m+=320),u.set(S,m+=320),u.set(F,m+=320),u.set(S,m+=320)}else if(3===g){v=8*this.readBits(13),F=tt.subarray(v,v+8),S=et.subarray(v,v+8);u.set(F,m),u.set(S,m+=320),u.set(F,m+=320),u.set(S,m+=320),u.set(F,m+=320),u.set(S,m+=320),u.set(F,m+=320),u.set(S,m+=320)}else if(4===g)for(var E=this.readBits(8),A=1;A<255;A<<=1){if(E&A){v=8*this.readBits(5),w=ct.subarray(v,v+8);u.set(w,m)}else{v=8*this.readBits(13),w=tt.subarray(v,v+8);u.set(w,m)}m+=320}else{if(5===g){h=this.readBits(5);continue}if(7===g){var P=this.readBits(2);F=void 0,S=void 0;if(0!==this.readBits(1)){var T=8*this.readBits(5),x=8*this.readBits(5);F=ct.subarray(T,T+8),S=ct.subarray(x,x+8),P+=1}else{T=8*this.readBits(13),x=8*this.readBits(13);F=tt.subarray(T,T+8),S=tt.subarray(x,x+8)}switch(P%4){case 0:u.set(F,m),u.set(S,m+=320),u.set(F,m+=320),u.set(S,m+=320),u.set(F,m+=320),u.set(S,m+=320),u.set(F,m+=320),u.set(S,m+=320);break;case 1:u.set(F,m),u.set(F,m+=320),u.set(S,m+=320),u.set(F,m+=320),u.set(F,m+=320),u.set(S,m+=320),u.set(F,m+=320),u.set(F,m+=320);break;case 2:u.set(F,m),u.set(S,m+=320),u.set(F,m+=320),u.set(F,m+=320),u.set(S,m+=320),u.set(F,m+=320),u.set(F,m+=320),u.set(S,m+=320);break;case 3:u.set(F,m),u.set(S,m+=320),u.set(S,m+=320),u.set(F,m+=320),u.set(S,m+=320),u.set(S,m+=320),u.set(F,m+=320),u.set(S,m+=320)}}}}}}}}return this.prevDecodedFrame=t,this.layerBuffers},a.prototype.decodeSoundFlags=function(){var t=this;return void 0!==this.soundFlags||(this.soundFlags=new Array(this.frameCount).fill(!1).map((function(e,r){return t.decodeFrameSoundFlags(r)}))),this.soundFlags},a.prototype.getSoundEffectFlags=function(){return this.decodeSoundFlags().map((function(e){var r;return(r={})[t.FlipnoteSoundEffectTrack.SE1]=e[0],r[t.FlipnoteSoundEffectTrack.SE2]=e[1],r[t.FlipnoteSoundEffectTrack.SE3]=e[2],r[t.FlipnoteSoundEffectTrack.SE4]=e[3],r}))},a.prototype.getFrameSoundEffectFlags=function(e){var r,i=this.decodeFrameSoundFlags(e);return(r={})[t.FlipnoteSoundEffectTrack.SE1]=i[0],r[t.FlipnoteSoundEffectTrack.SE2]=i[1],r[t.FlipnoteSoundEffectTrack.SE3]=i[2],r[t.FlipnoteSoundEffectTrack.SE4]=i[3],r},a.prototype.getAudioTrackRaw=function(t){var e=this.soundMeta.get(t);return v(e.ptr+e.length<this.byteLength),new Uint8Array(this.buffer,e.ptr,e.length)},a.prototype.decodeAdpcm=function(t,e,r,i){void 0===r&&(r=0),void 0===i&&(i=0);for(var n=t.length,o=0,a=0,s=0,u=0,h=0;h<n;h++)for(var p=t[h],y=0;y<8;)i<18||y>4?(a=3&p,u=(s=l[i])>>3,1&a&&(u+=s),2&a&&(u=-u),r+=u,i+=f[a],p>>=2,y+=2):(a=15&p,u=(s=l[i])>>3,1&a&&(u+=s>>2),2&a&&(u+=s>>1),4&a&&(u+=s),8&a&&(u=-u),r+=u,i+=c[a],p>>=4,y+=4),i=d(i,0,79),r=d(r,-2048,2047),e[o]=16*r,o+=1;return o},a.prototype.decodeAudioTrack=function(e){var r=this.settings,i=this.getAudioTrackRaw(e),n=60*this.rawSampleRate,o=new Int16Array(n),a=0,s=40;if(this.isDsiLibraryNote)if(e===t.FlipnoteAudioTrack.BGM){if(null!==r.initialBgmPredictor&&(a=r.initialBgmPredictor),null!==r.initialBgmStepIndex&&(s=r.initialBgmStepIndex),r.guessInitialBgmState){var u=4294967295,h=0;for(s=0;s<=40;s++){var f=this.decodeAdpcm(i,o,a,s),c=g(o.subarray(0,f));c<u&&(u=c,h=s)}s=h}}else{var l=this.soundEffectTracks.indexOf(e);Array.isArray(r.initialSePredictors)&&void 0!==r.initialSePredictors[l]&&(a=r.initialSePredictors[l]),Array.isArray(r.initialSeStepIndices)&&void 0!==r.initialSeStepIndices[l]&&(s=r.initialSeStepIndices[l])}var d=this.decodeAdpcm(i,o,a,s);return o.slice(0,d)},a.prototype.getAudioTrackPcm=function(e,r){void 0===r&&(r=this.sampleRate);var i=this.decodeAudioTrack(e),n=this.rawSampleRate;if(e===t.FlipnoteAudioTrack.BGM){var o=1/this.bgmrate/(1/this.framerate);n=this.rawSampleRate*o}return n!==r?function(t,e,r){for(var i=t.length,n=i/e*r,o=new Int16Array(n),a=e/r,s=0,u=0,h=0,f=0;s<n;s++)u=s*a,h=Math.floor(u),f=u%1,o[s]=p(y(t,i,h),y(t,i,h+1),f);return o}(i,n,r):i},a.prototype.pcmAudioMix=function(t,e,r){void 0===r&&(r=0);for(var i=t.length,n=e.length,o=0;o<i&&!(r+o>n);o++){var a=e[r+o]+t[o];e[r+o]=d(a,-32768,32767)}},a.prototype.getAudioMasterPcm=function(e){void 0===e&&(e=this.sampleRate);var r=Math.ceil(this.duration*e),i=new Int16Array(r),n=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),s=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3),u=this.hasAudioTrack(t.FlipnoteAudioTrack.SE4);if(n){var h=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,e);this.pcmAudioMix(h,i,0)}if(o||a||s||u)for(var f=e/this.framerate,c=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,e):null,l=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,e):null,d=s?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,e):null,p=u?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE4,e):null,y=this.decodeSoundFlags(),g=0;g<this.frameCount;g++){var v=y[g],b=Math.ceil(g*f);o&&v[0]&&this.pcmAudioMix(c,i,b),a&&v[1]&&this.pcmAudioMix(l,i,b),s&&v[2]&&this.pcmAudioMix(d,i,b),u&&v[3]&&this.pcmAudioMix(p,i,b)}return this.audioClipRatio=m(i),i},a.prototype.getBody=function(){var t=this.bodyEndOffset;return this.bytes.subarray(0,t)},a.prototype.getSignature=function(){var t=this.bodyEndOffset;return this.bytes.subarray(t,t+256)},a.prototype.verify=function(){return n(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,x(J,"SHA-256")];case 1:return[4,C(t.sent(),this.getSignature(),this.getBody())];case 2:return[2,t.sent()]}}))}))},a.defaultSettings={quickMeta:!1,dsiLibraryNote:!1,borderCrop:!1,guessInitialBgmState:!0,initialBgmPredictor:null,initialBgmStepIndex:null,initialSePredictors:null,initialSeStepIndices:null},a.format=t.FlipnoteFormat.KWZ,a.width=320,a.height=240,a.numLayers=3,a.numLayerColors=2,a.rawSampleRate=16364,a.sampleRate=32768,a.audioTracks=[t.FlipnoteAudioTrack.BGM,t.FlipnoteAudioTrack.SE1,t.FlipnoteAudioTrack.SE2,t.FlipnoteAudioTrack.SE3,t.FlipnoteAudioTrack.SE4],a.soundEffectTracks=[t.FlipnoteSoundEffectTrack.SE1,t.FlipnoteSoundEffectTrack.SE2,t.FlipnoteSoundEffectTrack.SE3,t.FlipnoteSoundEffectTrack.SE4],a.globalPalette=[Q.WHITE,Q.BLACK,Q.RED,Q.YELLOW,Q.GREEN,Q.BLUE,Q.NONE],a.publicKey=J,a}(K),yt=[{matches:function(t){return F&&"string"==typeof t},load:function(t,e,r){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onreadystatechange=function(t){4===i.readyState&&(i.status>=200&&i.status<300?e(i.response):r({type:"httpError",status:i.status,statusText:i.statusText}))},i.send(null)}},{matches:function(t){return E&&"string"==typeof t},load:function(t,e,r){A(),w(module,"https").get(t,(function(t){var i=[];t.on("data",(function(t){return i.push(t)})),t.on("end",(function(){var t=Buffer.concat(i);e(t.buffer)})),t.on("error",(function(t){return r(t)}))}))}},{matches:function(t){return F&&"undefined"!=typeof File&&"undefined"!=typeof FileReader&&t instanceof File},load:function(t,e,r){var i=new FileReader;i.onload=function(t){e(i.result)},i.onerror=function(t){r({type:"fileReadError"})},i.readAsArrayBuffer(t)}},{matches:function(t){return F&&"undefined"!=typeof Blob&&"undefined"!=typeof Response&&t instanceof Blob},load:function(t,e,r){new Response(t).arrayBuffer().then(e).catch(r)}},{matches:function(t){return E&&t instanceof Buffer},load:function(t,e,r){e(t.buffer)}},{matches:function(t){return t instanceof ArrayBuffer},load:function(t,e,r){e(t)}}];function mt(t,e){return function(t){return new Promise((function(e,r){for(var i=0;i<yt.length;i++){var n=yt[i];if(n.matches(t))return n.load(t,e,r)}r("No loader available for source type")}))}(t).then((function(t){return new Promise((function(r,i){var n=new Uint8Array(t.slice(0,4)),o=n[0]<<24|n[1]<<16|n[2]<<8|n[3];1346458177===o?r(new X(t,e)):1262897152==(4294967040&o)||1263092480==(4294967040&o)?r(new pt(t,e)):i("Could not identify source as a valid Flipnote file")}))}))}t.PlayerEvent=void 0,(dt=t.PlayerEvent||(t.PlayerEvent={})).__Any="any",dt.Play="play",dt.Pause="pause",dt.CanPlay="canplay",dt.CanPlayThrough="canplaythrough",dt.SeekStart="seeking",dt.SeekEnd="seeked",dt.Duration="durationchange",dt.Loop="loop",dt.Ended="ended",dt.VolumeChange="volumechange",dt.Progress="progress",dt.TimeUpdate="timeupdate",dt.FrameUpdate="frameupdate",dt.FrameNext="framenext",dt.FramePrev="frameprev",dt.FrameFirst="framefirst",dt.FrameLast="framelast",dt.Ready="ready",dt.Load="load",dt.LoadStart="loadstart",dt.LoadedData="loadeddata",dt.LoadedMeta="loadedmetadata",dt.Emptied="emptied",dt.Close="close",dt.Error="error",dt.Destroy="destroy";var gt=[t.PlayerEvent.Play,t.PlayerEvent.Pause,t.PlayerEvent.CanPlay,t.PlayerEvent.CanPlayThrough,t.PlayerEvent.SeekStart,t.PlayerEvent.SeekEnd,t.PlayerEvent.Duration,t.PlayerEvent.Loop,t.PlayerEvent.Ended,t.PlayerEvent.VolumeChange,t.PlayerEvent.Progress,t.PlayerEvent.TimeUpdate,t.PlayerEvent.FrameUpdate,t.PlayerEvent.FrameNext,t.PlayerEvent.FramePrev,t.PlayerEvent.FrameFirst,t.PlayerEvent.FrameLast,t.PlayerEvent.Ready,t.PlayerEvent.Load,t.PlayerEvent.LoadStart,t.PlayerEvent.LoadedData,t.PlayerEvent.LoadedMeta,t.PlayerEvent.Emptied,t.PlayerEvent.Close,t.PlayerEvent.Error];function vt(t){return{length:t.length,start:function(e){return t[e][0]},end:function(e){return t[e][1]}}}function bt(t,e){return t.toString().padStart(e,"0")}function wt(t){return Math.floor(t%3600/60)+":"+bt(Math.floor(t%60),2)}var Ft=function(t,e,r){};function St(t){if(t instanceof Int8Array)return 5120;if(t instanceof Uint8Array)return 5121;if(t instanceof Uint8ClampedArray)return 5121;if(t instanceof Int16Array)return 5122;if(t instanceof Uint16Array)return 5123;if(t instanceof Int32Array)return 5124;if(t instanceof Uint32Array)return 5125;if(t instanceof Float32Array)return 5126;throw new Error("unsupported typed array type")}const Et="undefined"!=typeof SharedArrayBuffer?function(t){return t&&t.buffer&&(t.buffer instanceof ArrayBuffer||t.buffer instanceof SharedArrayBuffer)}:function(t){return t&&t.buffer&&t.buffer instanceof ArrayBuffer};function At(t,e){return"undefined"!=typeof WebGLTexture&&e instanceof WebGLTexture}const Pt="";function Tt(t,e,r,i){if(n=e,"undefined"!=typeof WebGLBuffer&&n instanceof WebGLBuffer)return e;var n;r=r||34962;const o=t.createBuffer();return function(t,e,r,i,n){t.bindBuffer(e,r),t.bufferData(e,i,n||35044)}(t,r,o,e,i),o}function xt(t){return"indices"===t}const Ct=/coord|texture/i,Ut=/color|colour/i;function kt(t,e){let r;if(r=Ct.test(t)?2:Ut.test(t)?4:3,e%r>0)throw new Error(`Can not guess numComponents for attribute '${t}'. Tried ${r} but ${e} values is not evenly divisible by ${r}. You should specify it.`);return r}function Bt(t,e){if(Et(t))return t;if(Et(t.data))return t.data;Array.isArray(t)&&(t={data:t});let r=t.type;return r||(r=xt(e)?Uint16Array:Float32Array),new r(t.data)}function _t(t,e){const r={};return Object.keys(e).forEach((function(i){if(!xt(i)){const o=e[i],a=o.attrib||o.name||o.attribName||Pt+i;if(o.value){if(!Array.isArray(o.value)&&!Et(o.value))throw new Error("array.value is not array or typedarray");r[a]={value:o.value}}else{let e,s,u,h;if(o.buffer&&o.buffer instanceof WebGLBuffer)e=o.buffer,h=o.numComponents||o.size,s=o.type,u=o.normalize;else if("number"==typeof o||"number"==typeof o.data){const r=o.data||o,a=o.type||Float32Array,f=r*a.BYTES_PER_ELEMENT;s=function(t){if(t===Int8Array)return 5120;if(t===Uint8Array)return 5121;if(t===Uint8ClampedArray)return 5121;if(t===Int16Array)return 5122;if(t===Uint16Array)return 5123;if(t===Int32Array)return 5124;if(t===Uint32Array)return 5125;if(t===Float32Array)return 5126;throw new Error("unsupported typed array type")}(a),u=void 0!==o.normalize?o.normalize:(n=a)===Int8Array||n===Uint8Array,h=o.numComponents||o.size||kt(i,r),e=t.createBuffer(),t.bindBuffer(34962,e),t.bufferData(34962,f,o.drawType||35044)}else{const r=Bt(o,i);e=Tt(t,r,void 0,o.drawType),s=St(r),u=void 0!==o.normalize?o.normalize:function(t){return t instanceof Int8Array||t instanceof Uint8Array}(r),h=function(t,e){return t.numComponents||t.size||kt(e,function(t){return t.length?t:t.data}(t).length)}(o,i)}r[a]={buffer:e,numComponents:h,type:s,normalize:u,stride:o.stride||0,offset:o.offset||0,divisor:void 0===o.divisor?void 0:o.divisor,drawType:o.drawType}}}var n})),t.bindBuffer(34962,null),r}const Lt=["position","positions","a_position"];function It(t,e,r){const i=_t(t,e),n=Object.assign({},r||{});n.attribs=Object.assign({},r?r.attribs:{},i);const o=e.indices;if(o){const e=Bt(o,"indices");n.indices=Tt(t,e,34963),n.numElements=e.length,n.elementType=St(e)}else n.numElements||(n.numElements=function(t,e){let r,i;for(i=0;i<Lt.length&&(r=Lt[i],!(r in e))&&(r=Pt+r,!(r in e));++i);i===Lt.length&&(r=Object.keys(e)[0]);const n=e[r];t.bindBuffer(34962,n.buffer);const o=t.getBufferParameter(34962,34660);var a;t.bindBuffer(34962,null);const s=o/(5120===(a=n.type)||5121===a?1:5122===a||5123===a?2:5124===a||5125===a||5126===a?4:0),u=n.numComponents||n.size,h=s/u;if(h%1!=0)throw new Error(`numComponents ${u} not correct for length ${length}`);return h}(t,n.attribs));return n}function Mt(t){return!!t.texStorage2D}const Rt={};function Ot(t,e){return Rt[e].bindPoint}function zt(t,e){return function(r){t.uniform1i(e,r)}}function Nt(t,e){return function(r){t.uniform1iv(e,r)}}function Dt(t,e){return function(r){t.uniform2iv(e,r)}}function Wt(t,e){return function(r){t.uniform3iv(e,r)}}function Ht(t,e){return function(r){t.uniform4iv(e,r)}}function jt(t,e,r,i){const n=Ot(0,e);return Mt(t)?function(e){let o,a;At(0,e)?(o=e,a=null):(o=e.texture,a=e.sampler),t.uniform1i(i,r),t.activeTexture(33984+r),t.bindTexture(n,o),t.bindSampler(r,a)}:function(e){t.uniform1i(i,r),t.activeTexture(33984+r),t.bindTexture(n,e)}}function Kt(t,e,r,i,n){const o=Ot(0,e),a=new Int32Array(n);for(let t=0;t<n;++t)a[t]=r+t;return Mt(t)?function(e){t.uniform1iv(i,a),e.forEach((function(e,i){let n,s;t.activeTexture(33984+a[i]),At(0,e)?(n=e,s=null):(n=e.texture,s=e.sampler),t.bindSampler(r,s),t.bindTexture(o,n)}))}:function(e){t.uniform1iv(i,a),e.forEach((function(e,r){t.activeTexture(33984+a[r]),t.bindTexture(o,e)}))}}function Vt(t,e){return function(r){if(r.value)switch(t.disableVertexAttribArray(e),r.value.length){case 4:t.vertexAttrib4fv(e,r.value);break;case 3:t.vertexAttrib3fv(e,r.value);break;case 2:t.vertexAttrib2fv(e,r.value);break;case 1:t.vertexAttrib1fv(e,r.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else t.bindBuffer(34962,r.buffer),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,r.numComponents||r.size,r.type||5126,r.normalize||!1,r.stride||0,r.offset||0),void 0!==r.divisor&&t.vertexAttribDivisor(e,r.divisor)}}function Gt(t,e){return function(r){if(r.value){if(t.disableVertexAttribArray(e),4!==r.value.length)throw new Error("The length of an integer constant value must be 4!");t.vertexAttrib4iv(e,r.value)}else t.bindBuffer(34962,r.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,r.numComponents||r.size,r.type||5124,r.stride||0,r.offset||0),void 0!==r.divisor&&t.vertexAttribDivisor(e,r.divisor)}}function qt(t,e){return function(r){if(r.value){if(t.disableVertexAttribArray(e),4!==r.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");t.vertexAttrib4uiv(e,r.value)}else t.bindBuffer(34962,r.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,r.numComponents||r.size,r.type||5125,r.stride||0,r.offset||0),void 0!==r.divisor&&t.vertexAttribDivisor(e,r.divisor)}}function Xt(t,e,r){const i=r.size,n=r.count;return function(r){t.bindBuffer(34962,r.buffer);const o=r.size||r.numComponents||i,a=o/n,s=r.type||5126,u=Rt[s].size*o,h=r.normalize||!1,f=r.offset||0,c=u/n;for(let i=0;i<n;++i)t.enableVertexAttribArray(e+i),t.vertexAttribPointer(e+i,a,s,h,u,f+c*i),void 0!==r.divisor&&t.vertexAttribDivisor(e+i,r.divisor)}}Rt[5126]={Type:Float32Array,size:4,setter:function(t,e){return function(r){t.uniform1f(e,r)}},arraySetter:function(t,e){return function(r){t.uniform1fv(e,r)}}},Rt[35664]={Type:Float32Array,size:8,setter:function(t,e){return function(r){t.uniform2fv(e,r)}},cols:2},Rt[35665]={Type:Float32Array,size:12,setter:function(t,e){return function(r){t.uniform3fv(e,r)}},cols:3},Rt[35666]={Type:Float32Array,size:16,setter:function(t,e){return function(r){t.uniform4fv(e,r)}},cols:4},Rt[5124]={Type:Int32Array,size:4,setter:zt,arraySetter:Nt},Rt[35667]={Type:Int32Array,size:8,setter:Dt,cols:2},Rt[35668]={Type:Int32Array,size:12,setter:Wt,cols:3},Rt[35669]={Type:Int32Array,size:16,setter:Ht,cols:4},Rt[5125]={Type:Uint32Array,size:4,setter:function(t,e){return function(r){t.uniform1ui(e,r)}},arraySetter:function(t,e){return function(r){t.uniform1uiv(e,r)}}},Rt[36294]={Type:Uint32Array,size:8,setter:function(t,e){return function(r){t.uniform2uiv(e,r)}},cols:2},Rt[36295]={Type:Uint32Array,size:12,setter:function(t,e){return function(r){t.uniform3uiv(e,r)}},cols:3},Rt[36296]={Type:Uint32Array,size:16,setter:function(t,e){return function(r){t.uniform4uiv(e,r)}},cols:4},Rt[35670]={Type:Uint32Array,size:4,setter:zt,arraySetter:Nt},Rt[35671]={Type:Uint32Array,size:8,setter:Dt,cols:2},Rt[35672]={Type:Uint32Array,size:12,setter:Wt,cols:3},Rt[35673]={Type:Uint32Array,size:16,setter:Ht,cols:4},Rt[35674]={Type:Float32Array,size:32,setter:function(t,e){return function(r){t.uniformMatrix2fv(e,!1,r)}},rows:2,cols:2},Rt[35675]={Type:Float32Array,size:48,setter:function(t,e){return function(r){t.uniformMatrix3fv(e,!1,r)}},rows:3,cols:3},Rt[35676]={Type:Float32Array,size:64,setter:function(t,e){return function(r){t.uniformMatrix4fv(e,!1,r)}},rows:4,cols:4},Rt[35685]={Type:Float32Array,size:32,setter:function(t,e){return function(r){t.uniformMatrix2x3fv(e,!1,r)}},rows:2,cols:3},Rt[35686]={Type:Float32Array,size:32,setter:function(t,e){return function(r){t.uniformMatrix2x4fv(e,!1,r)}},rows:2,cols:4},Rt[35687]={Type:Float32Array,size:48,setter:function(t,e){return function(r){t.uniformMatrix3x2fv(e,!1,r)}},rows:3,cols:2},Rt[35688]={Type:Float32Array,size:48,setter:function(t,e){return function(r){t.uniformMatrix3x4fv(e,!1,r)}},rows:3,cols:4},Rt[35689]={Type:Float32Array,size:64,setter:function(t,e){return function(r){t.uniformMatrix4x2fv(e,!1,r)}},rows:4,cols:2},Rt[35690]={Type:Float32Array,size:64,setter:function(t,e){return function(r){t.uniformMatrix4x3fv(e,!1,r)}},rows:4,cols:3},Rt[35678]={Type:null,size:0,setter:jt,arraySetter:Kt,bindPoint:3553},Rt[35680]={Type:null,size:0,setter:jt,arraySetter:Kt,bindPoint:34067},Rt[35679]={Type:null,size:0,setter:jt,arraySetter:Kt,bindPoint:32879},Rt[35682]={Type:null,size:0,setter:jt,arraySetter:Kt,bindPoint:3553},Rt[36289]={Type:null,size:0,setter:jt,arraySetter:Kt,bindPoint:35866},Rt[36292]={Type:null,size:0,setter:jt,arraySetter:Kt,bindPoint:35866},Rt[36293]={Type:null,size:0,setter:jt,arraySetter:Kt,bindPoint:34067},Rt[36298]={Type:null,size:0,setter:jt,arraySetter:Kt,bindPoint:3553},Rt[36299]={Type:null,size:0,setter:jt,arraySetter:Kt,bindPoint:32879},Rt[36300]={Type:null,size:0,setter:jt,arraySetter:Kt,bindPoint:34067},Rt[36303]={Type:null,size:0,setter:jt,arraySetter:Kt,bindPoint:35866},Rt[36306]={Type:null,size:0,setter:jt,arraySetter:Kt,bindPoint:3553},Rt[36307]={Type:null,size:0,setter:jt,arraySetter:Kt,bindPoint:32879},Rt[36308]={Type:null,size:0,setter:jt,arraySetter:Kt,bindPoint:34067},Rt[36311]={Type:null,size:0,setter:jt,arraySetter:Kt,bindPoint:35866};const Yt={};function Qt(t){const e=t.name;return e.startsWith("gl_")||e.startsWith("webgl_")}Yt[5126]={size:4,setter:Vt},Yt[35664]={size:8,setter:Vt},Yt[35665]={size:12,setter:Vt},Yt[35666]={size:16,setter:Vt},Yt[5124]={size:4,setter:Gt},Yt[35667]={size:8,setter:Gt},Yt[35668]={size:12,setter:Gt},Yt[35669]={size:16,setter:Gt},Yt[5125]={size:4,setter:qt},Yt[36294]={size:8,setter:qt},Yt[36295]={size:12,setter:qt},Yt[36296]={size:16,setter:qt},Yt[35670]={size:4,setter:Gt},Yt[35671]={size:8,setter:Gt},Yt[35672]={size:12,setter:Gt},Yt[35673]={size:16,setter:Gt},Yt[35674]={size:4,setter:Xt,count:2},Yt[35675]={size:9,setter:Xt,count:3},Yt[35676]={size:16,setter:Xt,count:4};const Jt=/(\.|\[|]|\w+)/g;function $t(t,e,r,i){const n=t.split(Jt).filter(t=>""!==t);let o=0,a="";for(;;){const t=n[o++];a+=t;const u=(s=t[0])>="0"&&s<="9",h=u?parseInt(t):t;u&&(a+=n[o++]);if(o===n.length){r[h]=e;break}{const t=n[o++],e="["===t,s=r[h]||(e?[]:{});r[h]=s,r=s,i[a]=i[a]||function(t){return function(e){Zt(t,e)}}(s),a+=t}}var s}function Zt(t,e){for(const r in e){const i=t[r];"function"==typeof i?i(e[r]):Zt(t[r],e[r])}}function te(t,e){const r={program:e,uniformSetters:function(t,e){let r=0;function i(e,i,n){const o=i.name.endsWith("[0]"),a=i.type,s=Rt[a];if(!s)throw new Error("unknown type: 0x"+a.toString(16));let u;if(s.bindPoint){const e=r;r+=i.size,u=o?s.arraySetter(t,a,e,n,i.size):s.setter(t,a,e,n,i.size)}else u=s.arraySetter&&o?s.arraySetter(t,n):s.setter(t,n);return u.location=n,u}const n={},o={},a=t.getProgramParameter(e,35718);for(let r=0;r<a;++r){const a=t.getActiveUniform(e,r);if(Qt(a))continue;let s=a.name;s.endsWith("[0]")&&(s=s.substr(0,s.length-3));const u=t.getUniformLocation(e,a.name);if(u){const t=i(0,a,u);n[s]=t,$t(s,t,o,n)}}return n}(t,e),attribSetters:function(t,e){const r={},i=t.getProgramParameter(e,35721);for(let n=0;n<i;++n){const i=t.getActiveAttrib(e,n);if(Qt(i))continue;const o=t.getAttribLocation(e,i.name),a=Yt[i.type],s=a.setter(t,o,a);s.location=o,r[i.name]=s}return r}(t,e)};return Mt(t)&&(r.uniformBlockSpec=function(t,e){const r=t.getProgramParameter(e,35718),i=[],n=[];for(let o=0;o<r;++o){n.push(o),i.push({});const r=t.getActiveUniform(e,o);i[o].name=r.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(r){const o=r[0],a=r[1];t.getActiveUniforms(e,n,t[o]).forEach((function(t,e){i[e][a]=t}))}));const o={},a=t.getProgramParameter(e,35382);for(let r=0;r<a;++r){const i=t.getActiveUniformBlockName(e,r),n={index:t.getUniformBlockIndex(e,i),usedByVertexShader:t.getActiveUniformBlockParameter(e,r,35396),usedByFragmentShader:t.getActiveUniformBlockParameter(e,r,35398),size:t.getActiveUniformBlockParameter(e,r,35392),uniformIndices:t.getActiveUniformBlockParameter(e,r,35395)};n.used=n.usedByVertexShader||n.usedByFragmentShader,o[i]=n}return{blockSpecs:o,uniformData:i}}(t,e),r.transformFeedbackInfo=function(t,e){const r={},i=t.getProgramParameter(e,35971);for(let n=0;n<i;++n){const i=t.getTransformFeedbackVarying(e,n);r[i.name]={index:n,type:i.type,size:i.size}}return r}(t,e)),r}var ee=function(){function t(e,r,n,o){var a=this;void 0===r&&(r=640),void 0===n&&(n=480),void 0===o&&(o={}),this.paletteBuffer=new Uint32Array(16),this.refs={programs:[],shaders:[],textures:[],buffers:[]},this.isCtxLost=!1,this.handleContextLoss=function(t){t&&t.preventDefault(),a.destroy(),a.isCtxLost||a.options.onlost(),a.isCtxLost=!0},this.handleContextRestored=function(t){a.isCtxLost=!1,a.init(),a.options.onrestored()},S(),this.options=i(i({},t.defaultOptions),o),this.width=r,this.height=n,this.canvas=document.createElement("canvas"),this.canvas.addEventListener("webglcontextlost",this.handleContextLoss,!1),this.canvas.addEventListener("webglcontextrestored",this.handleContextRestored,!1),this.canvas.className="FlipnoteCanvas FlipnoteCanvas--webgl",this.gl=this.canvas.getContext("webgl",{antialias:!1,alpha:!0}),e&&e.appendChild(this.canvas),this.init()}return t.isSupported=function(){if(!F)return!1;var t=document.createElement("canvas"),e=t.getContext("2d"),r=null!==e;return t=null,e=null,r},t.prototype.init=function(){this.setCanvasSize(this.width,this.height);var t=this.gl;this.checkContextLoss()||(this.program=this.createProgram("#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_texel;varying vec2 v_uv;varying float v_scale;uniform bool u_flipY;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){v_uv=texcoord;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);gl_Position=position;if(u_flipY){gl_Position.y*=-1.;}}","precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 v_texel=v_uv*u_textureSize;vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;gl_FragColor=texture2D(u_tex,coord);}"),this.quadBuffer=this.createScreenQuad(-1,-1,2,2,1,1),this.setBuffersAndAttribs(this.program,this.quadBuffer),this.frameTexture=this.createTexture(t.RGBA,t.LINEAR,t.CLAMP_TO_EDGE),t.useProgram(this.program.program),t.bindTexture(t.TEXTURE_2D,this.frameTexture))},t.prototype.createProgram=function(t,e){if(!this.checkContextLoss()){var r=this.gl,i=this.createShader(r.VERTEX_SHADER,t),n=this.createShader(r.FRAGMENT_SHADER,e),o=r.createProgram();if(r.attachShader(o,i),r.attachShader(o,n),r.linkProgram(o),!r.getProgramParameter(o,r.LINK_STATUS)){var a=r.getProgramInfoLog(o);throw r.deleteProgram(o),new Error(a)}var s=te(r,o);return this.refs.programs.push(o),s}},t.prototype.createShader=function(t,e){if(!this.checkContextLoss()){var r=this.gl,i=r.createShader(t);if(r.shaderSource(i,e),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS)){var n=r.getShaderInfoLog(i);throw r.deleteShader(i),new Error(n)}return this.refs.shaders.push(i),i}},t.prototype.createScreenQuad=function(t,e,r,i,n,o){if(!this.checkContextLoss()){for(var a=(n+1)*(o+1),s=n+1,u=new Float32Array(2*a),h=new Float32Array(2*a),f=0,c=0,l=0;l<=o;l++)for(var d=0;d<=n;d++){var p=d/n,y=l/o;u[f++]=t+r*p,u[f++]=e+i*y,h[c++]=p,h[c++]=y}var m=new Uint16Array(n*o*2*3),g=0;for(l=0;l<o;l++)for(d=0;d<n;d++)m[g++]=(l+0)*s+d,m[g++]=(l+1)*s+d,m[g++]=(l+0)*s+d+1,m[g++]=(l+0)*s+d+1,m[g++]=(l+1)*s+d,m[g++]=(l+1)*s+d+1;var v=It(this.gl,{position:{numComponents:2,data:u},texcoord:{numComponents:2,data:h},indices:m});for(var b in v.attribs)this.refs.buffers.push(v.attribs[b].buffer);return v}},t.prototype.setBuffersAndAttribs=function(t,e){if(!this.checkContextLoss()){var r=this.gl;!function(t,e){for(const r in e){const i=t[r];i&&i(e[r])}}(t.attribSetters,e.attribs),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,e.indices)}},t.prototype.createTexture=function(t,e,r,i,n){if(void 0===i&&(i=1),void 0===n&&(n=1),!this.checkContextLoss()){var o=this.gl,a=o.createTexture();return o.bindTexture(o.TEXTURE_2D,a),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,r),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,r),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,e),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,e),o.texImage2D(o.TEXTURE_2D,0,t,i,n,0,t,o.UNSIGNED_BYTE,null),this.refs.textures.push(a),a}},t.prototype.setCanvasSize=function(t,e){var r=this.options.useDpi&&window.devicePixelRatio||1,i=t*r,n=e*r;this.width=t,this.height=e,this.canvas.width=i,this.canvas.height=n,this.dstWidth=i,this.dstHeight=n,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px";var o=this.gl;this.checkContextLoss()||o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight)},t.prototype.setNote=function(t){if(!this.checkContextLoss()){var e=this.gl,r=t.imageWidth,i=t.imageHeight;this.note=t,this.srcWidth=r,this.srcHeight=i,e.bindTexture(e.TEXTURE_2D,this.frameTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.srcWidth,this.srcHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),this.frameBuffer=new Uint32Array(r*i),this.frameBufferBytes=new Uint8Array(this.frameBuffer.buffer),this.prevFrameIndex=void 0,this.canvas.title=t.getTitle()}},t.prototype.clear=function(t){if(!this.checkContextLoss()){if(t){var e=a(t,4),r=e[0],i=e[1],n=e[2],o=e[3];this.gl.clearColor(r/255,i/255,n/255,o/255)}this.gl.clear(this.gl.COLOR_BUFFER_BIT)}},t.prototype.drawFrame=function(t){if(!this.checkContextLoss()){var e=this.gl,r=this.srcWidth,i=this.srcHeight;this.note.getFramePixelsRgba(t,this.frameBuffer,this.paletteBuffer),e.clear(this.gl.COLOR_BUFFER_BIT),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,r,i,0,e.RGBA,e.UNSIGNED_BYTE,this.frameBufferBytes),function t(e,...r){const i=e.uniformSetters||e,n=r.length;for(let e=0;e<n;++e){const n=r[e];if(Array.isArray(n)){const e=n.length;for(let r=0;r<e;++r)t(i,n[r])}else for(const t in n){const e=i[t];e&&e(n[t])}}}(this.program,{u_flipY:!0,u_tex:this.frameTexture,u_textureSize:[this.srcWidth,this.srcHeight],u_screenSize:[e.drawingBufferWidth,e.drawingBufferHeight]}),e.drawElements(e.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0),this.prevFrameIndex=t}},t.prototype.forceUpdate=function(){void 0!==this.prevFrameIndex&&this.drawFrame(this.prevFrameIndex)},t.prototype.isErrorState=function(){var t=this.gl;return null===t||t.getError()!==t.NO_ERROR},t.prototype.checkContextLoss=function(){var t=this.isCtxLost||this.isErrorState();return t&&this.handleContextLoss(),t},t.prototype.getDataUrl=function(t,e){return this.canvas.toDataURL(t,e)},t.prototype.getBlob=function(t,e){return n(this,void 0,void 0,(function(){var r=this;return o(this,(function(i){return[2,new Promise((function(i,n){return r.canvas.toBlob(i,t,e)}))]}))}))},t.prototype.destroy=function(){var t=this.refs,e=this.gl,r=this.canvas;t.shaders.forEach((function(t){e.deleteShader(t)})),t.shaders=[],t.textures.forEach((function(t){e.deleteTexture(t)})),t.textures=[],t.buffers.forEach((function(t){e.deleteBuffer(t)})),t.buffers=[],t.programs.forEach((function(t){e.deleteProgram(t)})),t.programs=[],this.paletteBuffer=null,this.frameBuffer=null,this.frameBufferBytes=null,r&&r.parentElement&&(r.width=1,r.height=1,r.parentNode.removeChild(r))},t.defaultOptions={onlost:function(){},onrestored:function(){},useDpi:!0},t}(),re=function(){function t(e,r,n,o){void 0===o&&(o={}),this.paletteBuffer=new Uint32Array(16),S(),this.options=i(i({},t.defaultOptions),o),this.width=r,this.height=n,this.canvas=document.createElement("canvas"),this.canvas.className="FlipnoteCanvas FlipnoteCanvas--html5",this.ctx=this.canvas.getContext("2d"),this.srcCanvas=document.createElement("canvas"),this.srcCtx=this.srcCanvas.getContext("2d"),v(null!==this.ctx&&null!==this.srcCtx,"Could not create HTML5 canvas"),e&&e.appendChild(this.canvas),this.setCanvasSize(r,n)}return t.isSupported=function(){if(!F)return!1;var t=document.createElement("canvas"),e=t.getContext("2d"),r=null!==e;return t=null,e=null,r},t.prototype.setCanvasSize=function(t,e){var r=this.canvas,i=this.options.useDpi&&window.devicePixelRatio||1,n=t*i,o=e*i;this.width=t,this.height=e,this.dstWidth=n,this.dstHeight=o,r.style.width=t+"px",r.style.height=e+"px",r.width=n,r.height=o},t.prototype.setNote=function(t){var e=t.imageWidth,r=t.imageHeight;this.note=t,this.srcWidth=e,this.srcHeight=r,this.srcCanvas.width=e,this.srcCanvas.height=r,this.frameImage=this.srcCtx.createImageData(e,r),this.frameBuffer=new Uint32Array(this.frameImage.data.buffer),this.prevFrameIndex=void 0,this.canvas.title=t.getTitle()},t.prototype.clear=function(t){if(this.frameBuffer.fill(0),this.ctx.clearRect(0,0,this.dstWidth,this.dstHeight),t){var e=a(t,4),r=e[0],i=e[1],n=e[2],o=e[3];this.ctx.fillStyle="rgba("+r+", "+i+", "+n+", "+o+")",this.ctx.fillRect(0,0,this.dstWidth,this.dstHeight)}},t.prototype.drawFrame=function(t){this.clear(),this.options.useSmoothing||(this.ctx.imageSmoothingEnabled=!1),this.note.getFramePixelsRgba(t,this.frameBuffer,this.paletteBuffer),this.srcCtx.putImageData(this.frameImage,0,0),this.ctx.drawImage(this.srcCanvas,0,0,this.srcWidth,this.srcHeight,0,0,this.dstWidth,this.dstHeight),this.prevFrameIndex=t},t.prototype.forceUpdate=function(){void 0!==this.prevFrameIndex&&this.drawFrame(this.prevFrameIndex)},t.prototype.getDataUrl=function(t,e){return this.canvas.toDataURL(t,e)},t.prototype.getBlob=function(t,e){return n(this,void 0,void 0,(function(){var r=this;return o(this,(function(i){return[2,new Promise((function(i,n){return r.canvas.toBlob(i,t,e)}))]}))}))},t.prototype.destroy=function(){this.frameImage=null,this.paletteBuffer=null,this.frameBuffer=null,this.canvas.parentNode.removeChild(this.canvas),this.canvas.width=1,this.canvas.height=1,this.canvas=null,this.srcCanvas.width=1,this.srcCanvas.height=1,this.srcCanvas=null},t.defaultOptions={useDpi:!0,useSmoothing:!0},t}(),ie=function(){function t(t,e,r,n){var o=this;void 0===e&&(e=640),void 0===r&&(r=480),void 0===n&&(n={}),this.options={},this.isReady=!1,this.isHtml5=!1,this.parent=t,this.options=n;try{this.renderer=new ee(t,e,r,i(i({},n),{onlost:function(){if(console.warn("WebGL failed, attempting HTML5 fallback"),!o.isReady||o.isHtml5)throw"";o.switchToHtml5()}}))}catch(t){this.switchToHtml5()}this.isReady=!0}return t.prototype.switchToHtml5=function(){var t,e=new re(this.parent,this.width,this.height,this.options);this.note&&(e.setNote(this.note),e.prevFrameIndex=null===(t=this.renderer)||void 0===t?void 0:t.prevFrameIndex,e.forceUpdate()),this.isHtml5=!0,this.renderer=e},t.prototype.setCanvasSize=function(t,e){var r=this.renderer;r.setCanvasSize(t,e),this.width=t,this.width=e,this.dstWidth=r.dstWidth,this.dstHeight=r.dstHeight},t.prototype.setNote=function(t){this.note=t,this.renderer.setNote(t),this.prevFrameIndex=void 0,this.srcWidth=this.renderer.srcWidth,this.srcHeight=this.renderer.srcHeight},t.prototype.clear=function(t){this.renderer.clear(t)},t.prototype.drawFrame=function(t){this.renderer.drawFrame(t),this.prevFrameIndex=t},t.prototype.forceUpdate=function(){this.renderer.forceUpdate()},t.prototype.getDataUrl=function(t,e){return this.renderer.getDataUrl()},t.prototype.getBlob=function(t,e){return n(this,void 0,void 0,(function(){return o(this,(function(t){return[2,this.renderer.getBlob()]}))}))},t.prototype.destroy=function(){this.renderer.destroy(),this.note=null},t}(),ne=F?window.AudioContext||window.webkitAudioContext:null,oe=function(){function t(){this.useEq=!1,this.useAnalyser=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],this._volume=1,this._loop=!1,this._startTime=0,this._ctxStartTime=0,this.nodeRefs=[],S()}return Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume},set:function(t){this.setVolume(t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=t,this.source&&(this.source.loop=t)},enumerable:!1,configurable:!0}),t.prototype.getCtx=function(){return this.ctx||(this.ctx=new ne),this.ctx},t.prototype.setBuffer=function(t,e){var r=this.getCtx(),i=t.length,n=r.createBuffer(1,i,e),o=n.getChannelData(0);if(t instanceof Float32Array)o.set(t,0);else if(t instanceof Int16Array)for(var a=0;a<i;a++)o[a]=t[a]/32768;this.buffer=n,this.sampleRate=e},t.prototype.connectEqNodesTo=function(t){var e=this,r=this.getCtx(),i=this.eqSettings,n=t;return i.forEach((function(t,o){var s=a(t,2),u=s[0],h=s[1],f=r.createBiquadFilter();e.nodeRefs.push(f),f.frequency.value=u,f.gain.value=h,0===o?f.type="lowshelf":o===i.length-1?f.type="highshelf":f.type="peaking",n.connect(f),n=f})),n},t.prototype.initNodes=function(){var t=this.getCtx();this.nodeRefs=[];var e=t.createBufferSource();this.nodeRefs.push(e),e.buffer=this.buffer;var r=t.createGain();(this.nodeRefs.push(r),this.useEq)?this.connectEqNodesTo(e).connect(r):e.connect(r);if(this.useAnalyser){var i=t.createAnalyser();this.nodeRefs.push(i),this.analyser=i,r.connect(i),i.connect(t.destination)}else this.analyser=void 0,r.connect(t.destination);this.source=e,this.gainNode=r,this.setVolume(this._volume)},t.prototype.setAnalyserEnabled=function(t){this.useAnalyser=t,this.initNodes()},t.prototype.setVolume=function(t){this._volume=t,this.gainNode&&(this.gainNode.gain.value=Math.pow(t,2))},t.prototype.playFrom=function(t){this.initNodes(),this._startTime=t,this._ctxStartTime=this.ctx.currentTime,this.source.loop=this._loop,this.source.start(0,t)},t.prototype.stop=function(){this.source&&this.source.stop(0)},t.prototype.getCurrentTime=function(){return this._startTime+(this.ctx.currentTime-this._ctxStartTime)},t.prototype.destroy=function(){return n(this,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return this.stop(),t=this.getCtx(),this.nodeRefs.forEach((function(t){return t.disconnect()})),this.nodeRefs=[],this.analyser=void 0,"closed"===t.state||"function"!=typeof t.close?[3,2]:[4,t.close()];case 1:e.sent(),e.label=2;case 2:return this.buffer=null,[2]}}))}))},t}(),ae=function(){function e(e,r,i,n){var o=this;void 0===n&&(n={}),this.duration=0,this.autoplay=!1,this.supportedEvents=gt,this._src=null,this._loop=!1,this._volume=1,this._muted=!1,this._frame=null,this._hasEnded=!1,this.isNoteLoaded=!1,this.events=new Map,this.playbackStartTime=0,this.playbackTime=0,this.playbackLoopId=null,this.showThumbnail=!0,this.hasPlaybackStarted=!1,this.isPlaying=!1,this.wasPlaying=!1,this.isSeeking=!1,this.playbackLoop=function(e){if(o.isPlaying){var r=e/1e3,i=o.duration,n=o.audio.getCurrentTime(),a=r-o.playbackStartTime;if(Math.abs(a%i-n%i)>.01&&(a=n),a>=i){if(!o.loop)return o.pause(),o._hasEnded=!0,void o.emit(t.PlayerEvent.Ended);o.playbackStartTime=r,o.emit(t.PlayerEvent.Loop)}o.setCurrentTime(a%i),o.playbackLoopId=requestAnimationFrame(o.playbackLoop)}},S();var a="string"==typeof e?document.querySelector(e):e;this.parserSettings=n,this.renderer=new ie(a,r,i,{onlost:function(){return o.emit(t.PlayerEvent.Error)},onrestored:function(){return o.load()}}),this.audio=new oe,this.el=a}return Object.defineProperty(e.prototype,"src",{get:function(){return this._src},set:function(t){this.load(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"paused",{get:function(){return!this.isPlaying},set:function(t){t?this.pause():this.play()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentFrame",{get:function(){return this._frame},set:function(t){this.setCurrentFrame(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentTime",{get:function(){return this.isNoteLoaded?this.playbackTime:null},set:function(t){this.setCurrentTime(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"progress",{get:function(){return this.isNoteLoaded?this.playbackTime/this.duration*100:null},set:function(t){this.setProgress(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"volume",{get:function(){return this.getVolume()},set:function(t){this.setVolume(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"muted",{get:function(){return this.getMuted()},set:function(t){this.setMuted(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loop",{get:function(){return this.getLoop()},set:function(t){this.setLoop(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"framerate",{get:function(){return this.note.framerate},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frameCount",{get:function(){return this.note.frameCount},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frameSpeed",{get:function(){return this.note.frameSpeed},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"buffered",{get:function(){return vt([[0,this.duration]])},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"seekable",{get:function(){return vt([[0,this.duration]])},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentSrc",{get:function(){return this._src},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"videoWidth",{get:function(){return this.isNoteLoaded?this.note.imageWidth:0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"videoHeight",{get:function(){return this.isNoteLoaded?this.note.imageHeight:0},enumerable:!1,configurable:!0}),e.prototype.load=function(e){return void 0===e&&(e=null),n(this,void 0,void 0,(function(){var r=this;return o(this,(function(i){return this.isNoteLoaded&&this.closeNote(),this._src=e,e?(this.emit(t.PlayerEvent.LoadStart),[2,mt(e,this.parserSettings).then((function(t){r.openNote(t)})).catch((function(e){throw r.emit(t.PlayerEvent.Error,e),new Error("Error loading Flipnote: "+e.message)}))]):[2,this.openNote(this.note)]}))}))},e.prototype.reload=function(){return n(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return this.note?[4,this.load(this.note.buffer)]:[3,2];case 1:return[2,t.sent()];case 2:return[2]}}))}))},e.prototype.updateSettings=function(t){return n(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return this.parserSettings=t,[4,this.reload()];case 1:return[2,e.sent()]}}))}))},e.prototype.closeNote=function(){this.pause(),this.note=null,this.isNoteLoaded=!1,this.meta=null,this._src=null,this._frame=0,this.playbackTime=0,this.duration=0,this.loop=!1,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.showThumbnail=!0,this.renderer.clear()},e.prototype.openNote=function(e){this.isNoteLoaded&&this.closeNote(),this.note=e,this.meta=e.meta,this.emit(t.PlayerEvent.LoadedMeta),this.noteFormat=e.format,this.duration=e.duration,this.playbackTime=0,this._frame=0,this.isNoteLoaded=!0,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.layerVisibility=e.layerVisibility,this.showThumbnail=!0,this.audio.setBuffer(e.getAudioMasterPcm(),e.sampleRate),this.emit(t.PlayerEvent.CanPlay),this.emit(t.PlayerEvent.CanPlayThrough),this.setLoop(e.meta.loop),this.renderer.setNote(e),this.drawFrame(e.thumbFrameIndex),this.emit(t.PlayerEvent.LoadedData),this.emit(t.PlayerEvent.Load),this.emit(t.PlayerEvent.Ready),this.autoplay&&this.play()},e.prototype.setCurrentTime=function(e){this.assertNoteLoaded();var r=Math.floor(e/(1/this.framerate));this.setCurrentFrame(r),this.playbackTime=e,this.emit(t.PlayerEvent.Progress,this.progress)},e.prototype.getCurrentTime=function(){return this.currentTime},e.prototype.getTimeCounter=function(){return wt(Math.max(this.currentTime,0))+" / "+wt(this.duration)},e.prototype.getFrameCounter=function(){return bt(this.currentFrame+1,3)+" / "+bt(this.frameCount,3)},e.prototype.setProgress=function(t){this.assertNoteLoaded(),b(t,0,100,"progress"),this.currentTime=this.duration*(t/100)},e.prototype.getProgress=function(){return this.progress},e.prototype.play=function(){return n(this,void 0,void 0,(function(){var e;return o(this,(function(r){return this.assertNoteLoaded(),this.isPlaying||(this._hasEnded&&(this.playbackTime=0,this._hasEnded=!1),e=performance.now(),this.playbackStartTime=e/1e3-this.playbackTime,this.isPlaying=!0,this.hasPlaybackStarted=!0,this.playAudio(),this.playbackLoop(e),this.emit(t.PlayerEvent.Play)),[2]}))}))},e.prototype.pause=function(){this.isPlaying&&(this.isPlaying=!1,null!==this.playbackLoopId&&cancelAnimationFrame(this.playbackLoopId),this.stopAudio(),this.emit(t.PlayerEvent.Pause))},e.prototype.togglePlay=function(){this.isPlaying?this.pause():this.play()},e.prototype.getPaused=function(){return!this.isPlaying},e.prototype.getDuration=function(){return this.duration},e.prototype.getLoop=function(){return this._loop},e.prototype.setLoop=function(t){this._loop=t,this.audio.loop=t},e.prototype.toggleLoop=function(){this.setLoop(!this._loop)},e.prototype.setCurrentFrame=function(e){this.assertNoteLoaded();var r=Math.max(0,Math.min(Math.floor(e),this.frameCount-1));(r!==this.currentFrame||this.showThumbnail)&&(this._frame=r,this.drawFrame(r),this.showThumbnail=!1,this.isPlaying||(this.playbackTime=r*(1/this.framerate),this.emit(t.PlayerEvent.SeekEnd)),this.emit(t.PlayerEvent.FrameUpdate,this.currentFrame),this.emit(t.PlayerEvent.Progress,this.progress),this.emit(t.PlayerEvent.TimeUpdate,this.currentFrame))},e.prototype.nextFrame=function(){this.loop&&this.currentFrame===this.frameCount-1?this.currentFrame=0:this.currentFrame+=1,this.emit(t.PlayerEvent.FrameNext)},e.prototype.prevFrame=function(){this.loop&&0===this.currentFrame?this.currentFrame=this.frameCount-1:this.currentFrame-=1,this.emit(t.PlayerEvent.FramePrev)},e.prototype.lastFrame=function(){this.currentFrame=this.frameCount-1,this.emit(t.PlayerEvent.FrameLast)},e.prototype.firstFrame=function(){this.currentFrame=0,this.emit(t.PlayerEvent.FrameFirst)},e.prototype.thumbnailFrame=function(){this.currentFrame=this.note.thumbFrameIndex},e.prototype.startSeek=function(){this.isSeeking||(this.emit(t.PlayerEvent.SeekStart),this.wasPlaying=this.isPlaying,this.pause(),this.isSeeking=!0)},e.prototype.seek=function(t){this.isSeeking&&(this.progress=100*t)},e.prototype.endSeek=function(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1},e.prototype.drawFrame=function(t){this.renderer.drawFrame(t)},e.prototype.forceUpdate=function(){this.renderer.forceUpdate()},e.prototype.resize=function(t,e){e!==.75*t&&console.warn("Canvas width to height ratio should be 3:4 for best results (got "+t+"x"+e+")"),this.renderer.setCanvasSize(t,e),this.forceUpdate()},e.prototype.setLayerVisibility=function(t,e){this.note.layerVisibility[t]=e,this.layerVisibility[t]=e,this.forceUpdate()},e.prototype.getLayerVisibility=function(t){return this.layerVisibility[t]},e.prototype.toggleLayerVisibility=function(t){this.setLayerVisibility(t,!this.layerVisibility[t])},e.prototype.playAudio=function(){this.audio.playFrom(this.currentTime)},e.prototype.stopAudio=function(){this.audio.stop()},e.prototype.toggleAudioEq=function(){this.setAudioEq(!this.audio.useEq)},e.prototype.setAudioEq=function(t){this.isPlaying&&(this.wasPlaying=!0,this.stopAudio()),this.audio.useEq=t,this.wasPlaying&&(this.wasPlaying=!1,this.playAudio())},e.prototype.mute=function(){this.setMuted(!0)},e.prototype.unmute=function(){this.setMuted(!1)},e.prototype.setMuted=function(e){this.audio.volume=e?0:this._volume,this._muted=e,this.emit(t.PlayerEvent.VolumeChange,this.audio.volume)},e.prototype.getMuted=function(){return 0===this.volume||this._muted},e.prototype.toggleMuted=function(){this.setMuted(!this._muted)},e.prototype.setVolume=function(e){b(e,0,1,"volume"),this._volume=e,this.audio.volume=e,this.emit(t.PlayerEvent.VolumeChange,this.audio.volume)},e.prototype.getVolume=function(){return this._muted?0:this._volume},e.prototype.seekToNextFrame=function(){this.nextFrame()},e.prototype.fastSeek=function(t){this.currentTime=t},e.prototype.canPlayType=function(t){switch(t){case"application/x-ppm":case"application/x-kwz":case"video/x-ppm":case"video/x-kwz":case"video/vnd.nintendo.ugomemo.ppm":case"video/vnd.nintendo.ugomemo.kwz":return"probably";case"application/octet-stream":return"maybe";case"video/vnd.nintendo.ugomemo.fykt":default:return""}},e.prototype.getVideoPlaybackQuality=function(){return{creationTime:0,droppedVideoFrames:0,totalVideoFrames:this.frameCount}},e.prototype.requestPictureInPicture=function(){throw new Error("Not implemented")},e.prototype.captureStream=function(){throw new Error("Not implemented")},e.prototype.on=function(t,e){var r=this.events;(Array.isArray(t)?t:[t]).forEach((function(t){r.has(t)?r.get(t).push(e):r.set(t,[e])}))},e.prototype.off=function(t,e){var r=this.events;(Array.isArray(t)?t:[t]).forEach((function(t){if(r.has(t)){var i=r.get(t);r.set(t,i.splice(i.indexOf(e),1))}}))},e.prototype.emit=function(e){for(var r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];var n=this.events;if(e!==t.PlayerEvent.__Any&&n.has(e)){n.get(e).forEach((function(t){return t.apply(null,r)}));var o="on"+e,a=this;"function"==typeof a[o]&&a[o].apply(null,r)}n.has(t.PlayerEvent.__Any)&&n.get(t.PlayerEvent.__Any).forEach((function(t){return t.apply(null,s([e],r))}))},e.prototype.clearEvents=function(){this.events.clear()},e.prototype.destroy=function(){return n(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return this.clearEvents(),this.emit(t.PlayerEvent.Destroy),this.closeNote(),[4,this.renderer.destroy()];case 1:return e.sent(),[4,this.audio.destroy()];case 2:return e.sent(),[2]}}))}))},e.prototype.supports=function(t){var e=this.supportedEvents.includes(t),r="function"==typeof this[t];return e||r},e.prototype.assertNoteLoaded=function(){v(this.isNoteLoaded,"No Flipnote is currently loaded in this player")},e}();var se=function(){function t(){this.dataUrl=null}return t.prototype.getBuffer=function(){return A(),Buffer.from(this.getArrayBuffer())},t.prototype.getBlob=function(){return S(),new Blob([this.getArrayBuffer()],{type:this.mimeType})},t.prototype.getUrl=function(){return S(),this.dataUrl?this.dataUrl:window.URL.createObjectURL(this.getBlob())},t.prototype.revokeUrl=function(){S(),this.dataUrl&&window.URL.revokeObjectURL(this.dataUrl)},t}(),ue=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],he=function(){function t(t,e,r){this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=e,this.colorDepth=r,this.reset()}return t.prototype.reset=function(){this.initCodeSize=Math.max(2,this.colorDepth),this.accum.fill(0),this.htab.fill(0),this.codetab.fill(0),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0},t.prototype.char_out=function(t,e){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(e)},t.prototype.cl_block=function(t){this.cl_hash(5003),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)},t.prototype.cl_hash=function(t){for(var e=0;e<t;++e)this.htab[e]=-1},t.prototype.compress=function(t,e){var r,i,n,o,a,s;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,o=this.nextPixel(),s=0,r=5003;r<65536;r*=2)++s;s=8-s,this.cl_hash(5003),this.output(this.ClearCode,e);t:for(;-1!=(i=this.nextPixel());)if(r=(i<<12)+o,n=i<<s^o,this.htab[n]!==r){if(this.htab[n]>=0){a=5003-n,0===n&&(a=1);do{if((n-=a)<0&&(n+=5003),this.htab[n]===r){o=this.codetab[n];continue t}}while(this.htab[n]>=0)}this.output(o,e),o=i,this.free_ent<4096?(this.codetab[n]=this.free_ent++,this.htab[n]=r):this.cl_block(e)}else o=this.codetab[n];this.output(o,e),this.output(this.EOFCode,e)},t.prototype.encode=function(t,e){this.pixels=t,e.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,e),e.writeByte(0)},t.prototype.flush_char=function(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)},t.prototype.get_maxcode=function(t){return(1<<t)-1},t.prototype.nextPixel=function(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])},t.prototype.output=function(t,e){for(this.cur_accum&=ue[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(e)}},t}(),fe=function(t){function e(r,n,o){void 0===o&&(o={});var a=t.call(this)||this;return a.mimeType="gif/image",a.frameCount=0,a.width=r,a.height=n,a.data=new u,a.settings=i(i({},e.defaultSettings),o),a.compressor=new he(r,n,o.colorDepth),a}return r(e,t),e.fromFlipnote=function(t,r){var n;void 0===r&&(r={});var o=new e(t.imageWidth,t.imageHeight,i({delay:100/t.framerate,repeat:(null===(n=t.meta)||void 0===n?void 0:n.loop)?-1:0},r));o.palette=t.globalPalette;for(var a=0;a<t.frameCount;a++)o.writeFrame(t.getFramePixels(a));return o.finish(),o},e.fromFlipnoteFrame=function(t,r,n){void 0===n&&(n={});var o=new e(t.imageWidth,t.imageHeight,i({delay:0,repeat:0},n));return o.palette=t.globalPalette,o.writeFrame(t.getFramePixels(r)),o.finish(),o},e.prototype.writeFrame=function(t){0===this.frameCount?this.writeFirstFrame(t):this.writeAdditionalFrame(t),this.frameCount+=1},e.prototype.finish=function(){this.data.writeByte(59)},e.prototype.writeFirstFrame=function(t){this.writeHeader(),this.writeLogicalScreenDescriptor(),this.writeColorTable(),this.writeNetscapeExt(),this.writeGraphicControlExt(),this.writeImageDescriptor(),this.writePixels(t)},e.prototype.writeAdditionalFrame=function(t){this.writeGraphicControlExt(),this.writeImageDescriptor(),this.writePixels(t)},e.prototype.writeHeader=function(){this.data.writeChars("GIF89a")},e.prototype.writeGraphicControlExt=function(){this.data.writeByte(33),this.data.writeByte(249),this.data.writeByte(4),this.data.writeByte(0),this.data.writeU16(this.settings.delay),this.data.writeByte(0),this.data.writeByte(0)},e.prototype.writeLogicalScreenDescriptor=function(){var t=this.palette,e=128|this.settings.colorDepth-1<<4|this.colorTableSize(t.length)-1;this.data.writeU16(this.width),this.data.writeU16(this.height),this.data.writeBytes([e,0,0])},e.prototype.writeNetscapeExt=function(){this.data.writeByte(33),this.data.writeByte(255),this.data.writeByte(11),this.data.writeChars("NETSCAPE2.0"),this.data.writeByte(3),this.data.writeByte(1),this.data.writeU16(this.settings.repeat),this.data.writeByte(0)},e.prototype.writeColorTable=function(){for(var t=this.palette,e=1<<this.colorTableSize(t.length),r=0;r<e;r++){var i=[0,0,0];r<t.length&&(i=t[r]),this.data.writeByte(i[0]),this.data.writeByte(i[1]),this.data.writeByte(i[2])}},e.prototype.writeImageDescriptor=function(){this.data.writeByte(44),this.data.writeU16(0),this.data.writeU16(0),this.data.writeU16(this.width),this.data.writeU16(this.height),this.data.writeByte(0)},e.prototype.colorTableSize=function(t){return Math.max(Math.ceil(Math.log2(t)),1)},e.prototype.writePixels=function(t){this.compressor.colorDepth=this.settings.colorDepth,this.compressor.reset(),this.compressor.encode(t,this.data)},e.prototype.getArrayBuffer=function(){return this.data.getBuffer()},e.prototype.getImage=function(){S();var t=new Image(this.width,this.height);return t.src=this.getUrl(),t},e.defaultSettings={delay:100,repeat:-1,colorDepth:8},e}(se),ce=function(t){function e(e,r,i){void 0===r&&(r=1),void 0===i&&(i=16);var n=t.call(this)||this;n.sampleRate=e,n.channels=r,n.bitsPerSample=i;var o=new ArrayBuffer(44),a=new h(o);return a.writeChars("RIFF"),a.writeUint32(0),a.writeChars("WAVE"),a.writeChars("fmt "),a.writeUint32(16),a.writeUint16(1),a.writeUint16(n.channels),a.writeUint32(n.sampleRate),a.writeUint32(n.sampleRate*n.bitsPerSample*n.channels/8),a.writeUint16(n.bitsPerSample*n.channels/8),a.writeUint16(n.bitsPerSample),a.writeChars("data"),a.writeUint32(0),n.header=a,n.pcmData=null,n}return r(e,t),e.fromFlipnote=function(t){var r=t.sampleRate,i=new e(r,1,16),n=t.getAudioMasterPcm(r);return i.writeSamples(n),i},e.fromFlipnoteTrack=function(t,r){var i=t.sampleRate,n=new e(i,1,16),o=t.getAudioTrackPcm(r,i);return n.writeSamples(o),n},e.prototype.writeSamples=function(t){var e=this.header;e.seek(4),e.writeUint32(e.byteLength+t.byteLength),e.seek(40),e.writeUint32(t.byteLength),this.pcmData=t},e.prototype.getArrayBuffer=function(){var t=this.header.bytes,e=new Uint8Array(this.pcmData.buffer),r=new Uint8Array(this.header.byteLength+this.pcmData.byteLength);return r.set(t),r.set(e,t.byteLength),r.buffer},e}(se);t.CanvasInterface=Ft,t.GifImage=fe,t.Html5Canvas=re,t.KwzParser=pt,t.Player=ae,t.PlayerMixin=function(t){var e,n,o=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),Object.defineProperty(e.prototype,"renderer",{get:function(){return this.player.renderer},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"audio",{get:function(){return this.player.audio},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"canvasEl",{get:function(){return this.player.canvasEl},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"note",{get:function(){return this.player.note},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"noteFormat",{get:function(){return this.player.noteFormat},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"meta",{get:function(){return this.player.meta},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"duration",{get:function(){return this.player.duration},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"layerVisibility",{get:function(){return this.player.layerVisibility},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"autoplay",{get:function(){return this.player.autoplay},set:function(t){this.player.autoplay=t},enumerable:!1,configurable:!0}),e}(t),a=function(e){var r=Object.getOwnPropertyDescriptor(ae.prototype,e);if(e in t.prototype||"constructor"===e||"name"===e||"prototype"===e)return"continue";r.value&&"function"==typeof r.value?Object.defineProperty(o.prototype,e,i(i({},r),{value:function(){for(var t,r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];return(t=this.player)[e].apply(t,s(r))}})):(r.get||r.set)&&Object.defineProperty(o.prototype,e,i(i({},r),{set:function(t){this.player[e]=t},get:function(){return this.player[e]}}))};try{for(var u=function(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],i=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}(Reflect.ownKeys(ae.prototype)),h=u.next();!h.done;h=u.next()){a(h.value)}}catch(t){e={error:t}}finally{try{h&&!h.done&&(n=u.return)&&n.call(u)}finally{if(e)throw e.error}}return o},t.PpmParser=X,t.UniversalCanvas=ie,t.WavAudio=ce,t.WebAudioPlayer=oe,t.WebglCanvas=ee,t.parseSource=mt,t.utils=j,t.version="5.6.7",Object.defineProperty(t,"__esModule",{value:!0})}));
